<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-how-tos/ci-guidelines" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">CI Guidelines | Firefox Ecosystem Platform</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://mozilla.github.io/ecosystem-platform/how-tos/ci-guidelines"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="CI Guidelines | Firefox Ecosystem Platform"><meta data-rh="true" name="description" content="Our CI process is largely automatic. By simply pushing up a branch and opening a PR the CI system will kick in and start validating your changes. By landing a PR on the main branch, the system will also build and deploy docker images that keep the current state of the FxA fresh."><meta data-rh="true" property="og:description" content="Our CI process is largely automatic. By simply pushing up a branch and opening a PR the CI system will kick in and start validating your changes. By landing a PR on the main branch, the system will also build and deploy docker images that keep the current state of the FxA fresh."><link data-rh="true" rel="icon" href="/ecosystem-platform/img/firefox-logo.png"><link data-rh="true" rel="canonical" href="https://mozilla.github.io/ecosystem-platform/how-tos/ci-guidelines"><link data-rh="true" rel="alternate" href="https://mozilla.github.io/ecosystem-platform/how-tos/ci-guidelines" hreflang="en"><link data-rh="true" rel="alternate" href="https://mozilla.github.io/ecosystem-platform/how-tos/ci-guidelines" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://RFM5H13DFK-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Firefox Ecosystem Platform" href="/ecosystem-platform/opensearch.xml"><link rel="stylesheet" href="/ecosystem-platform/assets/css/styles.90d727cc.css">
<script src="/ecosystem-platform/assets/js/runtime~main.337a253d.js" defer="defer"></script>
<script src="/ecosystem-platform/assets/js/main.ca1f48d4.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/ecosystem-platform/"><div class="navbar__logo"><img src="/ecosystem-platform/img/firefox-logo.png" alt="Ecosystem Platform Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/ecosystem-platform/img/firefox-logo.png" alt="Ecosystem Platform Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Firefox Ecosystem Platform</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/mozilla/ecosystem-platform" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ecosystem-platform/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">For Relying Parties</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/relying-parties/tutorials/integration-with-fxa">Tutorials</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/relying-parties/how-tos/end-to-end-encryption">How-to Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/relying-parties/reference/integration-requirements">Reference</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active">For FxA Engineers</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/tutorials/development-setup">Tutorials</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/ecosystem-platform/how-tos/ci-guidelines">How-to Guides</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/ecosystem-platform/how-tos/ci-guidelines">CI Guidelines</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/how-tos/connecting-to-a-local-mysql-db">Connecting to a local MySQL DB</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/how-tos/creating-an-account-locally">Creating an Account Locally</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/how-tos/local-emails-with-maildev">Local Emails with MailDev</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/how-tos/managing-yarn-dependencies">Managing Yarn Dependencies</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/how-tos/node-debugging">Node Debugging</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/how-tos/using-a-custom-profile-with-firefox">Using a Custom Profile with Firefox</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/how-tos/using-sentry-locally">Using Sentry.io for Local Development</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/how-tos/using-swagger-for-api-documentation">Using Swagger for API documentation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/how-tos/using-tracing-in-gcp">Tracing for Stage/Prod</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/how-tos/using-tracing-locally">Tracing for Local Development</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/how-tos/using-vscode-with-fxa">Using VS Code with FxA</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/how-tos/working-with-metrics">Working with Metrics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/how-tos/rotating-secrets">Rotating Secrets</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/reference/team-processes/development-process">Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/explanation/architectural-decision-records">Explanation</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/additional-docs">Additional Docs</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">For Support Agents</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/reference/admin-panel">Reference</a></div></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/ecosystem-platform/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">For FxA Engineers</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">How-to Guides</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">CI Guidelines</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>CI Guidelines</h1></header><p>Our CI process is largely automatic. By simply pushing up a branch and opening a PR the CI system will kick in and start validating your changes. By landing a PR on the main branch, the system will also build and deploy docker images that keep the current state of the FxA fresh.</p>
<p>Even though this is all seamless, there are a few best practices to keep in mind. Following these will help pipelines run faster in the future and with fewer errors. Also, if unfamiliar with CI concepts, we have some more info <a href="/ecosystem-platform/reference/tests-in-circleci#workflows">here</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="rebase-off-main-before-pushing-code">Rebase Off Main Before Pushing Code<a href="#rebase-off-main-before-pushing-code" class="hash-link" aria-label="Direct link to Rebase Off Main Before Pushing Code" title="Direct link to Rebase Off Main Before Pushing Code">​</a></h2>
<p>This might just be the most important tip! Always try to rebase your code on main before pushing up a PR. This ensures a couple things. First it decreases the possibility of merge conflict or a ‘bad’ merge state occurring when the PR finally lands. Second, it ensures that your branch and the docker images we use to run our CI pipelines will be similar, and therefore have low start up time.</p>
<p>If there are no changes to npm packages in your PR and it has been rebased off main, we can skip the yarn install step in the CI, which leads to much faster execution times. If your branch meets these criteria, you’ll see a message saying something like ‘Congrats! No changes detected on yarn.lock’ in the base install step.</p>
<p>It’s possible that at some point in the future we will enforce that PRs have been rebased off of main. But for the time being this is the honors system.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="be-mindful-when-adding-or-updating-packages">Be mindful when adding or updating packages<a href="#be-mindful-when-adding-or-updating-packages" class="hash-link" aria-label="Direct link to Be mindful when adding or updating packages" title="Direct link to Be mindful when adding or updating packages">​</a></h2>
<p>As discussed in the <a href="/ecosystem-platform/reference/continuous-integration-for-monorepos">Continuous Integration</a> Reference. One of the challenges faced in mono repos is large sets dependencies. There are a few things we can do going forward to help ensure this doesn’t get worse:</p>
<ul>
<li>Before adding a new package, make sure it’s really needed. Ideally we consolidate / gravitate towards a fixed set of high level frameworks.</li>
<li>Try to have a one in one out policy. If a new package is added, look to phase out an old package.</li>
<li>If updating a package, try to update across all workspaces, so we don’t have different versions. This is much easier said than done; however, and oftentimes it’s not possible. Running <code>yarn dedupe -c $package_name</code> can give an idea of the extent of the problem.</li>
<li>Be mindful of upstream dependencies. Run <code>yarn why</code> to see the dependency tree for any package.</li>
</ul>
<p>Also be aware that making changes to packages means a yarn install will be needed in each CI job to ensure the packages are up to date. It will also likely trigger a full rerun of all test suites. This adds unavoidable overhead to your CI pipeline. It isn’t all that big a deal, but it is something to be avoided when possible.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="helpful-yarnrcyml-configurations">Helpful yarnrc.yml configurations<a href="#helpful-yarnrcyml-configurations" class="hash-link" aria-label="Direct link to Helpful yarnrc.yml configurations" title="Direct link to Helpful yarnrc.yml configurations">​</a></h2>
<p>There are two settings that result in a pretty drastic reduction in the size of the yarn cache needed to run FxA.</p>
<p>First, <code>nmMode: hardlinks-global</code> reduces the size of the internal yarn cache for FxA by about a third. This essentially uses hard links to reduce the amount of redundant packages held in the node_modules folder.  When enabled, if two modules both reference the same package, yarn will hardlink the package instead of copying it into both modules folders which can end up saving a lot of space on disk.</p>
<p>Second, <code>enableGlobalCache: true</code>, reduces the size of the internal yarn cache by 1/2 in the CI. When this is not enabled, all the packages will get stored as zips in the global cache located in the ~/.yarn/berry, as well as the project local cache located in fxa/.yarn/berry. This redundancy really isn’t helpful in most scenarios, and particularly unhelpful in the CI as it results in bloat.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="tag-tests-as-unit-or-integration-tests">Tag tests as unit or integration tests<a href="#tag-tests-as-unit-or-integration-tests" class="hash-link" aria-label="Direct link to Tag tests as unit or integration tests" title="Direct link to Tag tests as unit or integration tests">​</a></h2>
<p>In order to provide better performance, and to fail bad PRs more quickly, break our tests up into unit tests and integration tests and run these tests in separate CI jobs.</p>
<p>In our system unit tests are tests that can:</p>
<ul>
<li>Run quickly, typically under 100ms, and definitely under 500ms.</li>
<li>Run without any infrastructure, i.e. tests can run without any pm2 services running.</li>
</ul>
<p>Integration tests are tests that:</p>
<ul>
<li>Take longer to run, typically over 500ms.</li>
<li>Run with just infrastructure, i.e. we must execute a <code>yarn start infrastructure</code> prior to running tests)</li>
</ul>
<p>In order to distinguish between these kinds of tests, we have created a tagging convention. Our tests names need to be tagged with either #unit or #integration. These tags can exist at the test level (i.e. the ‘it’ block) or at the suite level (i.e. the ‘describe’ block).</p>
<p>In the future we may have better conventions for this such as file names or even folders, but for now, this was the least disruptive way to separate the two types of tests without disrupting the git history too much.</p>
<p>Important: For jest tests we need to be explicit and add the #unit and #integration tag to each top level &#x27;describe’ block. This is due to the fact that jest does not support an [‘invert’ option<a href="https://mochajs.org/api/mocha#invert" target="_blank" rel="noopener noreferrer"></a> like mocha does, so we have not way run all tests except those with #integration. Therefore we must explicitly tag all tests.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prioritize-lightweight-tests">Prioritize lightweight tests<a href="#prioritize-lightweight-tests" class="hash-link" aria-label="Direct link to Prioritize lightweight tests" title="Direct link to Prioritize lightweight tests">​</a></h2>
<p>Ideally we have a <a href="https://martinfowler.com/articles/practical-test-pyramid.html" target="_blank" rel="noopener noreferrer">pyramid</a> distribution of test types.</p>
<ul>
<li>Unit tests, which are the fastest and quickest to run, should be the bulk of the tests. And run first.</li>
<li>Integration tests, which only require some infrastructure like databases or caches to be present or are inherently long running tests, should be run next.</li>
<li>Backend services should be run last. They require a full stack as well as a headless browser to be running which adds significant overhead to the test suite.</li>
<li>Finally manual black box testing that involves a human being should be conducted prior to release..</li>
</ul>
<p>These tests increase almost exponentially in cost, and therefore we should be mindful of their distribution in our system.</p>
<p>Unit and integration tests also have the ability to report coverage metrics, so we can actually see how many lines and logical branches we have covered in these test suites. Ideally we have about 80% or better code coverage for unit / integration tests.</p>
<p>There are always things that will be difficult to test purely with a unit or integration test, so keep that in mind as well. Functional tests, and manual testing will always be useful and are still necessary.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>If a scenario is encountered where a functional test fails, but there were not any unit or integration tests that also failed, this might be a good opportunity to go back and improve unit or integration test coverage.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="keep-npm-scripts-consistent">Keep NPM Scripts Consistent<a href="#keep-npm-scripts-consistent" class="hash-link" aria-label="Direct link to Keep NPM Scripts Consistent" title="Direct link to Keep NPM Scripts Consistent">​</a></h2>
<p>If an operation is general enough to be targeted in the CI, then put it in an npm script and make sure the npm script name is consistent across packages. The reason this is useful is that we can then target these scripts with <code>yarn workspaces foreach run $script_name</code> commands.</p>
<p>This is a very convenient way to execute various operations across packages in the mono repo. If scripts aren’t consistently named, then things get quite messy. Currently there are a few scripts we rely on heavily in the CI</p>
<ul>
<li><code>yarn workspaces foreach run compile</code>- Should compile typescript</li>
<li><code>yarn workspaces foreach run test-unit</code> - Runs unit tests</li>
<li><code>yarn workspaces foreach run test-integration</code> - Runs integration tests</li>
<li><code>yarn workspaces foreach run postinstall</code> - Should prime the repo after running yarn install. We generally use this for pulling down and priming l10n content.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="export-tests-reports">Export Tests Reports<a href="#export-tests-reports" class="hash-link" aria-label="Direct link to Export Tests Reports" title="Direct link to Export Tests Reports">​</a></h2>
<p>We have a lot of tests. No one really wants to dig through command line output to figure out what failed. So whenever possible, we will generate and export test reports. This  is especially important for unit and integration tests where many workspace packages are being tested in a single job. By exporting test reports, the errors will show up nicely formatted in the UI. For example:</p>
<p><img loading="lazy" alt="test report" src="/ecosystem-platform/assets/images/test-report-a96b06cd789079fb8e1842c5a0956c23.png" title="image_tooltip" width="823" height="763" class="img_ev3q"></p>
<p>Test reports are fairly easy to export. Most testing frameworks will export a json format, typically in the junit reporter format, which can be interpreted by CircleCI. Any test report that ultimately ends up in the artifacts/tests will be accessible in the tests tab in circle ci as depicted above.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="review-the-ci-workflows">Review the CI Workflows<a href="#review-the-ci-workflows" class="hash-link" aria-label="Direct link to Review the CI Workflows" title="Direct link to Review the CI Workflows">​</a></h2>
<p>The CI workflows in FxA have been crafted to address some of the side effects that mono repos can have on CI. Checkout the <a href="/ecosystem-platform/reference/tests-in-circleci">Continuous Integration</a> reference to learn more about how our CI design attempts to address some of these issues.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="updating-ci-runner-images">Updating CI Runner Images<a href="#updating-ci-runner-images" class="hash-link" aria-label="Direct link to Updating CI Runner Images" title="Direct link to Updating CI Runner Images">​</a></h2>
<p>The day will come when it might be necessary to update the base images we use in our CI runners. A good example is upgrading a major version of node. When this happens we must update images to reference <code>cimg/node:$VER</code> and <code>node:$VER</code>.</p>
<p>Because CI images are built as changes land on main, it may seem as though there is a chicken egg problem. In order to produce new CI images we must land the changes we need on main, but in order to land changes on main we must test them in branch using our CI runner images. This can definitely be a quandary, but here’s how to deal with it:</p>
<ul>
<li>In <code>.circleci/config.yml</code>, look for <code>commands &gt; build-ci-image &gt; steps &gt; run &gt; command</code> and version the docker tag. For example, you would change <code>-t mozilla/fxa-circleci:ci-&lt;&lt; parameters.target &gt;&gt;-v1</code> to <code>-t mozilla/fxa-circleci:ci-&lt;&lt; parameters.target &gt;&gt;-v2</code>.</li>
<li>In <code>.circleci/config.yml</code>, update all references to use the new image tags. For example change all occurences of<!-- -->
<ul>
<li><code>fxa-circleci:ci-builder-v1</code> to <code>fxa-circleci:ci-builder-v2</code></li>
<li><code>fxa-circleci:ci-test-runner-v1</code> to <code>fxa-circleci:ci-test-runner-v2</code></li>
<li><code>fxa-circleci:ci-functional-test-runner-v1</code> to <code>fxa-circleci:ci-functional-test-runner-v2</code>.</li>
</ul>
</li>
<li>In <code>.circleci/config.yml</code>, go to <code>workflows &gt; deploy_ci_images &gt; jobs &gt; filters &gt; branches</code> and add the name of the branch being worked on to the list.</li>
<li>Open the <code>_dev/docker/ci/Dockerfile</code> and change <code>cimg/node:16.3</code> to whatever <code>cimg/node:$version</code> needs to be targeted.</li>
<li>Push changes.</li>
</ul>
<p>This will end up triggering a new build. The tests will fail the first time. In fact you may as well cancel the <code>test_pull_request</code> workflow. The <code>deploy_ci_images</code> workflow will run (due to change in step 4) and push up the new image tags to docker hub that our CI runners use. On a rerun, or subsequent push, the image with node 18 should now be in place, and they will pass. And of course, it won’t break everyone else’s pipelines cause it’ll be using a different tag, and their configs still reference the original images.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>If the deploy_ci_images job runs very quickly, something is off. It&#x27;s possible the build was skipped, so check the output for the job. If the build was skipped, (perahaps the script didn&#x27;t find any changes the require a new build), then you can &#x27;force&#x27; the docker CI images to rebuild by going to &#x27;trigger pipeline&#x27; select &#x27;Add parameters&#x27; and then add <code>boolean</code> | <code>force-deploy-fxa-ci-images</code> | <code>true</code>.</p></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/mozilla/ecosystem-platform/edit/master/docs/how-tos/ci-guidelines.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/ecosystem-platform/tutorials/subscription-platform"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Subscription Platform</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/ecosystem-platform/how-tos/connecting-to-a-local-mysql-db"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Connecting to a local MySQL DB</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#rebase-off-main-before-pushing-code" class="table-of-contents__link toc-highlight">Rebase Off Main Before Pushing Code</a></li><li><a href="#be-mindful-when-adding-or-updating-packages" class="table-of-contents__link toc-highlight">Be mindful when adding or updating packages</a></li><li><a href="#helpful-yarnrcyml-configurations" class="table-of-contents__link toc-highlight">Helpful yarnrc.yml configurations</a></li><li><a href="#tag-tests-as-unit-or-integration-tests" class="table-of-contents__link toc-highlight">Tag tests as unit or integration tests</a></li><li><a href="#prioritize-lightweight-tests" class="table-of-contents__link toc-highlight">Prioritize lightweight tests</a></li><li><a href="#keep-npm-scripts-consistent" class="table-of-contents__link toc-highlight">Keep NPM Scripts Consistent</a></li><li><a href="#export-tests-reports" class="table-of-contents__link toc-highlight">Export Tests Reports</a></li><li><a href="#review-the-ci-workflows" class="table-of-contents__link toc-highlight">Review the CI Workflows</a></li><li><a href="#updating-ci-runner-images" class="table-of-contents__link toc-highlight">Updating CI Runner Images</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Mozilla Corporation.</div></div></div></footer></div>
</body>
</html>