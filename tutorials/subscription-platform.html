<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-tutorials/subscription-platform" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">Subscription Platform | Firefox Ecosystem Platform</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://mozilla.github.io/ecosystem-platform/tutorials/subscription-platform"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Subscription Platform | Firefox Ecosystem Platform"><meta data-rh="true" name="description" content="Getting Started"><meta data-rh="true" property="og:description" content="Getting Started"><link data-rh="true" rel="icon" href="/ecosystem-platform/img/firefox-logo.png"><link data-rh="true" rel="canonical" href="https://mozilla.github.io/ecosystem-platform/tutorials/subscription-platform"><link data-rh="true" rel="alternate" href="https://mozilla.github.io/ecosystem-platform/tutorials/subscription-platform" hreflang="en"><link data-rh="true" rel="alternate" href="https://mozilla.github.io/ecosystem-platform/tutorials/subscription-platform" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://RFM5H13DFK-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Firefox Ecosystem Platform" href="/ecosystem-platform/opensearch.xml"><link rel="stylesheet" href="/ecosystem-platform/assets/css/styles.ebd70f73.css">
<script src="/ecosystem-platform/assets/js/runtime~main.e52c8151.js" defer="defer"></script>
<script src="/ecosystem-platform/assets/js/main.bf574aca.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/ecosystem-platform/"><div class="navbar__logo"><img src="/ecosystem-platform/img/firefox-logo.png" alt="Ecosystem Platform Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/ecosystem-platform/img/firefox-logo.png" alt="Ecosystem Platform Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Firefox Ecosystem Platform</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/mozilla/ecosystem-platform" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ecosystem-platform/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">For Relying Parties</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/ecosystem-platform/relying-parties/tutorials/integration-with-fxa">Tutorials</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/ecosystem-platform/relying-parties/how-tos/end-to-end-encryption">How-to Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/ecosystem-platform/relying-parties/reference/integration-requirements">Reference</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active">For FxA Engineers</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/ecosystem-platform/tutorials/development-setup">Tutorials</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/tutorials/development-setup">Development Setup</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/ecosystem-platform/tutorials/subscription-platform">Subscription Platform</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/ecosystem-platform/how-tos/ci-guidelines">How-to Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/ecosystem-platform/reference/team-processes/development-process">Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/ecosystem-platform/explanation/architectural-decision-records">Explanation</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/additional-docs">Additional Docs</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">For Support Agents</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/ecosystem-platform/reference/admin-panel">Reference</a></div></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/ecosystem-platform/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">For FxA Engineers</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Tutorials</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Subscription Platform</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Subscription Platform</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="getting-started">Getting Started<a href="#getting-started" class="hash-link" aria-label="Direct link to Getting Started" title="Direct link to Getting Started">​</a></h2>
<p>Current as of <code>Jan 24, 2022</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="pre-development">Pre-Development<a href="#pre-development" class="hash-link" aria-label="Direct link to Pre-Development" title="Direct link to Pre-Development">​</a></h3>
<p>To begin working on the subscription platform in the FxA codebase, you will need access to a Stripe account for private and public API developer keys.</p>
<p>If you&#x27;re a Mozilla employee, you can request access to the Stripe dev (and/or stage) account, created for the FxA Subscription Platform team to easily connect with fake products and plans. Otherwise, you can create your own Stripe account to use for testing that is not linked to any bank account information with your own products and plans. These keys should be taken from Stripe&#x27;s test environment which you can verify by checking that the key includes the word <code>test</code>.</p>
<p>The <code>fxa-payments-server</code> needs the Stripe public key (<code>pk</code>) and communicates with the <code>fxa-auth-server</code> that requires a Stripe private or secret key (<code>sk</code>).¹ These can be found in the Stripe Dashboard, and configuration details can be found below.</p>
<p>¹ We have, in the past, given out restricted keys for use (<code>rk</code>). We may choose to do this again in the future or even use them in our dev environment.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configuration">Configuration<a href="#configuration" class="hash-link" aria-label="Direct link to Configuration" title="Direct link to Configuration">​</a></h3>
<p>You will need to create the file <code>fxa/packages/fxa-auth-server/config/secrets.json</code> and specify <code>subscriptions.stripeApiKey</code> with the value of your private Stripe API key. Ensure the key begins with <code>sk_test</code> to guarantee you are using the secret key and testing in the correct environment.</p>
<p>Ex:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;subscriptions&quot;: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;stripeApiKey&quot;: &quot;sk_test_####&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Additionally create the file <code>fxa/packages/fxa-payments-server/server/config/secrets.json</code> and specify <code>stripe.apiKey</code> to override the default Mozilla Stripe public API key with your own public key:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;stripe&quot;: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;apiKey&quot;: &quot;pk_test_####&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Note that neither <code>secrets.json</code> files are tracked in Git, and they take precedence over each server&#x27;s default configurations, should you need to make any additional local-only modifications.</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="stripe-productplans">Stripe Product/Plans<a href="#stripe-productplans" class="hash-link" aria-label="Direct link to Stripe Product/Plans" title="Direct link to Stripe Product/Plans">​</a></h4>
<p>To see the available products or create a new one in the Stripe dashboard, navigate to Billing &gt; Products and click into one of the products to see information including the product name, product ID, plan name, plan ID, metadata, logs, and events.</p>
<p>If you are using a new Stripe account, you will need to setup a product and its plan. The product should have additional metadata configured as needed.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Product Names are the canonical displayed name shown in Sub Plat UI. In some cases these may be paired with a plan&#x27;s billing interval. Plan names are not displayed to users.</p></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="stripe-product-metadata">Product Metadata<a href="#stripe-product-metadata" class="hash-link" aria-label="Direct link to Product Metadata" title="Direct link to Product Metadata">​</a></h5>
<table><thead><tr><th>Key</th><th>Description</th></tr></thead><tbody><tr><td><del>downloadURL</del></td><td>Deprecated. This field has been replaced by successActionButtonURL.</td></tr><tr><td>product<!-- -->:privacyNoticeURL</td><td>Required. The URL for the webpage containing the Privacy Notice for the product offering.</td></tr><tr><td>product<!-- -->:termsOfServiceURL</td><td>Required. The URL for the webpage containing the Terms of Service for the product offering.</td></tr><tr><td>product<!-- -->:termsOfServiceDownloadURL</td><td>Required. The URL for a downloadable version of the Terms of Service for the product offering, used in emails. This must be a URL to the FxA CDN at <code>https://accounts-static.cdn.mozilla.net</code>. It can be either a) full, direct URL to a PDF (e.g. <code>https://accounts-static.cdn.mozilla.net/legal/Mozilla_VPN_ToS/en-US.pdf</code>), or, b) a URL without the language and file extension (e.g. <code>https://accounts-static.cdn.mozilla.net/legal/mozilla_vpn_tos</code>). See the <a href="#legal-document-download-url">&quot;Legal Document Download URL&quot;</a> section for more information.</td></tr><tr><td>webIconURL</td><td>Required. Image URL for product icon in web content. This must be a URL to the FxA CDN at <code>https://accounts-static.cdn.mozilla.net</code>. Product icon will be resized to 64x64 pixels.</td></tr><tr><td>webIconBackground</td><td>Optional. A valid css color, color name or gradient for display behind your product icon on the web. Defaults to <code>#20123a</code></td></tr><tr><td>product<!-- -->:name</td><td>Optional. Title string override for the product name.</td></tr><tr><td>product:name:{locale}</td><td>Optional. Localized title string override for the product name.</td></tr><tr><td>capabilities</td><td>Required if <code>capabilities:{clientID}</code> is not provided. Comma-separated list of capabilities enabled by this product for all Relying Parties.</td></tr><tr><td>capabilities:{clientID}</td><td>Required if <code>capabilities</code> is not provided. Comma-separated list of capabilities enabled by this product for the Relying Party identified by {clientID}.</td></tr><tr><td>emailIconURL</td><td>Optional. Image URL for product icon in email content. This must be a URL to the FxA CDN at <code>https://accounts-static.cdn.mozilla.net</code>.</td></tr><tr><td>appStoreLink</td><td>Optional. The App store download URL for the product.</td></tr><tr><td>playStoreLink</td><td>Optional. The google play store download URL for the product.</td></tr><tr><td>newsletterSlug</td><td>Optional. Comma separated string array of slugs to send if a customer opts to signup for the newsletter. Valid values are <code>mozilla-accounts</code>, <code>security-privacy-news</code>, <code>hubs</code>, <code>mdnplus</code>, which can be combined into a comma separated string. Defaults to <code>mozilla-accounts</code>.</td></tr><tr><td>newsletterLabelTextCode</td><td>Optional. A code used to determine which of the predefined labels to add to the newsletter checkbox. Valid values are <code>snp</code>, <code>hubs</code>, <code>mdnplus</code>. If no code is provided, the default label text is displayed. Examples of each string can be found on <a href="https://storage.googleapis.com/mozilla-storybooks-fxa/commits/latest/fxa-payments-server/index.html?path=/story/components-newuseremailform--default" target="_blank" rel="noopener noreferrer">Storybook here</a>.</td></tr><tr><td>productSet</td><td>Required. A comma-separated list of arbitrary strings used to group products in a set of upgrades &amp; downgrades. To prevent an IAP subscriber from double subscribing to your product on the web, ensure at least one <code>productSet</code> string matches between a configured IAP Stripe plan (i.e. a plan with <code>appStoreProductIds</code> or <code>playSkuIds</code>) and the other plans for your product.</td></tr><tr><td>productOrder</td><td>Optional. A number used for sorting products in a set.</td></tr><tr><td>product<!-- -->:cancellationSurveyURL</td><td>Optional. Override URL for the Cancellation Survey for the product offering. This parameter is used as a hyperlink in emails sent to the customer when their subscription is cancelled due, manual cancellation, FxA Account deletion, or failed payment.</td></tr><tr><td>product:details:{n}</td><td>Optional. Bullet-point feature details for the product, where {n} is a number or ordering the points.</td></tr><tr><td>product:details:{n}:{locale}</td><td>Optional. Localized string override for product:details:{n}, where {locale} is the locale (e.g. fr-FR, zh-CN, de, etc).</td></tr><tr><td>product:privacyNoticeURL:{locale}</td><td>Optional. Localized override URL for the webpage containing the Privacy Notice for the product offering.</td></tr><tr><td>product<!-- -->:privacyNoticeDownloadURL</td><td>Optional. The URL for a downloadable version of the Privacy Notice for the product offering. This has the same requirements as product<!-- -->:termsOfServiceDownloadURL<!-- -->.</td></tr><tr><td>product:termsOfServiceURL:{locale}</td><td>Optional. Localized override URL for the webpage containing the Terms of Service for the product offering.</td></tr><tr><td>product<!-- -->:subtitle</td><td>Optional. A subtitle for the product, usually displayed beneath the name in UI.</td></tr><tr><td>product:subtitle:{locale}</td><td>Optional. Localized string override for product<!-- -->:subtitle<!-- -->, where {locale} is the locale (e.g. fr-FR, zh-CN, de, etc).</td></tr><tr><td>product<!-- -->:successActionButtonLabel</td><td>Optional. An alternative label for the subscription success action button. The action is specified by <code>successActionButtonURL</code>.</td></tr><tr><td>product:successActionButtonLabel:{locale}</td><td>Optional. Localized override for the alternative label for the subscription success action button.</td></tr><tr><td>promotionCodes</td><td>Optional. A comma separated list of promotion codes that are valid for the product.</td></tr><tr><td>support:app:{x}</td><td>Optional. An app or service for the support form. The form options will be in the same order as the metadata. These values shouldn&#x27;t be too long as they are displayed in dropdown options of limited width. The <code>{x}</code> part of the key can be any string and will not be used anywhere; the value of the metadata is submitted to Zendesk.</td></tr><tr><td>successActionButtonURL</td><td>Required. The download or subscription success action URL for the product. (Replaces downloadURL)</td></tr><tr><td>upgradeCTA</td><td>Optional. HTML content string describing available upgrades from this plan. By convention, should include a link back to a product lead page. That lead page links back to FxA&#x27;s plan subscription pages.</td></tr></tbody></table>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="stripe-plan-metadata">Plan Metadata<a href="#stripe-plan-metadata" class="hash-link" aria-label="Direct link to Plan Metadata" title="Direct link to Plan Metadata">​</a></h5>
<table><thead><tr><th>Key</th><th>Description</th></tr></thead><tbody><tr><td>appStoreProductIds</td><td>Optional. <em>Plan metadata only.</em> Comma-separated list of Apple App Store <a href="https://developer.apple.com/documentation/appstoreserverapi/productid" target="_blank" rel="noopener noreferrer"><code>productIds</code></a> that map to this plan. There must only be one Stripe plan per App Store <code>productId</code> per environment (development/stage/production).</td></tr><tr><td>playSkuIds</td><td>Optional. <em>Plan metadata only.</em> Comma-separated list of <a href="https://developer.android.com/google/play/billing/terminology#concepts" target="_blank" rel="noopener noreferrer">Google Play product SKUs (now called product IDs)</a> that map to this plan. There must only be one Stripe plan per Google Play product SKU per environment (development/stage/production).</td></tr></tbody></table>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="product-configuration-documents">Product Configuration Documents<a href="#product-configuration-documents" class="hash-link" aria-label="Direct link to Product Configuration Documents" title="Direct link to Product Configuration Documents">​</a></h5>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>This section is for an upcoming feature that is not yet in production. Please
continue to use <a href="#stripe-product-metadata">Stripe product metadata</a> to
configure your subscription products.</p></div></div>
<p>While the <a href="https://stripe.com/docs/api/metadata" target="_blank" rel="noopener noreferrer">Stripe product and plan metadata</a> has enable the Subscription Platform to quickly develop many features, it has multiple shortcomings.</p>
<ul>
<li>There are limits on the number of entries and the size of the keys and
values. The limit for the number of entries is rather low.</li>
<li>The strings only key-value pair format necessitates potentially confusing key
formats and key parsing in code.</li>
<li>A reliance on Stripe metadata for subscription product configurations means
the Subscription Platform need to define plans in Stripe for subscription
plans that are not Stripe based (e.g. App Store subscriptions).</li>
</ul>
<p>The overcome these limits, the team is moving to <a href="https://www.json.org" target="_blank" rel="noopener noreferrer">JSON</a>
document based product configurations. For readability, the configuration is
described below in multiple sections. To see the overall format of the
configuration documents, take a look at the following sample documents:</p>
<ul>
<li><a href="/ecosystem-platform/assets/files/sample-product-config-doc-3bd7be0beb4b305e910138612823220c.json" target="_blank">Sample Product Configuration Document</a></li>
<li><a href="/ecosystem-platform/assets/files/sample-plan-config-doc-f0ee2fcf0e4c80ed4ec04c6d1a445b4e.json" target="_blank">Sample Plan Configuration Document</a></li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>A value in a plan configuration can be used to override the product configuration value. Another way to think of this is that the values in the product configuration are the defaults for the product&#x27;s plans.</p></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The Subscription Platform team is currently developing the process to update these configuration documents. Documentation for that is forthcoming.</p></div></div>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="top-level-configuration-document-values">Top Level Configuration Document Values<a href="#top-level-configuration-document-values" class="hash-link" aria-label="Direct link to Top Level Configuration Document Values" title="Direct link to Top Level Configuration Document Values">​</a></h6>
<p>The configuration document is a JSON object. The top level keys for that object are below. A property is required unless otherwise noted.</p>
<table><thead><tr><th>Key</th><th>Description</th></tr></thead><tbody><tr><td>id</td><td>Optional. An identifier for the system storing the document. It&#x27;s not intended for manual edits.</td></tr><tr><td>productConfigId</td><td><em>Plan configuration only</em>. The identifier of the product configuration document from which the plan configuration inherits its default values. It&#x27;s not intended for manual edits.</td></tr><tr><td>stripeProductId</td><td>Optional. <em>Product configuration only</em>. The <a href="https://stripe.com/docs/api/products/object#product_object-id" target="_blank" rel="noopener noreferrer">id of the Stripe product</a> for which this document is providing configuration.</td></tr><tr><td>stripePriceId</td><td>Optional. <em>Plan configuration only</em>. The <a href="https://stripe.com/docs/api/prices/object#price_object-id" target="_blank" rel="noopener noreferrer">id of the Stripe price</a> for which this document is providing configuration.</td></tr><tr><td>active</td><td>Boolean. A status to indicate whether the product or plan is accepting new subscriptions.</td></tr><tr><td>capabilities</td><td>Object. See <a href="#production-config-capabilities">Capabilities Configuration</a> below.</td></tr><tr><td>productSet</td><td>A comma-separated list of arbitrary strings used to group products in a set of upgrades &amp; downgrades. To prevent an IAP subscriber from double subscribing to your product on the web, ensure at least one string matches between a configured IAP Stripe plan (i.e. a plan with <code>appStoreProductIds</code> or <code>playSkuIds</code>) and the other plans for your product.</td></tr><tr><td>productOrder</td><td>Optional. <em>Plan configuration only</em>. A number used to determine a subscription change is an upgrade or a downgrade within the productSet.</td></tr><tr><td>appStoreProductIds</td><td>Optional. <em>Plan configuration only.</em> Comma-separated list of Apple App Store <a href="https://developer.apple.com/documentation/appstoreserverapi/productid" target="_blank" rel="noopener noreferrer"><code>productIds</code></a> that map to this plan.</td></tr><tr><td>playSkuIds</td><td>Optional. <em>Plan configuration only.</em> Comma-separated list of <a href="https://developer.android.com/google/play/billing/terminology#concepts" target="_blank" rel="noopener noreferrer">Google Play product SKUs (now called product IDs)</a> that map to this plan.</td></tr><tr><td>promotionCodes</td><td>Optional. Array of strings. A list of Stripe promotion codes that are valid for the product or plan.</td></tr><tr><td>styles</td><td>Object. Currently the only key in this object is <code>webIconBackground</code>, and the value must be a valid CSS color, color name or gradient. The background color is displayed behind the product icon from the <a href="#product-config-urls">URLs</a> configuration. Defaults to <code>#20123a</code>.</td></tr><tr><td>support</td><td>Object. Currently the only key in this object is <code>app</code>. The value is an array of strings that are apps and services for the support form. The form options will be in the same order the configuration. These values shouldn&#x27;t be too long as they are displayed in dropdown options of limited width. The value is submitted to Zendesk.</td></tr><tr><td>urls</td><td>Object. See <a href="#product-config-urls">URLs Configuration</a> below.</td></tr><tr><td>uiContent</td><td>Object. See <a href="#product-config-ui-content">UI Content Configuration</a> below.</td></tr><tr><td>locales</td><td>Object. See <a href="#product-config-locales">Locales Configuration</a>.</td></tr></tbody></table>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="production-config-capabilities">Capabilities Configuration<a href="#production-config-capabilities" class="hash-link" aria-label="Direct link to Capabilities Configuration" title="Direct link to Capabilities Configuration">​</a></h6>
<p>See <a href="/ecosystem-platform/relying-parties/reference/sub-plat-overview#capability">Capabilities</a> for an overview.</p>
<p>This is an object where the keys are: <code>*</code> or a relying party client ID. The values are arrays of capabilities. At least one key must be present.</p>
<table><thead><tr><th>Key</th><th>Description</th></tr></thead><tbody><tr><td>*</td><td>Array. Capabilities enabled by this product for all Relying Parties.</td></tr><tr><td>{clientID}</td><td>Array. Capabilities enabled by this product for the Relying Party identified by {clientID}.</td></tr></tbody></table>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="product-config-urls">URLs Configuration<a href="#product-config-urls" class="hash-link" aria-label="Direct link to URLs Configuration" title="Direct link to URLs Configuration">​</a></h6>
<p>An object where the values are URLs used in the subscription experience.</p>
<table><thead><tr><th>Key</th><th>Description</th></tr></thead><tbody><tr><td>appStore</td><td>Optional. The App Store download URL for the product.</td></tr><tr><td>playStore</td><td>Optional. The Google Play store download URL for the product.</td></tr><tr><td>webIcon</td><td>Image URL for the product icon in web content. This must be a URL to the FxA CDN at <code>https://accounts-static.cdn.mozilla.net</code>.</td></tr><tr><td>emailIcon</td><td>Optional. Image URL for the product icon in email content. This must be a URL to the FxA CDN at <code>https://accounts-static.cdn.mozilla.net</code>.</td></tr><tr><td>successActionButton</td><td>The download or subscription success action URL for the product after a successful subscription sign-up.</td></tr><tr><td>privacyNotice</td><td>The URL for the webpage containing the Privacy Notice for the product offering.</td></tr><tr><td>privacyNoticeDownload</td><td>Optional. The URL for a downloadable version of the Privacy Notice for the product offering. This has the same requirements as <code>termsOfServiceDownload</code> (see below).</td></tr><tr><td>termsOfService</td><td>The URL for the webpage containing the Terms of Service for the product offering.</td></tr><tr><td>termsOfServiceDownload</td><td>The URL for a downloadable version of the Terms of Service for the product offering, used in emails. This must be a URL to the FxA CDN at <code>https://accounts-static.cdn.mozilla.net</code>. It can be either a) full, direct URL to a PDF (e.g. <code>https://accounts-static.cdn.mozilla.net/legal/Mozilla_VPN_ToS/en-US.pdf</code>), or, b) a URL without the language and file extension (e.g. <code>https://accounts-static.cdn.mozilla.net/legal/mozilla_vpn_tos</code>). See the <a href="#legal-document-download-url">&quot;Legal Document Download URL&quot;</a> section for more information.</td></tr><tr><td>cancellationSurvey</td><td>Optional. Override URL for the Cancellation Survey for the product offering. It is used as a link in the email sent to the customer when their subscription is cancelled.</td></tr></tbody></table>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="product-config-ui-content">UI Content Configuration<a href="#product-config-ui-content" class="hash-link" aria-label="Direct link to UI Content Configuration" title="Direct link to UI Content Configuration">​</a></h6>
<p>An object with configuration values used as web UI content.</p>
<table><thead><tr><th>Key</th><th>Description</th></tr></thead><tbody><tr><td>subtitle</td><td>Optional. A subtitle for the product, usually displayed beneath the name in UI.</td></tr><tr><td>details</td><td>Optional. An array of bullet-point feature details for the product. The list items will be displayed in the order they appear in the array.</td></tr><tr><td>successActionButtonLabel</td><td>Optional. An alternative label for the subscription success action button. The action is specified by <code>successActionButton</code> in the <a href="#product-config-urls">URLs</a>.</td></tr><tr><td>upgradeCTA</td><td>Optional. HTML content string describing available upgrades from this plan. By convention, it should include a link back to a product lead page. That lead page links back to FxA&#x27;s plan subscription pages.</td></tr></tbody></table>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="product-config-locales">Locales Configuration<a href="#product-config-locales" class="hash-link" aria-label="Direct link to Locales Configuration" title="Direct link to Locales Configuration">​</a></h6>
<p>An optional object used for localisation. It uses language tags as keys (e.g. <code>en</code>, <code>en-CA</code>, <code>es</code>) and the value is an object with the keys <code>support</code>, <code>uiContent</code>, and <code>urls</code>.</p>
<table><thead><tr><th>Key</th><th>Description</th></tr></thead><tbody><tr><td>{language-tag}</td><td>Object with the follow key to value mapping: <code>support</code> - the support configuration object, <code>uiContent</code> - the <a href="#product-config-ui-content">UI content configuration</a>, <code>urls</code> - the <a href="#product-config-urls">URLs configuration object</a>.</td></tr></tbody></table>
<h6 class="anchor anchorWithStickyNavbar_LWe7" id="legal-document-download-url">Legal Document Download URL<a href="#legal-document-download-url" class="hash-link" aria-label="Direct link to Legal Document Download URL" title="Direct link to Legal Document Download URL">​</a></h6>
<p>For the legal document download URL configurations values, they can be in the
form of an incomplete URL, as they will be handled by a redirect endpoint that
tries to best match the user&#x27;s locale to a localized version of the document.
For example, if the value of the Terms of Service URL is
<code>https://accounts-static.cdn.mozilla.net/legal/mozilla_vpn_tos</code> and the user&#x27;s
locale is <code>de</code>, then the endpoint will redirect the user to
<code>https://accounts-static.cdn.mozilla.net/legal/mozilla_vpn_tos.de.pdf</code>.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="subscription-metadata">Subscription Metadata<a href="#subscription-metadata" class="hash-link" aria-label="Direct link to Subscription Metadata" title="Direct link to Subscription Metadata">​</a></h5>
<table><thead><tr><th>Key</th><th>Value</th></tr></thead><tbody><tr><td>previous_plan_id</td><td>The value of the previous plan that the user had been subscribed to.</td></tr><tr><td>plan_change_date</td><td>Unix timestamp of the date the plan was changed.</td></tr><tr><td>cancelled_for_customer_at</td><td>Unix timestamp of the date when the subscription was cancelled for the customer through FxA UI</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="navigating-the-payment-flow">Navigating the Payment Flow<a href="#navigating-the-payment-flow" class="hash-link" aria-label="Direct link to Navigating the Payment Flow" title="Direct link to Navigating the Payment Flow">​</a></h2>
<p>Once your API keys are set, restart the affected servers (<code>auth</code> or <code>payments</code>) if needed.</p>
<p>Reference the <a href="/ecosystem-platform/how-tos/creating-an-account-locally">workflow</a> section of the FxA docs to sign up for and verify an account. You should now be able to access the payment flow at:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">http://localhost:3030/subscriptions/products/{productId}?plan={planId}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>productId</code> should match the ID from a product taken from the Stripe dashboard. The <code>plan</code> parameter is optional, unless you want to specify a plan. Otherwise, if the product has multiple plans, the first one in the list as returned by Stripe is used. If you are running the entire FxA stack and are using the keys from the Stripe FxA dev account, you can navigate to <code>123done</code> on port <code>:8080</code> to click on the link beginning with &quot;Subscribe&quot; to reach the form with a prepopulated product.</p>
<p>Enter any name, valid expiration date, CVC number, and any card number from the <a href="https://stripe.com/docs/testing#cards" target="_blank" rel="noopener noreferrer">Stripe test cards docs</a> to successfully create a test subscription.</p>
<p>Navigate back to <code>http://localhost:3030/subscriptions</code> to manage your subscriptions.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="understanding-subscription-status">Understanding Subscription Status<a href="#understanding-subscription-status" class="hash-link" aria-label="Direct link to Understanding Subscription Status" title="Direct link to Understanding Subscription Status">​</a></h2>
<p>Stripe defines the <a href="https://stripe.com/docs/api/subscriptions/object#subscription_object-status" target="_blank" rel="noopener noreferrer">valid states a subscription status can be in their API docs</a>.
Since <code>incomplete</code> and <code>incomplete_expired</code> are subscriptions that have never been paid, FxA ignores them except for the following condition: if a user with a subscription in an <code>incomplete</code> state successfully enters valid payment information, the <code>incomplete</code> subscription will be paid and activated.</p>
<p>FxA&#x27;s Stripe account is configured to not allow subscriptions to become <code>unpaid</code> and will cancel the subscription instead.</p>
<p>The last 4 states are <code>active</code>, <code>trialing</code>, <code>past_due</code>, and <code>cancelled</code>. The first three of these are considered active for the purposes of allowing the user access to the capabilities provided by the subscription, while <code>cancelled</code> subscriptions grant none.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="stripe-radar-and-payment-blocking">Stripe Radar and Payment Blocking<a href="#stripe-radar-and-payment-blocking" class="hash-link" aria-label="Direct link to Stripe Radar and Payment Blocking" title="Direct link to Stripe Radar and Payment Blocking">​</a></h3>
<p>We use <a href="https://stripe.com/docs/radar/rules" target="_blank" rel="noopener noreferrer">Stripe Radar</a> to block payments from both potentially abusive sources as well as from potential subscribers in currently unsupported regions. Our production radar rules are <a href="https://mana.mozilla.org/wiki/display/FJT/Stripe+Radar+Rules" target="_blank" rel="noopener noreferrer">documented in Mana</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="interactions-with-stripe">Interactions with Stripe<a href="#interactions-with-stripe" class="hash-link" aria-label="Direct link to Interactions with Stripe" title="Direct link to Interactions with Stripe">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="forwarding-stripe-webhooks">Forwarding Stripe Webhooks<a href="#forwarding-stripe-webhooks" class="hash-link" aria-label="Direct link to Forwarding Stripe Webhooks" title="Direct link to Forwarding Stripe Webhooks">​</a></h3>
<p>To forward Stripe webhooks to your local, you can use the <a href="https://stripe.com/docs/stripe-cli" target="_blank" rel="noopener noreferrer">Stripe CLI</a>.
You&#x27;ll need to <code>stripe login</code> to authenticate before you can start forwarding.</p>
<p>To start webhook forwarding, run:</p>
<p>stripe listen --forward-to localhost:9000/v1/oauth/subscriptions/stripe/event</p>
<p>The first time you run this, you&#x27;ll need to grab the Stripe webhook secret displayed there, and add that to your secrets.json as described in <a href="#secrets">secrets</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="payments-server">Payments Server<a href="#payments-server" class="hash-link" aria-label="Direct link to Payments Server" title="Direct link to Payments Server">​</a></h3>
<p>The payments server is an isolated service that serves all subscription related
pages that utilize the Stripe Javascript SDK. It&#x27;s isolated from the primary FxA
domain to comply with constraints on 3rd party Javascript on pages handling FxA
authentication.</p>
<p>When a subscription page is loaded, the React application served by the payment
server:</p>
<ol>
<li>Loads the Stripe Javascript SDK (for tokenizing credit cards)</li>
<li>Makes direct OAuth authenticated API calls to <a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-auth-server/docs/api.md#account" target="_blank" rel="noopener noreferrer">account</a>/<a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-auth-server/docs/api.md#subscriptions" target="_blank" rel="noopener noreferrer">subscription endpoints</a>
on the Auth Server as needed</li>
</ol>
<p>The payments server handles the payment flow as well as serving pages for managing
a user&#x27;s subscription that are linked from the Settings page.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="auth-server">Auth Server<a href="#auth-server" class="hash-link" aria-label="Direct link to Auth Server" title="Direct link to Auth Server">​</a></h3>
<p>FxA&#x27;s Auth Server makes Stripe API calls for authenticated FxA users via its <a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-auth-server/docs/api.md#subscriptions" target="_blank" rel="noopener noreferrer">subscription
endpoints</a>. Stripe updates are sent back to the Auth Server via Stripe webhooks when a
users subscription has been created/updated/deleted.</p>
<p>Some Stripe webhooks will trigger emails. These emails are behind a feature flag. If you wish to send emails in your environment, set the auth server configuration</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;subscriptions&quot;: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;transactionalEmails&quot;: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;enabled&quot;: true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>or the environment variable <code>SUBSCRIPTIONS_TRANSACTIONAL_EMAILS_ENABLED</code> to &quot;true&quot;. In order to receive Stripe webhook events in your local development, you need to use the <a href="https://stripe.com/docs/stripe-cli/webhooks" target="_blank" rel="noopener noreferrer">Stripe CLI</a>&#x27;s event forwarding feature. (For how to view these and other FxA emails, see <a href="https://github.com/mozilla/fxa/#running-with-maildev" target="_blank" rel="noopener noreferrer">the FxA README section on MailDev</a>.)</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="enabling-stripe-tax">Enabling Stripe Tax<a href="#enabling-stripe-tax" class="hash-link" aria-label="Direct link to Enabling Stripe Tax" title="Direct link to Enabling Stripe Tax">​</a></h3>
<p>To enable Stripe Tax in the Auth server you can: enable <code>stripeAutomaticTax</code> in your <code>secrets.json</code> or through your environment variables with <code>SUBSCRIPTIONS_STRIPE_AUTOMATIC_TAX</code></p>
<p>Example using secrets.json:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;subscriptions&quot;: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;stripeAutomaticTax&quot;: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;enabled&quot;: true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>or with a <code>.env</code> file and <code>dotenv</code></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">SUBSCRIPTIONS_STRIPE_AUTOMATIC_TAX=true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="overriding-geolocation-with-stripe-tax">Overriding Geolocation With Stripe Tax<a href="#overriding-geolocation-with-stripe-tax" class="hash-link" aria-label="Direct link to Overriding Geolocation With Stripe Tax" title="Direct link to Overriding Geolocation With Stripe Tax">​</a></h3>
<p>When running the FxA stack locally, our geodb service needs an override to resolve a location. This override object takes the form of:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;location&quot;: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;countryCode&quot;: &lt;2 letter country code string&gt;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;postalCode&quot;: &lt;corresponding postal code string&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>and can be passed in either through your <code>secrets.json</code> or through your environment variables.</p>
<p>Example using <code>secrets.json</code>:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;geodb&quot;: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;locationOverride&quot;: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;location&quot;: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;countryCode&quot;: &quot;US&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;postalCode&quot;: &quot;98332&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>or with a <code>.env</code> file using <code>dotenv</code></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">GEODB_LOCATION_OVERRIDE= { &quot;location&quot;: { &quot;countryCode&quot;: &quot;US&quot;, &quot;postalCode&quot;: &quot;85001&quot;} }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="paypal-integration">PayPal Integration<a href="#paypal-integration" class="hash-link" aria-label="Direct link to PayPal Integration" title="Direct link to PayPal Integration">​</a></h2>
<p>PayPal can be configured as an additional payment provider in the Subscription Platform. PayPal&#x27;s <a href="https://developer.paypal.com/docs/archive/express-checkout/integration-guide/ECReferenceTxns/" target="_blank" rel="noopener noreferrer">Express Checkout Reference Transactions</a> is the feature that enables the Subscription Platform to use PayPal as a payment provider for recurring subscriptions. The customer&#x27;s PayPal Billing Agreement ID is saved for future subscription invoices. See <a href="#paypal-checkout">the diagram below</a> for details on this process.</p>
<p>The PayPal paid subscriptions are still driven by Stripe&#x27;s subscription and invoicing model. The key difference is that PayPal paid subscriptions have a <a href="https://stripe.com/docs/api/subscriptions/object#subscription_object-collection_method" target="_blank" rel="noopener noreferrer">collection method</a> of <code>send_invoice</code>. The <a href="#paypal-processor">PayPal processor</a> is used to pay the invoices with the customer&#x27;s billing agreement ID.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="paypal-accounts">PayPal Accounts<a href="#paypal-accounts" class="hash-link" aria-label="Direct link to PayPal Accounts" title="Direct link to PayPal Accounts">​</a></h3>
<p>You need three types of PayPal accounts for development.</p>
<ul>
<li>PayPal Developer Account: allows you to access the PayPal Developer Dashboard</li>
<li>Sandbox PayPal Personal Account: used for testing as the customer</li>
<li>Sandbox PayPal Business Account: used for testing</li>
</ul>
<p>To create a PayPal developer account, sign up at <a href="https://developer.paypal.com/" target="_blank" rel="noopener noreferrer">developer.paypal.com</a>. Note that if you are a Mozilla employee, you should contact the Mozilla PayPal admin in Finance to set up a developer account. Additionally, you should <a href="https://www.paypal.com/businessmanage/profile/loginSecurity" target="_blank" rel="noopener noreferrer">enable 2FA for the developer account</a>.</p>
<p>Once you are in the PayPal developer dashboard, navigate to &quot;Accounts&quot; under the Sandbox section of the menu. Here you can create <a href="https://developer.paypal.com/docs/api-basics/sandbox/accounts/" target="_blank" rel="noopener noreferrer">a pair of personal and business sandbox accounts</a>. (To easily create multiple accounts for testing, there&#x27;s a <a href="https://developer.paypal.com/docs/api-basics/sandbox/bulk-accounts/" target="_blank" rel="noopener noreferrer">bulk account creation feature</a>.)</p>
<p>Once you&#x27;ve added your account pair, navigate to the bussines account by selecting &quot;View/edit account&quot;. Now click on the &quot;API Credentials&quot; tab. You&#x27;ll need the &quot;NVP/SOAP Sandbox API Credentials&quot; for the next section.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configuration-1">Configuration<a href="#configuration-1" class="hash-link" aria-label="Direct link to Configuration" title="Direct link to Configuration">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="auth-server-1">Auth Server<a href="#auth-server-1" class="hash-link" aria-label="Direct link to Auth Server" title="Direct link to Auth Server">​</a></h4>
<p>In order to enable and use PayPal in the auth server, set the following configuration options</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;subscriptions&quot;: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;paypalNvpSigCredentials&quot;: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;enabled&quot;: true,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;sandbox&quot;: true,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;user&quot;: &quot;your PayPal NVP API User name&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;pwd&quot;: &quot;your PayPal NVP API password&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;signature&quot;: &quot;your PayPal NVP API signature&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The environment variables equivalent would be</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">SUBSCRIPTIONS_PAYPAL_ENABLED=true \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">PAYPAL_SANDBOX=true \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">PAYPAL_NVP_USER=&#x27;your PayPal NVP API User name&#x27; \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">PAYPAL_NVP_PWD=&#x27;your PayPal NVP API password&#x27; \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">PAYPAL_NVP_SIGNATURE=&#x27;your PayPal NVP API signature&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Nx will always pull from <code>.env</code> files over others (e.g., <code>secrets.json</code>) by default - see <a href="https://nx.dev/recipes/tips-n-tricks/define-environment-variables" target="_blank" rel="noopener noreferrer">Nx documentation</a> for more information.</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="payments-server-1">Payments Server<a href="#payments-server-1" class="hash-link" aria-label="Direct link to Payments Server" title="Direct link to Payments Server">​</a></h4>
<p>The Payments frontend also does not offer PayPal as payment provider by default. To enable the feature, set the following configuration options</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;paypal&quot;: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;clientId&quot;: &quot;sb&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;apiUrl&quot;: &quot;https://www.sandbox.paypal.com&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;scriptUrl&quot;: &quot;https://www.paypal.com&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Or use the environment variables</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">PAYPAL_CLIENT_ID=&#x27;sb&#x27; \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">PAYPAL_API_URL=&#x27;https://www.sandbox.paypal.com&#x27; \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">PAYPAL_SCRIPT_URL=&#x27;https://www.paypal.com&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The paypal*/PAYPAL_* values are the defaults in the repo. For local development, you do not need to change them.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-paypal-button">The PayPal Button<a href="#the-paypal-button" class="hash-link" aria-label="Direct link to The PayPal Button" title="Direct link to The PayPal Button">​</a></h3>
<p>The Payments frontend uses the <a href="https://developer.paypal.com/docs/business/javascript-sdk/" target="_blank" rel="noopener noreferrer">PayPal JavaScript SDK</a> to <a href="https://developer.paypal.com/docs/business/checkout/configure-payments/single-page-app/" target="_blank" rel="noopener noreferrer">add a button</a> to the checkout process to <a href="https://developer.paypal.com/docs/business/javascript-sdk/javascript-sdk-configuration/#intent-options-when-integrating-with-older-apis" target="_blank" rel="noopener noreferrer">integrate with PayPal&#x27;s NVP/SOAP API</a>. This button is loaded and displayed in an iFrame by PayPal.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="instant-payment-notification-ipn">Instant Payment Notification (IPN)<a href="#instant-payment-notification-ipn" class="hash-link" aria-label="Direct link to Instant Payment Notification (IPN)" title="Direct link to Instant Payment Notification (IPN)">​</a></h3>
<p><a href="https://developer.paypal.com/docs/api-basics/notifications/ipn/" target="_blank" rel="noopener noreferrer">PayPal IPN</a> is PayPal&#x27;s equivalent of Stripe&#x27;s webhook feature. We do rely on IPNs in the Subscription Platform. Unlike Stripe, however, PayPal does not offer any tool that would forward the events to your local environment. Our team use <a href="https://ngrok.com/" target="_blank" rel="noopener noreferrer">ngrok</a> for that purpose.</p>
<p>Once you have the services running locally, start ngrok with <code>ngrok 9000</code> and note the public URL. Using your sandbox business account and the public URL fron ngrok, complete <a href="https://developer.paypal.com/docs/api-basics/notifications/ipn/IPNSetup/" target="_blank" rel="noopener noreferrer">these steps to set up IPNs</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="paypal-processor">PayPal Processor<a href="#paypal-processor" class="hash-link" aria-label="Direct link to PayPal Processor" title="Direct link to PayPal Processor">​</a></h3>
<p>After the initial payment during subscription creation, the recurring payments for future invoices are handled by the PayPal processor script. To simulate or debug charging additional invoices paid by PayPal, you need to run this script. It is located at <code>packages/fxa-auth-server/scripts/paypal-process.ts</code>.</p>
<p>The script will make up to a configurable number of <a href="https://developer.paypal.com/docs/archive/express-checkout/ec-set-up-reference-transactions/#capture-future-payments" target="_blank" rel="noopener noreferrer">attempts to pay</a> an invoice before cancelling the subscription. This attempts count is saved to the invoice itself as metadata. The invoice&#x27;s metadata is also used to prevent sending multiple failed payment emails per invoice from the PayPal payment attempts.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="strapi-integration">Strapi Integration<a href="#strapi-integration" class="hash-link" aria-label="Direct link to Strapi Integration" title="Direct link to Strapi Integration">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configuration-2">Configuration<a href="#configuration-2" class="hash-link" aria-label="Direct link to Configuration" title="Direct link to Configuration">​</a></h3>
<p>Add the following environment variables to your <code>.env</code> file, or <code>.env.local</code> in <code>apps/payments/next/</code>:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">STRAPI_CLIENT_CONFIG__GRAPHQL_API_URI=</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">STRAPI_CLIENT_CONFIG__API_KEY=</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">STRAPI_CLIENT_CONFIG__MEM_CACHE_T_T_L=</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">STRAPI_CLIENT_CONFIG__FIRESTORE_CACHE_COLLECTION_NAME=</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">STRAPI_CLIENT_CONFIG__FIRESTORE_CACHE_T_T_L=</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deployments">Deployments<a href="#deployments" class="hash-link" aria-label="Direct link to Deployments" title="Direct link to Deployments">​</a></h3>
<p>Changes are made in the <code>Dev</code> environment and follow the deployment path as shown below.</p>
<!-- -->
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="changes-to-content">Changes to content<a href="#changes-to-content" class="hash-link" aria-label="Direct link to Changes to content" title="Direct link to Changes to content">​</a></h4>
<ol>
<li>Log into the Strapi instance with Strapi App Credentials (<a href="https://mozilla-hub.atlassian.net/wiki/spaces/SD/pages/26742230/1Password+Overview" target="_blank" rel="noopener noreferrer">see 1Password Business Account</a>).</li>
<li>In the navigation menu, select <code>Content Manager</code> and make your desired changes. Be sure to save your changes and that the entry is marked <code>Published</code> (See <a href="/ecosystem-platform/relying-parties/reference/sub-plat-strapi">Managing Subscriptions with Strapi</a> for more information).</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="changes-to-schema">Changes to schema<a href="#changes-to-schema" class="hash-link" aria-label="Direct link to Changes to schema" title="Direct link to Changes to schema">​</a></h4>
<ol>
<li>Start up <a href="https://github.com/mozilla/fxa-strapi" target="_blank" rel="noopener noreferrer"><code>mozilla/fxa-strapi</code></a> with <code>npm run develop</code> and log into the Strapi instance (you may need to create your own login credentials).</li>
<li>Make the changes and, if necessary, run <code>nx codegen shared-cms</code> against your local Strapi instance in a new branch (check that you first have the Strapi environmental variables above in your .env file).</li>
<li>Commit and push your changes in GitHub. Be sure your pull request is pointed to the appropriate branch (e.g., <code>dev</code>, <code>stg</code>, or <code>prod</code>).</li>
<li>Before a regular FxA release has been deployed to Stage, merge the <code>dev</code> branch of <code>fxa-strapi</code> into the <code>stg</code> branch.</li>
<li>Similarly, before a regular FxA release has been deployed to Production, merge changes from the <code>stg</code> branch into the <code>prod</code> branch.</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hotfixes">Hotfixes<a href="#hotfixes" class="hash-link" aria-label="Direct link to Hotfixes" title="Direct link to Hotfixes">​</a></h4>
<p>Hotfixes should follow either of the release paths discussed above. However, merges to Stage and Prod do not need to follow the FxA release schedule.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="google-iap-integration">Google IAP Integration<a href="#google-iap-integration" class="hash-link" aria-label="Direct link to Google IAP Integration" title="Direct link to Google IAP Integration">​</a></h2>
<p>The Subscription Platform supports RP integrations with Google IAP (In-App Purchases).</p>
<p>Unlike subscriptions created through the payments server website (referred to internally as &quot;web subscriptions&quot;), Google IAP subscriptions are managed and processed entirely outside of Stripe as required by Google. Consequently, while SubPlat maintains an awareness of subscription state in Firestore, we rely on RPs to register a Google IAP subscription for a particular FxA user when it&#x27;s created, and we rely on <a href="https://developer.android.com/google/play/billing/rtdn-reference" target="_blank" rel="noopener noreferrer">Real-Time Developer Notifications</a> to inform us of state changes, which we broadcast to RPs via the <code>fxa-event-broker</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configuration-3">Configuration<a href="#configuration-3" class="hash-link" aria-label="Direct link to Configuration" title="Direct link to Configuration">​</a></h3>
<p>The Google IAP integration is behind a feature flag. Set <code>subscriptions.playApiServiceAccount.enabled</code> in <code>./config/secrets.json</code> (see below) or the environment variable <code>SUBSCRIPTIONS_PLAY_API_ENABLED</code> to <code>true</code> before starting the auth server.</p>
<p>In <code>fxa-auth-server/config/secrets.json</code>, set the following config values under <code>subscriptions</code>:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token string-property property">&quot;subscriptions&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string-property property">&quot;playApiServiceAccount&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token string-property property">&quot;enabled&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token string-property property">&quot;keyFilename&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token string-property property">&quot;projectId&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can stop here if you&#x27;re only going to use the <a href="#testing-iap-subscriptions-locally">mock IAP script</a> for your local development and do not need a real connection to the Play API.
This is not required for most Google IAP development, so consider skipping the following section.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="connecting-to-a-play-api-service-account">Connecting to a Play API Service Account<a href="#connecting-to-a-play-api-service-account" class="hash-link" aria-label="Direct link to Connecting to a Play API Service Account" title="Direct link to Connecting to a Play API Service Account">​</a></h4>
<ol>
<li>Get access to Mozilla&#x27;s <code>firefox.gcp.mozilla.com</code> organization.</li>
<li>Create a new GCP project with Firestore<!-- -->
<ul>
<li>Create a new <code>developer</code> GCP project in the <code>firefox.gcp.mozilla.com</code> org. See <a href="https://firebase.google.com/docs/firestore/quickstart" target="_blank" rel="noopener noreferrer">GCP&#x27;s Quick Start Guide</a>.</li>
<li><a href="https://cloud.google.com/iam/docs/creating-managing-service-account-keys" target="_blank" rel="noopener noreferrer">Generate a keyfile</a> with the service account for the project.</li>
<li>To make API calls to the <a href="https://developer.android.com/google/play/developer-api" target="_blank" rel="noopener noreferrer">Google Play Developer API</a>, the service account <a href="https://developers.google.com/android-publisher/authorization" target="_blank" rel="noopener noreferrer">must have the API enabled</a>.</li>
<li>Save the keyfile to your computer. Recommended location: <code>fxa-auth-server/config/secret_${GCP-project-id}-key_file.json</code>.</li>
</ul>
</li>
<li>Link the GCP project&#x27;s Firestore instance to the auth server in <code>fxa-auth-server/config/secrets.json</code>.<!-- -->
<ul>
<li>Add the below configuration key/value pairs in <code>playApiServiceAccount</code>.</li>
<li>Replace the value for <code>keyFilename</code> with the absolute path to the keyfile created in step 2.</li>
<li>Replace the value for <code>projectId</code> with the project ID for the GCP project created in step 2.</li>
</ul>
</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="apple-iap-integration">Apple IAP Integration<a href="#apple-iap-integration" class="hash-link" aria-label="Direct link to Apple IAP Integration" title="Direct link to Apple IAP Integration">​</a></h2>
<p>The Subscription Platform supports RP integrations with Apple IAP (In-App Purchases).</p>
<p>Unlike subscriptions created through the payments server website (referred to internally as &quot;web subscriptions&quot;), Apple IAP subscriptions are managed and processed entirely outside of Stripe as required by Apple. Consequently, while SubPlat maintains an awareness of subscription state in Firestore, we rely on RPs to register an Apple IAP subscription for a particular FxA user when it&#x27;s created, and we rely on <a href="https://developer.apple.com/documentation/appstoreservernotifications" target="_blank" rel="noopener noreferrer">App Store Server notifications</a> to inform us of state changes, which we broadcast to RPs via the <code>fxa-event-broker</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="terminology-and-stripe-analogs">Terminology and Stripe analogs<a href="#terminology-and-stripe-analogs" class="hash-link" aria-label="Direct link to Terminology and Stripe analogs" title="Direct link to Terminology and Stripe analogs">​</a></h3>
<p>At the time of writing, the overwhelming majority of subscriptions (&gt; 95%) are web subscriptions mediated all or in part by Stripe. Given that, it may be helpful to draw analogies between Stripe and Apple identifiers to better understand how Apple IAP subscriptions are processed.</p>
<table><thead><tr><th>Stripe ID</th><th>Apple ID</th></tr></thead><tbody><tr><td><a href="https://stripe.com/docs/api/products/object#product_object-id" target="_blank" rel="noopener noreferrer"><code>productId</code></a></td><td><a href="https://developer.apple.com/documentation/appstoreserverapi/bundleid" target="_blank" rel="noopener noreferrer"><code>bundleId</code></a></td></tr><tr><td><a href="https://stripe.com/docs/api/plans/object#plan_object-id" target="_blank" rel="noopener noreferrer"><code>planId</code></a></td><td><a href="https://developer.apple.com/documentation/appstoreserverapi/productid" target="_blank" rel="noopener noreferrer"><code>productId</code></a></td></tr><tr><td><a href="https://stripe.com/docs/api/subscriptions/object#subscription_object-id" target="_blank" rel="noopener noreferrer"><code>subscriptionId</code></a></td><td><a href="https://developer.apple.com/documentation/appstoreserverapi/originaltransactionid" target="_blank" rel="noopener noreferrer"><code>originalTransactionId</code></a></td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configuration-4">Configuration<a href="#configuration-4" class="hash-link" aria-label="Direct link to Configuration" title="Direct link to Configuration">​</a></h3>
<p>The Apple IAP integration is behind a feature flag. Set <code>subscriptions.appStore.enabled</code> in <code>fxa-auth-server/config/secrets.json</code> or the environment variable <code>SUBSCRIPTIONS_APP_STORE_API_ENABLED</code> to <code>true</code> before starting the auth server.</p>
<p>In <code>fxa-auth-server/config/secrets.json</code>:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token string-property property">&quot;subscriptions&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string-property property">&quot;appStore&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token string-property property">&quot;credentials&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// one set of credentials for each RP iOS app</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token string-property property">&quot;org_mozilla_ios_FirefoxVPN&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token string-property property">&quot;issuerId&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token string-property property">&quot;serverApiKey&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token string-property property">&quot;serverApiKeyId&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token string-property property">&quot;enabled&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token string-property property">&quot;sandbox&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Replace the value for <code>issuerId</code>, <code>serverApiKey</code> and <code>serverApiKeyId</code> with credentials from the respective app&#x27;s <a href="https://appstoreconnect.apple.com/" target="_blank" rel="noopener noreferrer">App Store Connect</a> account.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><ul>
<li>These credentials are only needed for making API calls to the <a href="https://developer.apple.com/documentation/appstoreserverapi" target="_blank" rel="noopener noreferrer">App Store Server API</a>. Consider omitting or stubbing them if your work does not require it.</li>
<li>Each key under <code>credentials</code> is the App Store <code>bundleId</code> for an iOS app with the <code>.</code> replaced with <code>_</code> due to a <a href="https://github.com/mozilla/node-convict/issues/250" target="_blank" rel="noopener noreferrer">node-convict bug</a>. The <code>bundleId</code> can be found in App Store Connect for the given iOS app.</li>
</ul></div></div>
<p>To obtain these credentials for a given iOS app, file a bug in the <code>App Stores</code> product and <code>App Store Access</code> component in Bugzilla (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1710928" target="_blank" rel="noopener noreferrer">example bug</a>). You will need someone with an existing Admin or similar role in App Store Connect to vouch for you.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="notifications">Notifications<a href="#notifications" class="hash-link" aria-label="Direct link to Notifications" title="Direct link to Notifications">​</a></h3>
<p>We use <a href="https://developer.apple.com/documentation/appstoreservernotifications/app_store_server_notifications_v2" target="_blank" rel="noopener noreferrer">V2 App Store Server Notifications</a> which are compatible with <a href="https://developer.apple.com/documentation/storekit" target="_blank" rel="noopener noreferrer">StoreKit</a> 1 and StoreKit 2 iOS apps.</p>
<p>Unfortunately, unlike Stripe webhooks, Apple does not store their server notifications anywhere (even temporarily) for debugging. Further, Sandbox subscriptions can only be made with an iOS device via <a href="https://developer.apple.com/testflight/" target="_blank" rel="noopener noreferrer">TestFlight</a>, so it can be difficult as a developer to generate test notifications.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="debugging-sandbox-notifications">Debugging sandbox notifications<a href="#debugging-sandbox-notifications" class="hash-link" aria-label="Direct link to Debugging sandbox notifications" title="Direct link to Debugging sandbox notifications">​</a></h4>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><ul>
<li>If your local FxA is not running in a VM or Docker container, consider the security implications of this temporary setup before proceeding.</li>
<li>Only use this approach for Sandbox notifications, as the payloads are not encrypted at rest.</li>
</ul></div></div>
<p>Before you begin, make sure you have App Store API credentials set up in the auth server config. These are needed to decode and process notifications (see &quot;Configuration&quot; above).</p>
<ol>
<li>Set up a reverse proxy with <a href="https://ngrok.com/" target="_blank" rel="noopener noreferrer"><code>ngrok</code></a>.<!-- -->
<ul>
<li>The <code>ngrok</code> URL is a public URL, so try not to leave this running for more than a couple of hours.</li>
</ul>
</li>
<li>Temporarily <a href="https://help.apple.com/app-store-connect/#/dev0067a330b" target="_blank" rel="noopener noreferrer">forward V2 Sandbox App Store Server notifications</a> to your local FxA using the <code>ngrok</code> URL from #1 as the base URL (i.e. <code>${ngrok_base_URL}/v1/oauth/subscriptions/iap/app-store-notification</code>).<!-- -->
<ul>
<li>Let the team know that you are temporarily changing the Sandbox notification URL, as this will affect any Apple IAP testing in Stage.</li>
</ul>
</li>
<li>Ask QA to trigger the desired scenarios using TestFlight.</li>
<li>Restore the Sandbox notification URL in App Store Connect.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="testing-iap-subscriptions-locally">Testing IAP subscriptions locally<a href="#testing-iap-subscriptions-locally" class="hash-link" aria-label="Direct link to Testing IAP subscriptions locally" title="Direct link to Testing IAP subscriptions locally">​</a></h2>
<p>The test subscriptions described in this section are not true IAP subscriptions (i.e. there is no record of them in Apple or Google&#x27;s databases), but rather, they are representations in SubPlat&#x27;s Firestore database, which we use internally. As such, this approach can only be used to test code that assumes the IAP subscription is already cached in our database.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configure-the-auth-server-and-create-mock-iap-subscriptions">Configure the auth server and create mock IAP subscriptions<a href="#configure-the-auth-server-and-create-mock-iap-subscriptions" class="hash-link" aria-label="Direct link to Configure the auth server and create mock IAP subscriptions" title="Direct link to Configure the auth server and create mock IAP subscriptions">​</a></h3>
<ol>
<li>Configure the <code>fxa-auth-server</code> for IAP<!-- -->
<ul>
<li>Enable the IAP integration. See <a href="#google-iap-integration">Google IAP Integration</a> for Google IAP and <a href="#apple-iap-integration">Apple IAP Integration</a> for Apple IAP.</li>
<li>Note: For most development, setting <code>enabled</code> for both relevant configs is enough without setting up credentials.</li>
</ul>
</li>
<li>Setup a price for IAP<!-- -->
<ul>
<li>Create a price within Stripe.</li>
<li>Configure the price to have metadata fields <code>appStoreProductId</code> and <code>playSkuId</code> equal to some unique value (either in Stripe metadata or Firestore, depending on the state of <code>useFirestoreProductConfigs</code>). See <a href="#stripe-plan-metadata">Plan Metadata</a> for these fields.</li>
</ul>
</li>
<li>Create a local fxa user<!-- -->
<ul>
<li>Grab the id for the user. We&#x27;ll use this user id for creating mock subscriptions attached to that user.</li>
</ul>
</li>
<li>Run the mock IAP subscription creation script<!-- -->
<ul>
<li>Within auth-server, run <code>yarn run create-mock-iap --uid USER_ID --appStoreProductId SKU --playSkuId SKU</code> replacing USER_ID with the value from step 3, and SKU with the values from step 2.</li>
</ul>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="verify-it-worked">Verify it worked<a href="#verify-it-worked" class="hash-link" aria-label="Direct link to Verify it worked" title="Direct link to Verify it worked">​</a></h3>
<p>There are many ways this can be verified locally after following the steps above once logged in as the user with the test IAP subscription.</p>
<p>The easiest method is to go directly to the Subscription Management page: <code>localhost:${PORT}/subscriptions</code>, where <code>PORT</code> is defined in <code>fxa-payments-server/pm2.config.js</code>.</p>
<p>If things were set up correctly, you&#x27;ll see the IAP subscription listed.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ladder-diagrams-of-payment-interactions">Ladder Diagrams of Payment Interactions<a href="#ladder-diagrams-of-payment-interactions" class="hash-link" aria-label="Direct link to Ladder Diagrams of Payment Interactions" title="Direct link to Ladder Diagrams of Payment Interactions">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="paypal-checkout">PayPal Checkout<a href="#paypal-checkout" class="hash-link" aria-label="Direct link to PayPal Checkout" title="Direct link to PayPal Checkout">​</a></h3>
<p>Conditions for this flow:</p>
<ul>
<li>User has no payment source on file, or is a new customer.</li>
<li>User clicks the displayed <a href="https://developer.paypal.com/docs/checkout/integrate/#3-render-the-smart-payment-buttons" target="_blank" rel="noopener noreferrer">PayPal Smart Button</a> to pay with PayPal.</li>
</ul>
<p>This diagram represents the activity after the PayPal button is clicked.</p>
</div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/mozilla/ecosystem-platform/edit/master/docs/tutorials/subscription-platform.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/ecosystem-platform/tutorials/development-setup"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Development Setup</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/ecosystem-platform/how-tos/ci-guidelines"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">CI Guidelines</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#getting-started" class="table-of-contents__link toc-highlight">Getting Started</a><ul><li><a href="#pre-development" class="table-of-contents__link toc-highlight">Pre-Development</a></li><li><a href="#configuration" class="table-of-contents__link toc-highlight">Configuration</a></li></ul></li><li><a href="#navigating-the-payment-flow" class="table-of-contents__link toc-highlight">Navigating the Payment Flow</a></li><li><a href="#understanding-subscription-status" class="table-of-contents__link toc-highlight">Understanding Subscription Status</a><ul><li><a href="#stripe-radar-and-payment-blocking" class="table-of-contents__link toc-highlight">Stripe Radar and Payment Blocking</a></li></ul></li><li><a href="#interactions-with-stripe" class="table-of-contents__link toc-highlight">Interactions with Stripe</a><ul><li><a href="#forwarding-stripe-webhooks" class="table-of-contents__link toc-highlight">Forwarding Stripe Webhooks</a></li><li><a href="#payments-server" class="table-of-contents__link toc-highlight">Payments Server</a></li><li><a href="#auth-server" class="table-of-contents__link toc-highlight">Auth Server</a></li><li><a href="#enabling-stripe-tax" class="table-of-contents__link toc-highlight">Enabling Stripe Tax</a></li><li><a href="#overriding-geolocation-with-stripe-tax" class="table-of-contents__link toc-highlight">Overriding Geolocation With Stripe Tax</a></li></ul></li><li><a href="#paypal-integration" class="table-of-contents__link toc-highlight">PayPal Integration</a><ul><li><a href="#paypal-accounts" class="table-of-contents__link toc-highlight">PayPal Accounts</a></li><li><a href="#configuration-1" class="table-of-contents__link toc-highlight">Configuration</a></li><li><a href="#the-paypal-button" class="table-of-contents__link toc-highlight">The PayPal Button</a></li><li><a href="#instant-payment-notification-ipn" class="table-of-contents__link toc-highlight">Instant Payment Notification (IPN)</a></li><li><a href="#paypal-processor" class="table-of-contents__link toc-highlight">PayPal Processor</a></li></ul></li><li><a href="#strapi-integration" class="table-of-contents__link toc-highlight">Strapi Integration</a><ul><li><a href="#configuration-2" class="table-of-contents__link toc-highlight">Configuration</a></li><li><a href="#deployments" class="table-of-contents__link toc-highlight">Deployments</a></li></ul></li><li><a href="#google-iap-integration" class="table-of-contents__link toc-highlight">Google IAP Integration</a><ul><li><a href="#configuration-3" class="table-of-contents__link toc-highlight">Configuration</a></li></ul></li><li><a href="#apple-iap-integration" class="table-of-contents__link toc-highlight">Apple IAP Integration</a><ul><li><a href="#terminology-and-stripe-analogs" class="table-of-contents__link toc-highlight">Terminology and Stripe analogs</a></li><li><a href="#configuration-4" class="table-of-contents__link toc-highlight">Configuration</a></li><li><a href="#notifications" class="table-of-contents__link toc-highlight">Notifications</a></li></ul></li><li><a href="#testing-iap-subscriptions-locally" class="table-of-contents__link toc-highlight">Testing IAP subscriptions locally</a><ul><li><a href="#configure-the-auth-server-and-create-mock-iap-subscriptions" class="table-of-contents__link toc-highlight">Configure the auth server and create mock IAP subscriptions</a></li><li><a href="#verify-it-worked" class="table-of-contents__link toc-highlight">Verify it worked</a></li></ul></li><li><a href="#ladder-diagrams-of-payment-interactions" class="table-of-contents__link toc-highlight">Ladder Diagrams of Payment Interactions</a><ul><li><a href="#paypal-checkout" class="table-of-contents__link toc-highlight">PayPal Checkout</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Mozilla Corporation.</div></div></div></footer></div>
</body>
</html>