<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-reference/oauth-details">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">OAuth Details | Firefox Ecosystem Platform</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://mozilla.github.io/ecosystem-platform/reference/oauth-details"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="OAuth Details | Firefox Ecosystem Platform"><meta data-rh="true" name="description" content="Last updated: April 17, 2023"><meta data-rh="true" property="og:description" content="Last updated: April 17, 2023"><link data-rh="true" rel="icon" href="/ecosystem-platform/img/firefox-logo.png"><link data-rh="true" rel="canonical" href="https://mozilla.github.io/ecosystem-platform/reference/oauth-details"><link data-rh="true" rel="alternate" href="https://mozilla.github.io/ecosystem-platform/reference/oauth-details" hreflang="en"><link data-rh="true" rel="alternate" href="https://mozilla.github.io/ecosystem-platform/reference/oauth-details" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://RFM5H13DFK-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Firefox Ecosystem Platform" href="/ecosystem-platform/opensearch.xml"><link rel="stylesheet" href="/ecosystem-platform/assets/css/styles.f894936b.css">
<link rel="preload" href="/ecosystem-platform/assets/js/runtime~main.10caca44.js" as="script">
<link rel="preload" href="/ecosystem-platform/assets/js/main.9ad73f97.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(e){}return e}()||function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/ecosystem-platform/"><div class="navbar__logo"><img src="/ecosystem-platform/img/firefox-logo.png" alt="Ecosystem Platform Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/ecosystem-platform/img/firefox-logo.png" alt="Ecosystem Platform Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Firefox Ecosystem Platform</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/mozilla/ecosystem-platform" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ecosystem-platform/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">For Relying Parties</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/relying-parties/tutorials/integration-with-fxa">Tutorials</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/relying-parties/how-tos/end-to-end-encryption">How-to Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/relying-parties/reference/metrics-for-relying-parties">Reference</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active">For FxA Engineers</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/tutorials/development-setup">Tutorials</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/how-tos/ci-guidelines">How-to Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/ecosystem-platform/reference/team-processes/development-process">Reference</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/reference/team-processes/development-process">Team Processes</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/reference/style-guides/node-style-guide">Style Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/reference/tests-in-circleci">CI and Test Automation</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/application-logging">Application Logging</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/application-tracing">Application Tracing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/browser-support">Browser Support</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/customs-api">⚙️ Customs API Reference</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/database-structure">Database Structure</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/emails">Emails</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/experiments-ab-testing">Experiments &amp; A/B Testing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/github-strategies">GitHub Strategies</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/incident-response">Incident Response</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/localization">Localization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/metrics">Metrics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/mobile-specifics">Mobile Specifics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/ecosystem-platform/reference/oauth-details">OAuth Details</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/rate-limiting">Rate limiting</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/storybook-deploys-with-circleci">Storybook Deploys with CircleCI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/system-diagrams">System Diagrams</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/third-party-authentication">Third Party Authentication</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/tokens">Tokens</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/webchannels">WebChannels</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a href="https://docs.telemetry.mozilla.org/datasets/fxa.html" target="_blank" rel="noopener noreferrer" class="menu__link menuExternalLink_NmtK" tabindex="0">Telemetry Data Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/explanation/architectural-decision-records">Explanation</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/additional-docs">Additional Docs</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">For Support Agents</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/reference/admin-panel">Reference</a></div></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/ecosystem-platform/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">For FxA Engineers</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Reference</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">OAuth Details</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>OAuth Details</h1></header><p>Last updated: <code>April 17, 2023</code></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="configuring-oauth-clients">Configuring OAuth clients<a href="#configuring-oauth-clients" class="hash-link" aria-label="Direct link to Configuring OAuth clients" title="Direct link to Configuring OAuth clients">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-register-a-client-manually">How to register a client manually<a href="#how-to-register-a-client-manually" class="hash-link" aria-label="Direct link to How to register a client manually" title="Direct link to How to register a client manually">​</a></h3><p>Usually, when you connect applications to their OAuth resource server, they generate a client <code>id</code> and <code>secret</code> for you. In our case, we are the resource server.</p><p>The <code>id</code> and <code>secret</code> keys, in this context, can be seen as a username and password. They do not need to be generated in relation between one and another. In other words, they are not public and private keys.</p><p>With this procedure you will generate both client id and secret tokens to provide to your other applications and also partners who wants to leverage your identity provider service. Once you have the client id and secret, paste them in both the fxa-oauth-server AND your client service you want to bind using OAuth.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="difference-between-same-site-and-external-consumers">Difference between same site and external consumers<a href="#difference-between-same-site-and-external-consumers" class="hash-link" aria-label="Direct link to Difference between same site and external consumers" title="Direct link to Difference between same site and external consumers">​</a></h3><p>While other applications within your infrastructure would ideally be pre-approved at the user point of view, external consumers shouldn&#x27;t be. This is why when we develop a service leveraging another site, the user gets a confirmation window.</p><p>If you want to pre-approve your own web applications and prevent users in your accounts userbase to have a confirmation window, set the <code>trusted</code> flag to <code>true</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="installing-a-new-consumer">Installing a new consumer<a href="#installing-a-new-consumer" class="hash-link" aria-label="Direct link to Installing a new consumer" title="Direct link to Installing a new consumer">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="creating-the-client-id-and-secret-keys">Creating the client id and secret keys<a href="#creating-the-client-id-and-secret-keys" class="hash-link" aria-label="Direct link to Creating the client id and secret keys" title="Direct link to Creating the client id and secret keys">​</a></h4><p>Use the <a href="https://github.com/mozilla/fxa-oauth-client" target="_blank" rel="noopener noreferrer">fxa-oauth-client</a> CLI tool for registering new clients with your server.</p><p>FxA OAuth development environments support <code>localhost</code> and <code>localhost</code> as valid <code>redirectUri</code> values to ease development.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="oauth-resource-server-aka-fxa-oauth-server">OAuth resource server (a.k.a. <code>fxa-oauth-server</code>)<a href="#oauth-resource-server-aka-fxa-oauth-server" class="hash-link" aria-label="Direct link to oauth-resource-server-aka-fxa-oauth-server" title="Direct link to oauth-resource-server-aka-fxa-oauth-server">​</a></h4><p>Let&#x27;s assume that the client in this example is the <a href="https://github.com/mozilla/123done" target="_blank" rel="noopener noreferrer">123done</a> web application that you deployed at <code>https://clientapp.example.com</code> and that the OAuth route is available at <code>api/oauth</code> (this is specific to each client application, beware (!))</p><p>Add a new object literal within the <code>clients</code> array, that would look like:</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">&quot;clients&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string-property property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&lt;8-byte client id in hex&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string-property property" style="color:#36acaa">&quot;hashedSecret&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&lt;32-byte sha256 of the client secret in hex&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string-property property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;123done&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string-property property" style="color:#36acaa">&quot;imageUri&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://clientapp.example.com/static/img/logo100.png&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string-property property" style="color:#36acaa">&quot;redirectUri&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://clientapp.example.com/api/oauth&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string-property property" style="color:#36acaa">&quot;trusted&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>NOTE:</strong> the <code>trusted</code>, this would be for an internal application that you manage.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="oauth-clients">OAuth clients<a href="#oauth-clients" class="hash-link" aria-label="Direct link to OAuth clients" title="Direct link to OAuth clients">​</a></h4><p>This can be very different depending on your installed and supported version, you should have a look at the profile server and client application what are the required callbacks.</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">&quot;client_id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&lt;8-byte client id in hex&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">&quot;client_secret&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&lt;32-byte client secret in hex&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;123done&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">&quot;redirect_uri&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://clientapp.example.com/api/oauth&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">&quot;signin_uri&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://accounts.firefox.com/oauth/signin&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">&quot;oauth_uri&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://oauth.accounts.firefox.com/v1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">&quot;profile_uri&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://profile.firefox.com/v1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">&quot;scopes&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;profile&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="oauth-scopes">OAuth Scopes<a href="#oauth-scopes" class="hash-link" aria-label="Direct link to OAuth Scopes" title="Direct link to OAuth Scopes">​</a></h2><p>Each authorization grant in OAuth has an associated &quot;scope&quot;, a list containing one or more &quot;scope values&quot; that indicate what capabilities the granted token will have. Each individual scope value indicates a particular capability, such as the ability to read or write profile data, or to access the user&#x27;s data in a particular service.</p><p>As defined in <a href="https://tools.ietf.org/html/rfc6749#section-3.3" target="_blank" rel="noopener noreferrer">RFC6749 Section 3.3</a>, the scope of a token is expressed as a list of space-delimited, case-sensitive strings, and it is left up to the service to define the format and semantics of the individual scope values that make up this string.</p><p>This document defines the scope values accepted in the Firefox Accounts ecosystem, and the rules for parsing and validating them.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="short-name-scope-values">Short-name scope values<a href="#short-name-scope-values" class="hash-link" aria-label="Direct link to Short-name scope values" title="Direct link to Short-name scope values">​</a></h3><p>FxA supports a small set of &quot;short-name&quot; scope values that are identified by a short English word. These correspond either to scope values defined by external  specifications (e.g. OpenID Connect), or to legacy scope values introduced during early development.</p><p><strong>No new short-name scope values should be added.</strong>
Instead we prefer to use URLs for new scope values, both to ensure uniqueness and to simplify parsing rules.</p><p>Short-name scope values imply read-only access by default, with write access indicated by the suffix &quot;:write&quot;. The may also have &quot;sub-scopes&quot; to indicate finer-grained access control. Each name component may contain only ascii alphanumeric characters and the underscore.</p><p>For example:</p><ul><li><code>profile</code> indicates read-only access to the user&#x27;s profile data.</li><li><code>profile:write</code> indicates read/write access to the user&#x27;s profile data.</li><li><code>profile:display_name</code> indicates read-only access to the user&#x27;s display name, but not any other profile data.</li><li><code>profile:email:write</code> indicates read/write access to the user&#x27;s email address.</li></ul><p>The following short-name scope values are recognized in the FxA ecosystem.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="profile-data">Profile data<a href="#profile-data" class="hash-link" aria-label="Direct link to Profile data" title="Direct link to Profile data">​</a></h4><ul><li><code>profile</code>: access the user&#x27;s profile data.</li><li><code>profile:uid</code>: access the user&#x27;s opaque user id.</li><li><code>profile:email</code>: access the user&#x27;s email address.</li><li><code>profile:locale</code>: access the user&#x27;s locale.</li><li><code>profile:avatar</code>: access the user&#x27;s avatar picture.</li><li><code>profile:display_name</code>: access the user&#x27;s human-readable display name.</li><li><code>profile:amr</code>: access information about the user&#x27;s authentication methods and 2FA status.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="openid-connect">OpenID Connect<a href="#openid-connect" class="hash-link" aria-label="Direct link to OpenID Connect" title="Direct link to OpenID Connect">​</a></h4><ul><li><code>openid</code>: used to request an OpenID Connect <code>id_token</code>.</li><li><code>email</code>: a synonym for <code>profile:email</code>, defined by the OIDC spec.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="oauth-client-management">OAuth Client Management<a href="#oauth-client-management" class="hash-link" aria-label="Direct link to OAuth Client Management" title="Direct link to OAuth Client Management">​</a></h4><ul><li><code>clients</code>: access the list of OAuth clients connected to a user&#x27;s account.</li><li><code>oauth</code>: register a new OAuth client record.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="basket">Basket<a href="#basket" class="hash-link" aria-label="Direct link to Basket" title="Direct link to Basket">​</a></h4><ul><li><code>basket</code>: access the user&#x27;s subscription data in
<a href="http://basket.readthedocs.io/" target="_blank" rel="noopener noreferrer">basket</a></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="url-scopes">URL Scopes<a href="#url-scopes" class="hash-link" aria-label="Direct link to URL Scopes" title="Direct link to URL Scopes">​</a></h3><p>For new capabilities, scope values are represented as URLs. This helps to ensure uniqueness and reduces ambiguity in parsing. URL-format scope value imply read/write access by default, are compared as heirarchical resource references, and use the hash fragment for permission qualifiers. For example:</p><ul><li><code>https://identity.mozilla.com/apps/oldsync</code> indicates full access to the user&#x27;s data in Firefox Sync.</li><li><code>https://identity.mozilla.com/apps/oldsync/bookmarks</code> indicates full access to the user&#x27;s bookmark data in Firefox Sync, but not to other data types.</li><li><code>https://identity.mozilla.com/apps/oldsync#read</code> indicates read-only access to the user&#x27;s data in Firefox Sync.</li><li><code>https://identity.mozilla.com/apps/oldsync/history#write</code> indicates write-only access to the user&#x27;s history data in Firefox Sync.</li></ul><p>To be a valid scope value, the URL must:</p><ul><li>Be an absolute <code>https://</code> URL.</li><li>Have no username, password, or query component.</li><li>If present, have a fragment component consisting only of alphanumeric ascii characters and underscore.</li><li>Remain unchanged when parsed and serialized following the rules in the <a href="https://url.spec.whatwg.org" target="_blank" rel="noopener noreferrer">WhatWG URL Spec</a>.</li></ul><p>The following URL scope values are currently recognized by FxA:</p><ul><li><code>https://identity.mozilla.com/apps/oldsync</code>: access to data in Firefox Sync.</li><li><code>https://identity.mozilla.com/apps/notes</code>: access to data in Firefox Notes.</li><li><code>https://identity.mozilla.com/account/subscriptions</code>: access to subscription data from Subscription Platform.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="scope-matching-and-implication">Scope Matching and Implication<a href="#scope-matching-and-implication" class="hash-link" aria-label="Direct link to Scope Matching and Implication" title="Direct link to Scope Matching and Implication">​</a></h3><p>We say that a scope value A <em>implies</em> another scope value B if they are exactly equal, or if A represents a more general capability than B. Similarly, a scope A implies scope value B if there is some scope value in A that implies B. This is the basic operation used to check permissions when processing an OAuth token.</p><p>Consumers of OAuth tokens should avoid directly parsing and comparing scopes where possible, and instead use the existing implementation in the <code>fxa-shared</code> node module.</p><p>For consumers that must implement their own scope checking, the rules for implication can be summarized as:</p><ul><li>For URL scope values, <code>A</code> implies <code>B</code> if <code>A</code> is a parent resource of <code>B</code>.</li><li>For short-name scope values, split on the &quot;:&quot; character,  and <code>A</code> implies <code>B</code> if either:<ul><li><code>B[-1]</code> is not &quot;write&quot; and <code>A</code> is a prefix of <code>B</code>, or.</li><li><code>A[-1]</code> is &quot;write&quot;, and:<ul><li><code>A[:-1]</code> is a prefix of <code>B</code>, or</li><li><code>B[-1]</code> is &quot;write&quot; and <code>A[:-1]</code> is a prefix of <code>B[:-1]</code></li></ul></li></ul></li></ul><p>More precisely, the algoritm for checking implication is:</p><ul><li>If <code>A</code> is a <code>https://</code> URL, then:<ul><li>If <code>B</code> is not a <code>https://</code> URL, then fail.</li><li>If the origin of <code>B</code> is different than that of <code>A</code>, then fail.</li><li>If the path component list of <code>A</code> is not a prefix of the path
component list of <code>B</code>, then fail.</li><li>If <code>A</code> has a fragment, then:<ul><li>If <code>B</code> does not have a fragment, then fail.</li><li>If <code>B</code> has a fragment that differs from <code>A</code>, then fail.</li></ul></li><li>Otherwise, succeed.</li></ul></li><li>Otherwise:<ul><li>If <code>B</code> is a <code>https://</code> URL, then fail.</li><li>Split <code>A</code> and <code>B</code> into components based on <code>:</code> delimiter.</li><li>If the last component of <code>B</code> is <code>write</code>, then:<ul><li>If the last component of <code>A</code> is not <code>write</code>, then fail.</li></ul></li><li>If the last component of <code>A</code> is <code>write</code>, remove it.</li><li>If <code>A</code> is not a prefix of <code>B</code>, then fail.</li><li>Otherwise, succeed.</li></ul></li></ul><p>Below are some testcases against which scope-checking code can be validated.</p><p>Valid implications:</p><ul><li><code>profile:write</code> implies <code>profile</code>.</li><li><code>profile</code> implies <code>profile:email</code>.</li><li><code>profile:write</code> implies <code>profile:email</code>.</li><li><code>profile:write</code> implies <code>profile:email:write</code>.</li><li><code>profile:email:write</code> implies <code>profile:email</code>.</li><li><code>profile profile:email:write</code> implies <code>profile:email</code>.</li><li><code>profile profile:email:write</code> implies <code>profile:display_name</code>.</li><li><code>profile https://identity.mozilla.com/apps/oldsync</code> implies <code>profile</code>.</li><li><code>profile https://identity.mozilla.com/apps/oldsync</code> implies <code>https://identity.mozilla.com/apps/oldsync</code>.</li><li><code>https://identity.mozilla.com/apps/oldsync</code> implies <code>https://identity.mozilla.com/apps/oldsync#read</code>.</li><li><code>https://identity.mozilla.com/apps/oldsync</code> implies <code>https://identity.mozilla.com/apps/oldsync/bookmarks</code>.</li><li><code>https://identity.mozilla.com/apps/oldsync</code> implies <code>https://identity.mozilla.com/apps/oldsync/bookmarks#read</code>.</li><li><code>https://identity.mozilla.com/apps/oldsync#read</code> implies <code>https://identity.mozilla.com/apps/oldsync/bookmarks#read</code>.</li><li><code>https://identity.mozilla.com/apps/oldsync#read profile</code> implies <code>https://identity.mozilla.com/apps/oldsync/bookmarks#read</code>.</li></ul><p>Invalid implications:</p><ul><li><code>profile:email:write</code> does <em>not</em> imply <code>profile</code>.</li><li><code>profile:email:write</code> does <em>not</em> imply <code>profile:write</code>.</li><li><code>profile:email</code> does <em>not</em> imply <code>profile:display_name</code>.</li><li><code>profilebogey</code> does <em>not</em> imply <code>profile</code>.</li><li><code>profile:write</code> does <em>not</em> imply <code>https://identity.mozilla.com/apps/oldsync</code>.</li><li><code>profile profile:email:write</code> does <em>not</em> imply <code>profile:write</code>.</li><li><code>https</code> does <em>not</em> imply <code>https://identity.mozilla.com/apps/oldsync</code>.</li><li><code>https://identity.mozilla.com/apps/oldsync</code> does <em>not</em> imply <code>profile</code>.</li><li><code>https://identity.mozilla.com/apps/oldsync#read</code> does <em>not</em> imply <code>https://identity.mozilla.com/apps/oldsync/bookmarks</code>.</li><li><code>https://identity.mozilla.com/apps/oldsync#write</code> does <em>not</em> imply <code>https://identity.mozilla.com/apps/oldsync/bookmarks#read</code>.</li><li><code>https://identity.mozilla.com/apps/oldsync/bookmarks</code> does <em>not</em> imply <code>https://identity.mozilla.com/apps/oldsync</code>.</li><li><code>https://identity.mozilla.com/apps/oldsync/bookmarks</code> does <em>not</em> imply <code>https://identity.mozilla.com/apps/oldsync/passwords</code>.</li><li><code>https://identity.mozilla.com/apps/oldsyncer</code> does <em>not</em> imply <code>https://identity.mozilla.com/apps/oldsync</code>.</li><li><code>https://identity.mozilla.com/apps/oldsync</code> does <em>not</em> imply <code>https://identity.mozilla.com/apps/oldsyncer</code>.</li><li><code>https://identity.mozilla.org/apps/oldsync</code> does <em>not</em> imply <code>https://identity.mozilla.com/apps/oldsync</code>.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pairwise-pseudonymous-identifiers">Pairwise Pseudonymous Identifiers<a href="#pairwise-pseudonymous-identifiers" class="hash-link" aria-label="Direct link to Pairwise Pseudonymous Identifiers" title="Direct link to Pairwise Pseudonymous Identifiers">​</a></h2><p>A Pairwise Pseudonymous Identifier (PPID) is defined in the <a href="https://openid.net/specs/oidc-core-1_0.html#Terminology" target="_blank" rel="noopener noreferrer">OpenID Connect Spec</a> as:</p><blockquote><p>Identifier that identifies the Entity to a Relying Party that cannot be correlated with the Entity&#x27;s PPID at another Relying Party.</p></blockquote><p>Put another way, PPIDs provide a single user with distinct userids across distinct Relying Parties (RPs), enhancing user privacy by preventing cross-site correlation based on userid.</p><p>By default, Firefox accounts provides the same userid to all Mozilla-internal RPs to facilitate cross service correlation. As Mozilla expands its product offering to include white labeled 3rd party services, we want to uphold Mozilla&#x27;s principles regarding user privacy by providing external services with only the minimal data necessary.</p><p>PPIDs allow Mozilla to enforce our privacy stance by providing each PPID enabled RP with a distinct userid for a given user. For example, a user that signs into 2 PPID enabled services would have 3 distinct userids:</p><ul><li>FxA userid, only seen by Mozilla properties</li><li>PPID for service 1, known by Mozilla and service 1</li><li>PPID for service 2, known by Mozilla and service 2</li></ul><p>PPIDs prevents service 1 and service 2 from correlating user data with each other based on userid alone. <em>PPIDs only prevent correlation based on userid</em>, transient information such as IP address, shared 3rd party cookies, and user-agent information can still be used by RPs to correlate users. This also assumes that RPs are unable to fetch user profile information such as email address and display name that could be used as additional data points.</p><p>PPIDs are returned as the <code>sub</code> claim within an <a href="https://openid.net/specs/openid-connect-core-1_0.html#IDToken" target="_blank" rel="noopener noreferrer">OIDC ID Token</a> or <a href="https://tools.ietf.org/html/draft-ietf-oauth-access-token-jwt" target="_blank" rel="noopener noreferrer">OAuth JWT Access Token</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="further-enhancing-privacy-through-ppid-rotation">Further enhancing privacy through PPID rotation<a href="#further-enhancing-privacy-through-ppid-rotation" class="hash-link" aria-label="Direct link to Further enhancing privacy through PPID rotation" title="Direct link to Further enhancing privacy through PPID rotation">​</a></h3><p>User privacy can be further enhanced by preventing long term profiles from being built for a given user through PPID rotation. Firefox accounts supports two methods of PPID rotation, RP initiated, and server initiated.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="rp-initiated-ppid-rotation">RP initiated PPID rotation<a href="#rp-initiated-ppid-rotation" class="hash-link" aria-label="Direct link to RP initiated PPID rotation" title="Direct link to RP initiated PPID rotation">​</a></h4><p>Any PPID enabled RP that receives JWT access tokens or OIDC ID tokens can initiate PPID rotation by specifying an additional parameter, <code>ppid_seed</code>, when requesting tokens from <code>/token</code> endpoints on the OAuth server. <code>ppid_seed</code> must be an integer between 0 and 1024, and can be rotated at any time.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="server-initiated-ppid-rotation">Server initiated PPID rotation<a href="#server-initiated-ppid-rotation" class="hash-link" aria-label="Direct link to Server initiated PPID rotation" title="Direct link to Server initiated PPID rotation">​</a></h4><p>By default, Firefox accounts does not enforce sub rotation, but for sensitive RPs where long term user profiles are undesirable, Firefox accounts can enforce periodic rotation without depending on the RP to pass in a <code>ppid_seed</code>. The default period is 6 hours.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ensuring-3rd-parties-are-unable-to-access-user-information">Ensuring 3rd parties are unable to access user information<a href="#ensuring-3rd-parties-are-unable-to-access-user-information" class="hash-link" aria-label="Direct link to Ensuring 3rd parties are unable to access user information" title="Direct link to Ensuring 3rd parties are unable to access user information">​</a></h3><p>An OAuth access token is a bearer token that can be presented by anyone to an OAuth service provider to access a protected resource. If a JWT access token contains a PPID <code>sub</code> claim that is meant to protect a user&#x27;s privacy, but is granted the <code>profile</code> scope allows the service provider to present the same access token to the FxA profile server and learn the user&#x27;s true identity. As such, tokens <em>MUST NOT</em> be requested with the <code>profile</code> scope or any of its implicants such as <code>profile:uid</code> or <code>profile:email</code>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ppids-and-logging">PPIDs and logging<a href="#ppids-and-logging" class="hash-link" aria-label="Direct link to PPIDs and logging" title="Direct link to PPIDs and logging">​</a></h2><p>PPIDs are not used by internal Mozilla properties and are not logged.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ppid-generation">PPID generation<a href="#ppid-generation" class="hash-link" aria-label="Direct link to PPID generation" title="Direct link to PPID generation">​</a></h3><p>PPIDs are generated using <a href="https://tools.ietf.org/html/rfc5869" target="_blank" rel="noopener noreferrer">HKDF</a> with the following inputs:</p><ul><li><strong>km</strong>: <code>client_id</code>.<code>userid_hex</code>.<code>ppid_seed||0</code>.<code>serverEnforcedRotationInput</code></li><li><strong>info</strong>: <code>oidc ppid sub</code></li><li><strong>salt</strong>: A secret configured by Ops</li><li><strong>len</strong>: 16 bytes, which leads to a 32 hex character result</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="server-enforced-rotation-input">Server enforced rotation input<a href="#server-enforced-rotation-input" class="hash-link" aria-label="Direct link to Server enforced rotation input" title="Direct link to Server enforced rotation input">​</a></h4><p>The server enforced rotation input defaults to the string <code>0</code>. If server enforced rotation is enabled for the client, it is calculated as follows:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">serverEnforcedRotationInput = Math.floor(Date.now() / ROTATION_PERIOD)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If an RP requests two tokens in short succession, their <code>sub</code> claims could be different if the first token was generated previous to the rotation epoch and the second after.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-future">The future<a href="#the-future" class="hash-link" aria-label="Direct link to The future" title="Direct link to The future">​</a></h3><p>Firefox accounts does not currently support <a href="https://openid.net/specs/openid-connect-core-1_0.html#PairwiseAlg" target="_blank" rel="noopener noreferrer">sector identifiers</a>. Sector identifiers allow multiple client_ids to receive the same PPID, this would be useful if the RP has applications on multiple platforms, e.g., an app on Android, iOS, and an addon in Firefox.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pkce-support">PKCE Support<a href="#pkce-support" class="hash-link" aria-label="Direct link to PKCE Support" title="Direct link to PKCE Support">​</a></h2><blockquote><p>Proof Key for Code Exchange by OAuth Public Clients</p></blockquote><p>Firefox Accounts OAuth flow supports the <a href="https://tools.ietf.org/html/rfc7636" target="_blank" rel="noopener noreferrer">PKCE RFC7636</a>.  This feature helps us authenticate clients such as WebExtensions and Native apps and any other clients that do not have a server component or a secure way to store a <code>client_secret</code>.</p><p>To better understand this protocol please read the <a href="https://www.authlete.com/documents/article/pkce/index" target="_blank" rel="noopener noreferrer">Proof Key for Code Exchange (RFC 7636) by Authlete Inc.</a>.</p><p>You&#x27;ll need to include support parameters <code>code_challenge_method</code>, <code>code_challenge</code> and <code>code_verifier</code>.</p><p>At this time Firefox Accounts requires you to use the <code>S256</code> flow, we do not support the <code>plain</code> code challenge method.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="promptnone-support">prompt=none support<a href="#promptnone-support" class="hash-link" aria-label="Direct link to prompt=none support" title="Direct link to prompt=none support">​</a></h2><p><code>prompt=none</code> enables authorized RPs to check a user&#x27;s authentication state and receive an OAuth grant or access token without requiring user interaction.</p><p>More formally, <code>prompt=none</code> is a flow described by the <a href="https://openid.net/specs/openid-connect-core-1_0.html" target="_blank" rel="noopener noreferrer">OpenID Connect spec</a> as:</p><blockquote><p>The Authorization Server MUST NOT display any authentication or consent user interface pages. An error is returned if an End-User is not already authenticated or the Client does not have pre-configured consent for the requested Claims or does not fulfill other conditions for processing the request. The error code will typically be login_required, interaction_required, or another code defined in Section 3.1.2.6. This can be used as a method to check for existing authentication and/or consent.</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="promptnone-usage-is-controlled">prompt=none usage is controlled<a href="#promptnone-usage-is-controlled" class="hash-link" aria-label="Direct link to prompt=none usage is controlled" title="Direct link to prompt=none usage is controlled">​</a></h3><p>Usage of <code>prompt=none</code> with <code>login_hint</code> / <code>email</code> is controlled to an authorized list of RPs, since
it bypasses the normal authorization flow and use could easily fall afoul of user expectations.</p><p>However, <em>all</em> RPs can check the user&#x27;s FxA login state using <code>id_token_hint</code>: since RPs not on the
authorized list can only obtain an <a href="https://openid.net/specs/openid-connect-core-1_0.html#IDToken" target="_blank" rel="noopener noreferrer">id_token</a> by
going through the normal authorization flow, it is safe to assume an RP presenting the <code>id_token</code>
as part of a <code>prompt=none</code> flow has already been granted authorization.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="requesting-promptnone-during-authorization">Requesting <code>prompt=none</code> during authorization<a href="#requesting-promptnone-during-authorization" class="hash-link" aria-label="Direct link to requesting-promptnone-during-authorization" title="Direct link to requesting-promptnone-during-authorization">​</a></h3><p><a href="/ecosystem-platform/api#tag/OAuth-Server-API-Overview/operation/getAuthorization"><code>prompt=none</code> and either <code>login_hint=&lt;email&gt;</code> or <code>id_token_hint=&lt;ID Token&gt;</code></a> are appended onto the query parameters when opening the <code>/authorization</code> endpoint.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">GET https://accounts.firefox.com/authorization?client_id=ea3ca969f8c6bb0d&amp;state=2sfas415FSSF@A5f&amp;scope=profile&amp;prompt=none&amp;login_hint=conscious.chooser%40mozilla.com</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If a different user is currently signed in to the email specified by the <code>login_hint</code> or <code>id_token_hint</code>, an <a href="#handling-errors"><code>account_selection_required</code> error will be returned</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="handling-errors">Handling errors<a href="#handling-errors" class="hash-link" aria-label="Direct link to Handling errors" title="Direct link to Handling errors">​</a></h3><p>Most <code>prompt=none</code> failures cause the user to be redirected back to the RP&#x27;s <code>redirectURI</code> with <code>state</code> and <code>error</code> query parameters.</p><p>The following is a table of <a href="https://openid.net/specs/openid-connect-core-1_0.html#AuthError" target="_blank" rel="noopener noreferrer">OIDC compliant error codes</a> <!-- -->→<!-- --> reasons</p><table><thead><tr><th>error</th><th>reason</th></tr></thead><tbody><tr><td><code>invalid_request</code></td><td>prompt=none is not enabled</td></tr><tr><td> </td><td>OR <code>login_hint</code> is missing</td></tr><tr><td> </td><td>OR scoped keys are requested</td></tr><tr><td> </td><td>OR the <code>id_token_hint</code> token is invalid</td></tr><tr><td><code>unauthorized_client</code></td><td>prompt=none is not enabled for the client</td></tr><tr><td><code>* interaction_required</code></td><td>account or session is not verified</td></tr><tr><td><code>* login_required</code></td><td>user is not signed in</td></tr><tr><td><code>* account_selection_required</code></td><td>a different user is signed in</td></tr></tbody></table><p><code>*</code> indicates the user must take some form of action to recover</p><p>As an example, suppose the <code>authorization</code> request from the previous section failed because the user is not signed in and assume the <code>redirectURI</code> for client <code>ea3ca969f8c6bb0d</code> is <code>https://service.firefox.com/oauth/complete</code>. The user would be redirected to:</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token constant" style="color:#36acaa">GET</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">https</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">firefox</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">oauth</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">complete</span><span class="token operator" style="color:#393A34">?</span><span class="token plain">state</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">2sfas415FSSF@</span><span class="token maybe-class-name">A5f</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">error</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">login_required</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="recovering-from-errors">Recovering from errors<a href="#recovering-from-errors" class="hash-link" aria-label="Direct link to Recovering from errors" title="Direct link to Recovering from errors">​</a></h4><p>At this point, the RP knows the user must authenticate to Firefox Accounts before OAuth codes or access tokens are returned. The RP can generate a new <code>state</code> and try again without the <code>prompt=none</code> query parameter:</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token constant" style="color:#36acaa">GET</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">https</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">accounts</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">firefox</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">authorization</span><span class="token operator" style="color:#393A34">?</span><span class="token plain">client_id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ea3ca969f8c6bb0d</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">state</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">gASDF</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">3df@</span><span class="token maybe-class-name">A5f</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">scope</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">profile</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">login_hint</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">conscious</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">chooser</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">40mozilla</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>When <code>prompt=none</code> is not specified, FxA handles <code>login_hint</code> as a suggestion, users are still able to authenticate/authorize using a different email. If the user specified in <code>login_hint</code> <em>MUST</em> be used, specify <a href="/ecosystem-platform/api#tag/OAuth-Server-API-Overview/operation/getAuthorization"><code>action=force_auth</code></a> when redirecting back to FxA.</p><p>If a different user is allowed to sign in, it may be necessary to clear locally held session state before redirecting back to FxA.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="handling-user-logout">Handling user logout<a href="#handling-user-logout" class="hash-link" aria-label="Direct link to Handling user logout" title="Direct link to Handling user logout">​</a></h3><p>Whenever the user terminates a session at the RP, any access and refresh tokens held by the RP for that session should be destroyed. Destroying the access and refresh tokens will ensure an entry for the session no longer appears in the <a href="https://accounts.firefox.com/settings#connected-services" target="_blank" rel="noopener noreferrer">Devices and Apps</a> list.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="destroying-an-access-token">Destroying an access token<a href="#destroying-an-access-token" class="hash-link" aria-label="Direct link to Destroying an access token" title="Direct link to Destroying an access token">​</a></h4><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token constant" style="color:#36acaa">POST</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">https</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">oauth</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">accounts</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">firefox</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v1</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">destroy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">access_token</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">access_token</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="destroying-a-refresh-token">Destroying a refresh token<a href="#destroying-a-refresh-token" class="hash-link" aria-label="Direct link to Destroying a refresh token" title="Direct link to Destroying a refresh token">​</a></h4><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token constant" style="color:#36acaa">POST</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">https</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">oauth</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">accounts</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">firefox</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v1</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">destroy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">refresh_token</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">refresh_token</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>More information on destroying tokens can be found on the <a href="/ecosystem-platform/api#tag/OAuth-Server-API-Overview/operation/postDestroy">OAuth server&#x27;s API docs</a>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="sso-logout">SSO logout<a href="#sso-logout" class="hash-link" aria-label="Direct link to SSO logout" title="Direct link to SSO logout">​</a></h4><p>Several concerns are noted, most importantly:</p><blockquote><p>...there&#x27;s potentially confusing behaviour around logging out of an FxA relier. If I use FxA to sign in to AMO, and then I sign out in AMO, I could reasonably expect to have to enter my password again if I want to sign back in. But we don&#x27;t have a way for AMO to signal back to FxA that the user signed out.</p></blockquote><p>This concern is not currently addressed as none of the <a href="https://medium.com/@robert.broeckelmann/openid-connect-logout-eccc73df758f" target="_blank" rel="noopener noreferrer">OIDC logout flows</a> are currently supported.</p><p>RPs can protect themselves a little bit here by not using <code>prompt=none</code> unless they still have a valid local login session for that user. If the users signs out of the RP, they will always see some UI when trying to sign back in, even if it&#x27;s just the &quot;Continue as X&quot; button rather than a password prompt.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="promptnone-and-security">prompt=none and security<a href="#promptnone-and-security" class="hash-link" aria-label="Direct link to prompt=none and security" title="Direct link to prompt=none and security">​</a></h3><p>For users that are already authenticated to Firefox Accounts, <code>prompt=none</code> bypasses the FxA authorization screen and redirects back to the RP without any user interaction. This behavior applies equally to users with 2FA enabled and could easily cause confusion with users. The Firefox Accounts team only enables the use of <code>prompt=none</code> for a service if both a good use case exists and the integration has been audited.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="future-directions">Future directions<a href="#future-directions" class="hash-link" aria-label="Direct link to Future directions" title="Direct link to Future directions">​</a></h3><p>Support for and OIDC RP Initiated Logout may go some way to reducing user confusion on what it means to sign out of an RP and whether they should have to enter their password again. Upon signing out of the RP, RPs that support the OIDC RP Initiated Logout protocol will redirect the user to FxA where they are given the option to destroy their FxA session as well.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="management-of-jwt-signing-keys">Management of JWT Signing Keys<a href="#management-of-jwt-signing-keys" class="hash-link" aria-label="Direct link to Management of JWT Signing Keys" title="Direct link to Management of JWT Signing Keys">​</a></h2><p>This server uses signed <a href="https://jwt.io/" target="_blank" rel="noopener noreferrer">JWTs</a> to represent various kinds of security token, including:</p><ul><li><code>id_token</code>s as defined by <a href="https://openid.net/specs/openid-connect-core-1_0.html" target="_blank" rel="noopener noreferrer">OpenID Connect</a></li><li><code>access_token</code>s as defined by <a href="https://datatracker.ietf.org/doc/draft-ietf-oauth-access-token-jwt/" target="_blank" rel="noopener noreferrer">JWT Profile for OAuth 2.0 Access
Tokens</a></li><li>Security Event Tokens as defined by <a href="https://tools.ietf.org/html/rfc8417" target="_blank" rel="noopener noreferrer">RFC8417</a></li></ul><p>RPs are expected to verify the signatures on these JWTs by fetching our public keys via the
<a href="https://openid.net/specs/openid-connect-discovery-1_0.html" target="_blank" rel="noopener noreferrer">OpenID Connect Discovery Protocol</a>,
which involves:</p><ol><li>Fetching our main OpenID metadata document at <a href="https://accounts.firefox.com/.well-known/openid-configuration" target="_blank" rel="noopener noreferrer">https://accounts.firefox.com/.well-known/openid-configuration</a></li><li>Extracting the contained <code>&quot;jwks_uri&quot;</code> entry</li><li>Fetching a <a href="https://tools.ietf.org/html/rfc7517" target="_blank" rel="noopener noreferrer">JWK Set</a> document from that URI</li><li>Respecting standard HTTP cache-control headers on those resources</li></ol><p>We thus have a coordination problem between this server and its RPs when it comes to changing our
JWT signing keys. Let <code>T_cache</code> be the max age in the cache-control headers of our metadata documents,
and <code>T_tokens</code> be the maximum lifetime of any token issued by this service. Then:</p><ul><li>We must advertise a new signing key in our JWK Set for at least <code>T_cache</code> seconds before we start
using it to sign tokens. If we don&#x27;t, RPs with a cached copy of our JWK Set may not know to trust
the new key, resulting in spurious verification failures and/or fragile logic to refresh the cached
copy on-demand when verification fails.</li><li>We must continue to advertise an old signing key in our JWK Set for at least <code>T_tokens</code> seconds
after we stop using it to sign tokens. If we don&#x27;t, RPs who refresh their cache of our JWK Set may
treat tokens signed with that key as invalid before they expire, resulting in spurious verification
failures.</li></ul><p>To help manage this, the server config has slots for three different keys, one required and the others
optional:</p><ul><li><code>openid.key</code>: The private key that is actively being used to sign tokens. This key is required.</li><li><code>openid.newKey</code>: A new private key that we intend to start using to sign tokens in the future.
This key is optional, but can be specified in order to start advertising it before use.</li><li><code>openid.oldKey</code>: The <em>public</em> component of a key we previously used to sign tokens. This key is
optional, but can be specified in order to continue advertising it while tokens bearing its signature
may be active.</li></ul><p>The procedure for rotating the active signing key is:</p><ul><li>Create the new signing key and configure it as <code>openid.newKey</code>, while leaving the existing <code>openid.key</code> intact.<ul><li>This can be performed using <code>../scripts/prepare-new-signing-key.js</code>.</li></ul></li><li>Deploy to all server instances, then wait for at least <code>T_cache</code> seconds plus some margin for clock error.</li><li>Take the public component of <code>openid.key</code> and configure it as <code>openid.oldKey</code>, then move <code>openid.newKey</code>
to <code>openid.key</code>.<ul><li>This can be performed using <code>../scripts/activate-new-signing-key.js</code>.</li></ul></li><li>Deploy to all server instances, then wait for at least <code>T_tokens</code> seconds plus some margin for clock error.</li><li>Remove <code>openid.oldKey</code> from the configuration.<ul><li>This can be performed using <code>../scripts/retire-old-signing-key.js</code>.</li></ul></li><li>Deploy to all server instances, then celebrate a job well done.</li></ul><p>This scheme keeps things fairly simple, but it also means that each key rotation event must be at least
<code>T_cache + T_tokens</code> seconds apart. If this proves to be a problem in practice, we could reduce the limit
to <code>T_cache</code> by keeping a <em>list</em> of old signing keys rather than a single key.</p><p>For our main production environment, secret keys are managed via <a href="https://github.com/mozilla/sops" target="_blank" rel="noopener noreferrer">SOPS</a>.
If you&#x27;re working in such an environment you can do this to extract the keys from SOPS into local files:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./scripts/sops-key-config.js extract path/to/encrypted/config.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then, after operating on them locally using the above key-rotation scripts, you can insert the modified
values back into SOPS via:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./scripts/sops-key-config.js insert path/to/encrypted/config.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/mozilla/ecosystem-platform/edit/master/docs/reference/oauth-details.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/ecosystem-platform/reference/mobile-specifics"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Mobile Specifics</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/ecosystem-platform/reference/rate-limiting"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Rate limiting</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#configuring-oauth-clients" class="table-of-contents__link toc-highlight">Configuring OAuth clients</a><ul><li><a href="#how-to-register-a-client-manually" class="table-of-contents__link toc-highlight">How to register a client manually</a></li><li><a href="#difference-between-same-site-and-external-consumers" class="table-of-contents__link toc-highlight">Difference between same site and external consumers</a></li><li><a href="#installing-a-new-consumer" class="table-of-contents__link toc-highlight">Installing a new consumer</a></li></ul></li><li><a href="#oauth-scopes" class="table-of-contents__link toc-highlight">OAuth Scopes</a><ul><li><a href="#short-name-scope-values" class="table-of-contents__link toc-highlight">Short-name scope values</a></li><li><a href="#url-scopes" class="table-of-contents__link toc-highlight">URL Scopes</a></li><li><a href="#scope-matching-and-implication" class="table-of-contents__link toc-highlight">Scope Matching and Implication</a></li></ul></li><li><a href="#pairwise-pseudonymous-identifiers" class="table-of-contents__link toc-highlight">Pairwise Pseudonymous Identifiers</a><ul><li><a href="#further-enhancing-privacy-through-ppid-rotation" class="table-of-contents__link toc-highlight">Further enhancing privacy through PPID rotation</a></li><li><a href="#ensuring-3rd-parties-are-unable-to-access-user-information" class="table-of-contents__link toc-highlight">Ensuring 3rd parties are unable to access user information</a></li></ul></li><li><a href="#ppids-and-logging" class="table-of-contents__link toc-highlight">PPIDs and logging</a><ul><li><a href="#ppid-generation" class="table-of-contents__link toc-highlight">PPID generation</a></li><li><a href="#the-future" class="table-of-contents__link toc-highlight">The future</a></li></ul></li><li><a href="#pkce-support" class="table-of-contents__link toc-highlight">PKCE Support</a></li><li><a href="#promptnone-support" class="table-of-contents__link toc-highlight">prompt=none support</a><ul><li><a href="#promptnone-usage-is-controlled" class="table-of-contents__link toc-highlight">prompt=none usage is controlled</a></li><li><a href="#requesting-promptnone-during-authorization" class="table-of-contents__link toc-highlight">Requesting <code>prompt=none</code> during authorization</a></li><li><a href="#handling-errors" class="table-of-contents__link toc-highlight">Handling errors</a></li><li><a href="#handling-user-logout" class="table-of-contents__link toc-highlight">Handling user logout</a></li><li><a href="#promptnone-and-security" class="table-of-contents__link toc-highlight">prompt=none and security</a></li><li><a href="#future-directions" class="table-of-contents__link toc-highlight">Future directions</a></li></ul></li><li><a href="#management-of-jwt-signing-keys" class="table-of-contents__link toc-highlight">Management of JWT Signing Keys</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Mozilla Corporation.</div></div></div></footer></div>
<script src="/ecosystem-platform/assets/js/runtime~main.10caca44.js"></script>
<script src="/ecosystem-platform/assets/js/main.9ad73f97.js"></script>
</body>
</html>