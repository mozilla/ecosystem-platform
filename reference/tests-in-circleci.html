<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-reference/tests-in-circleci">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">Tests in CircleCI | Firefox Ecosystem Platform</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://mozilla.github.io/ecosystem-platform/reference/tests-in-circleci"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Tests in CircleCI | Firefox Ecosystem Platform"><meta data-rh="true" name="description" content="Last Updated: 2022-01-19"><meta data-rh="true" property="og:description" content="Last Updated: 2022-01-19"><link data-rh="true" rel="icon" href="/ecosystem-platform/img/firefox-logo.png"><link data-rh="true" rel="canonical" href="https://mozilla.github.io/ecosystem-platform/reference/tests-in-circleci"><link data-rh="true" rel="alternate" href="https://mozilla.github.io/ecosystem-platform/reference/tests-in-circleci" hreflang="en"><link data-rh="true" rel="alternate" href="https://mozilla.github.io/ecosystem-platform/reference/tests-in-circleci" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://RFM5H13DFK-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Firefox Ecosystem Platform" href="/ecosystem-platform/opensearch.xml"><link rel="stylesheet" href="/ecosystem-platform/assets/css/styles.d6503546.css">
<link rel="preload" href="/ecosystem-platform/assets/js/runtime~main.2e2aa43b.js" as="script">
<link rel="preload" href="/ecosystem-platform/assets/js/main.abb29e55.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/ecosystem-platform/"><div class="navbar__logo"><img src="/ecosystem-platform/img/firefox-logo.png" alt="Ecosystem Platform Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/ecosystem-platform/img/firefox-logo.png" alt="Ecosystem Platform Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Firefox Ecosystem Platform</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/mozilla/ecosystem-platform" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ecosystem-platform/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">For Relying Parties</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/relying-parties/tutorials/integration-with-fxa">Tutorials</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/relying-parties/how-twos/end-to-end-encryption">How-to Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/relying-parties/reference/metrics-for-relying-parties">Reference</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active">For FxA Engineers</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/tutorials/development-setup">Tutorials</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/how-tos/creating-an-account-locally">How-to Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/ecosystem-platform/reference/team-processes/development-process">Reference</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/reference/team-processes/development-process">Team Processes</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/reference/style-guides/general-best-practices">Style Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/ecosystem-platform/reference/tests-in-circleci">CI and Test Automation</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/ecosystem-platform/reference/tests-in-circleci">Tests in CircleCI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/functional-testing">Functional Tests</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/automation-testplan">Automation Test Plan</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/continuous-integration-for-monorepos">Continuous Integration for Monorepos</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/customs-api">⚙️ Customs API Reference</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/browser-support">Browser Support</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/incident-response">Incident Response</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/emails">Emails</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/localization">Localization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/metrics">Metrics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/token-types">Types of Auth Tokens</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/jwt-access-tokens">JWT Access Tokens</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/storybook-deploys-with-circleci">Storybook Deploys with CircleCI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/webchannels-in-firefox-desktop-fennec">WebChannels in Firefox Desktop &amp; Fennec</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/webchannels-in-fenix-webextensions">WebChannels in Fenix &amp; WebExtensions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/internal-api-documentation">Internal API Documentation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/experiments-ab-testing">Experiments &amp; A/B Testing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/system-diagrams">System Diagrams</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/application-logging">Application Logging</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/application-tracing">Application Tracing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/scheduled-maintenance">Scheduled Maintenance</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/mobile-specifics">Mobile Specifics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/architectural-decision-records">Architectural Decision Records</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/github-strategies">GitHub Strategies</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/third-party-authentication">Third Party Authentication in FxA</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/rate-limiting">Rate limiting</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/using-swagger-for-api-documentation">Using Swagger for API documentation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a href="https://docs.telemetry.mozilla.org/datasets/fxa.html" target="_blank" rel="noopener noreferrer" class="menu__link menuExternalLink_NmtK" tabindex="0">Telemetry Data Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/explanation/metrics">Explanation</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/additional-docs">Additional Docs</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">For Support Agents</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/reference/admin-panel">Reference</a></div></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/ecosystem-platform/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">For FxA Engineers</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Reference</span><meta itemprop="position" content="2"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">CI and Test Automation</span><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Tests in CircleCI</span><meta itemprop="position" content="4"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Tests in CircleCI</h1></header><p>Last Updated: 2022-01-19</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a class="hash-link" href="#overview" title="Direct link to heading">​</a></h2><p>The FxA team works mostly within a monolithic git repository. This is broken up into many packages, where each package tends to be a microservice or library shared between other packages.</p><p>CircleCI is a service used by FxA to automatically run tests across all packages for every pull request, branch push, and commit tag on GitHub. Scripts and configuration for CircleCI mostly live in the <code>.circleci</code> directory.</p><p>Though there are exceptions on a per-package basis, the following things tend to be true:</p><ul><li><p>We use Docker to build containers within which tests are run, as well as build artifacts for each package.</p></li><li><p>The <code>test</code> workflow runs for every commit to a pull request, branch, or tag. This workflow performs build, test, and deploy steps across all packages.</p></li><li><p>The <code>deploy-tag</code> workflow runs for every <strong>tagged</strong> commit. This workflow skips tests, performing build &amp; deploy steps across all packages.</p></li><li><p>Each package can provide a <code>Dockerfile-test</code> file. From this, a container will be built in which <code>npm run test</code> will be executed. A successful exit status is considered a passing test run.</p></li><li><p>Each package can provide a <code>Dockerfile</code> or <code>Dockerfile-build</code> file. This will be used to build a Docker image for deployment to Docker Hub. It should be very similar to <code>Dockerfile-test</code> - but it can omit steps &amp; dependencies used only for testing.</p></li><li><p>Commits to <code>main</code> branch result in image deployments to Docker Hub for each package, using the <code>latest</code> tag.</p></li><li><p>Commits to branches prefixed with <code>feature</code> or <code>dockerpush</code> also result in images pushed to Docker Hub - in this case, the branch name is used as the Docker tag.</p></li><li><p>Commits tagged with <code>git tag</code> or via GitHub trigger deployments of images to Docker Hub. Here, the git tag is used as the Docker tag.</p></li></ul><p>Again, there are exceptions to all the above. The rest of this document will go into detail on the workflows, jobs, scripts, and important files that make up CircleCI testing - and more importantly attempt to highlight the exceptions and per-package customizations.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="workflows">Workflows<a class="hash-link" href="#workflows" title="Direct link to heading">​</a></h2><p>A <a href="https://circleci.com/docs/2.0/workflows/" target="_blank" rel="noopener noreferrer">workflow in CircleCI</a> is described like so:</p><blockquote><p>a set of rules for defining a collection of jobs and their run order. Workflows support complex job orchestration using a simple set of configuration keys</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="test">test<a class="hash-link" href="#test" title="Direct link to heading">​</a></h3><p>This workflow gets run on all commits for all pull requests, branches, and tags.</p><p>All steps in the workflow depends on <a href="#install">the <code>install</code> job</a>, so that gets run first.</p><p>After <code>install</code>, <a href="#build-module">the <code>build-module</code> job</a> is run in parallel for most packages - <a href="https://github.com/mozilla/fxa/blob/main/.circleci/config.yml#L257" target="_blank" rel="noopener noreferrer">check <code>.circleci/config.yml</code> for an up-to-date list</a>. This shared job handles the work of building Docker containers with <code>Dockerfile-test</code> &amp; <code>Dockerfile-build</code>, running tests, and deploying images.</p><p>Some packages do not use <code>build-module</code> - these each use customized jobs:</p><ul><li><a href="#fxa-content-server"><code>fxa-content-server</code></a><ul><li><a href="#build-and-deploy-content-server"><code>build-and-deploy-content-server</code></a></li></ul></li><li><a href="#fxa-shared"><code>fxa-shared</code></a></li><li><a href="#js-client"><code>js-client</code></a></li><li><a href="#fxa-oauth-server"><code>fxa-oauth-server</code></a></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-tag">deploy-tag<a class="hash-link" href="#deploy-tag" title="Direct link to heading">​</a></h3><p>The jobs specified in this workflow only run for tags.</p><p>All steps in the workflow depends on <a href="#install">the <code>install</code> job</a>, so that gets run first.</p><p>Then, <a href="#deploy-module">the shared <code>deploy-module</code> job</a> is run in parallel for most packages - <a href="https://github.com/mozilla/fxa/blob/main/.circleci/config.yml#L355" target="_blank" rel="noopener noreferrer">check <code>.circleci/config.yml</code> for an up-to-date list</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="jobs">Jobs<a class="hash-link" href="#jobs" title="Direct link to heading">​</a></h2><p>Jobs are the individual build tasks performed by CircleCI. They&#x27;re orchestrated in <a href="#workflows">workflows</a>, where they can be run in parallel and/or made dependent on each other. The results of one job can also feed into another.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="install">install<a class="hash-link" href="#install" title="Direct link to heading">​</a></h3><p>Common installation and setup for all other jobs.</p><p>Checks out the project code into the default working directory <code>~/project</code>. Runs <code>npm ci</code> in the root of the project.</p><p>Creates <code>packages/version.json</code> based on CircleCI env vars to describe the hash, version, source, and build URL of the current run. This <code>version.json</code> will also be stored as a <a href="https://circleci.com/docs/2.0/artifacts/" target="_blank" rel="noopener noreferrer">build artifact</a> with the test run.</p><p>Also runs <a href="#circleci-modules-to-testjs"><code>.circleci/modules-to-test.js</code></a> and outputs to <code>packages/test.list</code> as a selection of which packages&#x27; tests should be run.</p><p>Finally, the <code>install</code> job uses <a href="https://circleci.com/docs/2.0/configuration-reference/#persist_to_workspace" target="_blank" rel="noopener noreferrer"><code>persist_to_workspace</code></a> to copy the <code>~/project</code> directory to a shared workspace that will be copied into the filesystem for each following job via <a href="https://circleci.com/docs/2.0/configuration-reference/#attach_workspace" target="_blank" rel="noopener noreferrer"><code>attach_workspace</code></a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="build-module">build-module<a class="hash-link" href="#build-module" title="Direct link to heading">​</a></h3><p>Common task used by many modules in the <code>test</code> workflow to build, test, and deploy. It takes three parameters:</p><ul><li><code>module</code> - string, name of the package to build</li><li><code>test</code> - string, default: <code>test</code>, can be used to run a different NPM script rather than <code>npm run test</code></li><li><code>db</code> - boolean, default: false</li></ul><p>Working directory is set to <code>~/project/packages/{module}</code>. Attaches to the shared workspace. Sets up remote Docker environment for building containers.</p><p>If the <code>db</code> parameter is true, it starts up containers for mysql, memcached, redis, and firestore.</p><p>Finally, it runs <a href="#circleci-build-test-deploysh"><code>.circleci/build-test-deploy.sh {test}</code></a>. This runs the build, test, and deploy scripts for the module in the current working directory.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-module">deploy-module<a class="hash-link" href="#deploy-module" title="Direct link to heading">​</a></h3><p>Common task used by many modules in <a href="#deploy-tag">the <code>deploy-tag</code> workflow</a> to build &amp; deploy images without running tests. Takes one parameter:</p><ul><li><code>module</code> - string</li></ul><p>Working directory is set to <code>~/project/packages/{module}</code>. Attaches to the shared workspace. Sets up remote Docker environment for building containers.</p><p>Runs <a href="#circleci-buildsh"><code>.circleci/build.sh {module}</code></a> to build a Docker container. Then, runs <a href="#circleci-deploysh"><code>.circleci/deploy.sh {module}</code></a> to deploy the container to Docker Hub.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fxa-content-server">fxa-content-server<a class="hash-link" href="#fxa-content-server" title="Direct link to heading">​</a></h3><p>Testing fxa-content-server is very complex and heavy in resource usage. Though this is a single job, it is spread across several parallel container nodes in CircleCI (currently <code>parallelism: 6</code>).</p><p>Each container is prepared with <a href="#circleci-install-content-serversh"><code>.circleci/install-content-server.sh</code></a> and then the tests are run with <a href="#circleci-test-content-serversh"><code>.circleci/test-content-server.sh</code></a>. These scripts split up which tests are run depending on the <code>$CIRCLE_NODE_INDEX</code> env variable, which varies depending the parallel container node running the script.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="build-and-deploy-content-server">build-and-deploy-content-server<a class="hash-link" href="#build-and-deploy-content-server" title="Direct link to heading">​</a></h3><p>Since <a href="#fxa-content-server">the <code>fxa-content-server</code> job</a> uses a custom parallel scheme to run tests, building a Docker container image is not useful for many runs like pull requests.</p><p>So, we split those tasks into the <code>build-and-deploy-content-server</code> job, which is only executed for <code>main</code> branch and branch names prefixed by <code>feature.</code> and <code>dockerpush.</code></p><p>This is done by running <a href="#circleci-install-content-serversh"><code>.circleci/install-content-server.sh</code></a>, followed by <a href="#circleci-buildsh"><code>.circleci/build.sh fxa-content-server</code></a> and <a href="#circleci-deploysh"><code>.circleci/deploy.sh fxa-content-server</code></a>.</p><p>(Unlike other modules, the <code>test.sh</code> script is not run here, since the <code>fxa-content-server</code> job already took care of it.)</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fxa-shared">fxa-shared<a class="hash-link" href="#fxa-shared" title="Direct link to heading">​</a></h3><p>Custom task for fxa-shared package. It runs lint and test directly on the CircleCI host node - rather than building a Docker container for running tests.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="docs">docs<a class="hash-link" href="#docs" title="Direct link to heading">​</a></h3><p>Custom task for building and publishing documentation. Runs <code>_scripts/gh-pages.sh</code> - but only on main branch in the main project repo.</p><p>This requires SSH keys that enable CircleCI to commit to the <code>gh-page</code> on the main repo, so the script will be skipped if those keys are unavailable.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="important-scripts--files">Important scripts &amp; files<a class="hash-link" href="#important-scripts--files" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="packagesfxa-circlecidockerfile">packages/fxa-circleci/Dockerfile<a class="hash-link" href="#packagesfxa-circlecidockerfile" title="Direct link to heading">​</a></h3><p>This is the base Dockerfile for the container used by most jobs. It includes most of the dependencies commonly used by all other packages. This includes a version of Firefox for Linux for integration tests - check the Dockerfile for the current version (68.0 as of this writing). Rust and Cargo are also included.</p><p><strong>Note:</strong> If you commit an update to this Dockerfile, try not to include changes to other parts of the project in the same Pull Request. Other jobs in the same test run are likely to lag behind and use the previous version of the fxa-circleci container, because the current test run will not have had a chance to finish deploying the new image.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="circleciconfigyml">.circleci/config.yml<a class="hash-link" href="#circleciconfigyml" title="Direct link to heading">​</a></h3><p>Contains general configuration, job definitions, and workflows orchestrating all the jobs.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="circlecimodules-to-testjs">.circleci/modules-to-test.js<a class="hash-link" href="#circlecimodules-to-testjs" title="Direct link to heading">​</a></h3><p>Running all tests across all modules / packages in FxA can be time-comsuming. Time can be saved by skipping tests that we know are unrelated to changes in some given commit. Applying that logic, this script outputs a name of individual packages that should be tested - or <code>all</code> if it decides that everything needs to be run.</p><p>For main branch and other non-PR commits, the output is always <code>all</code>.</p><p>For pull requests, the script fetches and parses the diff for the current PR. The URL for the diff is constructed from CircleCI env vars.</p><p>If there&#x27;s an error while fetching or parsing the diff, <code>all</code> is output. Otherwise, the script checks the path of each file changed to build a list of modules for testing.</p><p>Some modules depend on other modules. Dependencies that resolve to <code>workspace:*</code> are added recursively to the list of modules to test.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="circlecibuild-test-deploysh">.circleci/build-test-deploy.sh<a class="hash-link" href="#circlecibuild-test-deploysh" title="Direct link to heading">​</a></h3><p>Runs <code>build.sh</code>, <code>test.sh</code>, and <code>deploy.sh</code> for a given package - deriving the package name from the current working directory. Passes along the first parameter as the second parameter in <code>test.sh</code> - which specifies a different NPM script to run besides the default <code>npm run test</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="circlecibuildsh">.circleci/build.sh<a class="hash-link" href="#circlecibuildsh" title="Direct link to heading">​</a></h3><p>Common build script for most modules.</p><p>Logic for running or skipping build for a given module is implemented here: <code>packages/test.list</code> is expected to contain a list output from <code>modules-to-test.js</code> - if the current module&#x27;s name is missing and the list isn&#x27;t <code>all</code>, this script will exit immediately.</p><p>Parameters are just <code>$1</code> for the name of the module being tested.</p><p>The file <code>packages/version.json</code> is expected to have been generated earlier - i.e. from the <code>install</code> job in CircleCI. This file is copied into the package.</p><p>For modules where <code>Dockerfile</code> is present, a container tagged <code>{MODULE}:build</code> is built from <code>Dockerfile</code>.</p><p>For modules where <code>Dockerfile-build</code> is present, the container is built from that file instead.</p><p>There are exceptions for <code>fxa-auth-server</code>, <code>fxa-content-server</code>, and <code>fxa-payments-server</code>: For each of these modules, the Docker build is performed in the <code>packages</code> parent directory. This is because each of these modules depends on files from other packages (e.g. <code>fxa-shared</code>) and Docker will not allow <code>../</code> path references outside the base directory for the container build.</p><p>Finally, <code>fxa-auth-server</code> executes <code>_scripts/clone-authdb.sh</code> in order to set up the correct database interface for the server. (TKTK?)</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="circlecitestsh">.circleci/test.sh<a class="hash-link" href="#circlecitestsh" title="Direct link to heading">​</a></h3><p>Common script that runs tests for most modules.</p><p>Parameters are <code>$1</code> the name of the module being tested and <code>$2</code> the name of an npm script that executes tests (defaults to <code>test</code> if omitted).</p><p>Logic for running or skipping tests for a given module is implemented here: <code>packages/test.list</code> is expected to contain a list output from <code>modules-to-test.js</code> - if the current module&#x27;s name is missing and the list isn&#x27;t <code>all</code>, this script will exit immediately.</p><p>For most modules: if <code>Dockerfile-test</code> is present, it&#x27;s used to build a Docker container.</p><p>The container is tagged <code>${MODULE}:test</code>, where <code>MODULE</code> is named in the first parameter of the script. Then, <code>npm run test</code> is run within the container - the name of the npm script can be customized with the second parameter of <code>test.sh</code>.</p><p>If <code>eslint</code> or <code>tslint</code> is present in the module&#x27;s <code>package.json</code>, then <code>npm run lint</code> is also run in the container. If there&#x27;s a <code>Gruntfile.js</code> that contains <code>eslint</code>, then <code>grunt eslint</code> will be run in the container.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="circlecideploysh">.circleci/deploy.sh<a class="hash-link" href="#circlecideploysh" title="Direct link to heading">​</a></h3><p>Common script for deploying the Docker container built from an FxA package to Docker Hub.</p><p>The basic gist of this script is that it takes a <code>{MODULE}:build</code> container - e.g. as created via <code>build.sh</code> - and re-tags it as appropriate for the current CI run before pushing it to Docker Hub.</p><p>These images are deployed to Mozilla&#x27;s Docker Hub account. So, for example, many modules can be found with a search for <a href="https://hub.docker.com/search?q=mozilla%2Ffxa-&amp;type=image" target="_blank" rel="noopener noreferrer"><code>mozilla/fxa-</code></a>. Also look for images such as <a href="https://hub.docker.com/r/mozilla/123done" target="_blank" rel="noopener noreferrer"><code>mozilla/123done</code></a> and <a href="https://hub.docker.com/r/mozilla/browserid-verifier" target="_blank" rel="noopener noreferrer"><code>mozilla/browserid-verifier</code></a>, which are listed under <code>packages</code> but do not follow the <code>fxa-*</code> naming convention.</p><p>The rest of the tag name depends on a few other conditions:</p><p>If the build is on <code>main</code> branch, then the tag will be <code>{MODULE}:latest</code>.</p><p>If a build is tagged in Git, then that Git tag is used - i.e. <code>{MODULE}:{GIT_TAG_NAME}</code>.</p><p>If a build is on a branch with a name prefixed with <code>feature</code> or <code>dockerpush</code>, that branch name will be used in the tag - i.e. <code>{MODULE}:{GIT_BRANCH_NAME}</code>.</p><p>It&#x27;s also possible to supply <code>$MODULE_SUFFIX</code> env var tweak the Docker Hub repo name - i.e. <code>mozilla/$MODULE-$MODULE_SUFFIX</code>.</p><p>Untagged commits or commits on branches that do fall into one of the above cases do not result in a container deployed to Docker Hub.</p><p>Logic for running or skipping deployment for a given module is also implemented here: <code>packages/test.list</code> is expected to contain a list output from <code>modules-to-test.js</code> - if the current module&#x27;s name is missing and the list isn&#x27;t <code>all</code>, this script will exit immediately.</p><p>TBD:</p><ul><li>describe how content-server tests are run</li><li>how tests are split up between parallel CircleCI nodes</li><li>how integration tests work with intern</li><li>pairing tests are run separately</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/mozilla/ecosystem-platform/edit/master/docs/reference/tests-in-circleci.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/ecosystem-platform/reference/style-guides/node-style-guide"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Node Style Guide</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/ecosystem-platform/reference/functional-testing"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Functional Tests</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#workflows" class="table-of-contents__link toc-highlight">Workflows</a><ul><li><a href="#test" class="table-of-contents__link toc-highlight">test</a></li><li><a href="#deploy-tag" class="table-of-contents__link toc-highlight">deploy-tag</a></li></ul></li><li><a href="#jobs" class="table-of-contents__link toc-highlight">Jobs</a><ul><li><a href="#install" class="table-of-contents__link toc-highlight">install</a></li><li><a href="#build-module" class="table-of-contents__link toc-highlight">build-module</a></li><li><a href="#deploy-module" class="table-of-contents__link toc-highlight">deploy-module</a></li><li><a href="#fxa-content-server" class="table-of-contents__link toc-highlight">fxa-content-server</a></li><li><a href="#build-and-deploy-content-server" class="table-of-contents__link toc-highlight">build-and-deploy-content-server</a></li><li><a href="#fxa-shared" class="table-of-contents__link toc-highlight">fxa-shared</a></li><li><a href="#docs" class="table-of-contents__link toc-highlight">docs</a></li></ul></li><li><a href="#important-scripts--files" class="table-of-contents__link toc-highlight">Important scripts &amp; files</a><ul><li><a href="#packagesfxa-circlecidockerfile" class="table-of-contents__link toc-highlight">packages/fxa-circleci/Dockerfile</a></li><li><a href="#circleciconfigyml" class="table-of-contents__link toc-highlight">.circleci/config.yml</a></li><li><a href="#circlecimodules-to-testjs" class="table-of-contents__link toc-highlight">.circleci/modules-to-test.js</a></li><li><a href="#circlecibuild-test-deploysh" class="table-of-contents__link toc-highlight">.circleci/build-test-deploy.sh</a></li><li><a href="#circlecibuildsh" class="table-of-contents__link toc-highlight">.circleci/build.sh</a></li><li><a href="#circlecitestsh" class="table-of-contents__link toc-highlight">.circleci/test.sh</a></li><li><a href="#circlecideploysh" class="table-of-contents__link toc-highlight">.circleci/deploy.sh</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Mozilla Corporation.</div></div></div></footer></div>
<script src="/ecosystem-platform/assets/js/runtime~main.2e2aa43b.js"></script>
<script src="/ecosystem-platform/assets/js/main.abb29e55.js"></script>
</body>
</html>