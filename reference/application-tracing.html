<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-reference/application-tracing" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">Application Tracing | Firefox Ecosystem Platform</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://mozilla.github.io/ecosystem-platform/reference/application-tracing"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Application Tracing | Firefox Ecosystem Platform"><meta data-rh="true" name="description" content="Distributed tracing allows developers to investigate how data flows between various parts of the application. At a high level a trace is just a series of events called spans that represent the timings and state of various operations. When properly implemented, tracing should let a developer visualize the data flowing between services, starting with a request at the client and flowing all the way to the database layer, or third party APIs, and back. Tracing can be useful for finding inefficiencies or errors in code that might otherwise be unrecognized or be difficult to track down."><meta data-rh="true" property="og:description" content="Distributed tracing allows developers to investigate how data flows between various parts of the application. At a high level a trace is just a series of events called spans that represent the timings and state of various operations. When properly implemented, tracing should let a developer visualize the data flowing between services, starting with a request at the client and flowing all the way to the database layer, or third party APIs, and back. Tracing can be useful for finding inefficiencies or errors in code that might otherwise be unrecognized or be difficult to track down."><link data-rh="true" rel="icon" href="/ecosystem-platform/img/firefox-logo.png"><link data-rh="true" rel="canonical" href="https://mozilla.github.io/ecosystem-platform/reference/application-tracing"><link data-rh="true" rel="alternate" href="https://mozilla.github.io/ecosystem-platform/reference/application-tracing" hreflang="en"><link data-rh="true" rel="alternate" href="https://mozilla.github.io/ecosystem-platform/reference/application-tracing" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://RFM5H13DFK-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Firefox Ecosystem Platform" href="/ecosystem-platform/opensearch.xml"><link rel="stylesheet" href="/ecosystem-platform/assets/css/styles.90d727cc.css">
<script src="/ecosystem-platform/assets/js/runtime~main.9bd73b38.js" defer="defer"></script>
<script src="/ecosystem-platform/assets/js/main.ca1f48d4.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/ecosystem-platform/"><div class="navbar__logo"><img src="/ecosystem-platform/img/firefox-logo.png" alt="Ecosystem Platform Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/ecosystem-platform/img/firefox-logo.png" alt="Ecosystem Platform Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Firefox Ecosystem Platform</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/mozilla/ecosystem-platform" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ecosystem-platform/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">For Relying Parties</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/relying-parties/tutorials/integration-with-fxa">Tutorials</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/relying-parties/how-tos/end-to-end-encryption">How-to Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/relying-parties/reference/integration-requirements">Reference</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active">For FxA Engineers</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/tutorials/development-setup">Tutorials</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/how-tos/ci-guidelines">How-to Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/ecosystem-platform/reference/team-processes/development-process">Reference</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/reference/team-processes/development-process">Team Processes</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/reference/style-guides/node-style-guide">Style Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/reference/tests-in-circleci">CI and Test Automation</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/application-logging">Application Logging</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/ecosystem-platform/reference/application-tracing">Application Tracing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/browser-support">Browser Support</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/customs-api">⚙️ Customs API Reference</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/database-structure">Database Structure</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/emails">Emails</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/experiments-ab-testing">Experiments &amp; A/B Testing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/github-strategies">GitHub Strategies</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/incident-response">Incident Response</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/localization">Localization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/metrics">Metrics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/mobile-specifics">Mobile Specifics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/npm-scripts-and-nx">NPM / NX Guidelines</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/oauth-details">OAuth Details</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/rate-limiting">Rate limiting</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/storybook-deploys-with-circleci">Storybook Deploys with CircleCI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/system-diagrams">System Diagrams</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/third-party-authentication">Third Party Authentication</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/tokens">Tokens</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/webchannels">WebChannels</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a href="https://docs.telemetry.mozilla.org/datasets/fxa.html" target="_blank" rel="noopener noreferrer" class="menu__link menuExternalLink_NmtK" tabindex="0">Telemetry Data Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/explanation/architectural-decision-records">Explanation</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/additional-docs">Additional Docs</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">For Support Agents</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/reference/admin-panel">Reference</a></div></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/ecosystem-platform/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">For FxA Engineers</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Reference</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Application Tracing</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Distributed Application Tracing</h1>
<p>Distributed tracing allows developers to investigate how data flows between various parts of the application. At a high level a trace is just a series of events called spans that represent the timings and state of various operations. When properly implemented, tracing should let a developer visualize the data flowing between services, starting with a request at the client and flowing all the way to the database layer, or third party APIs, and back. Tracing can be useful for finding inefficiencies or errors in code that might otherwise be unrecognized or be difficult to track down.</p>
<p>We utilize <a href="https://opentelemetry.io/" target="_blank" rel="noopener noreferrer">Open Telemetry</a> to instrument our servers, collect, and export trace data. Open telemetry allows tracing to be fairly agnostic. Rather than implement a specific tracing solution, e.g. sentry tracing, a developer adds open telemetry and then configures it to export to various targets. It’s also good to note that open telemetry supports more than just traces. In theory we could also use it to capture metrics and logs and then export them accordingly. However, at the time of writing this document, open telemetry is only being used for tracing.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="system-diagrams">System Diagrams<a href="#system-diagrams" class="hash-link" aria-label="Direct link to System Diagrams" title="Direct link to System Diagrams">​</a></h2>
<p>Here is a general system diagram taken from open telemetry’s website. As you can see various services, infrastructure, and clients are being instrumented. Spans and traces are being collected and sent to a collector service which then pushes them to a database for later viewing.</p>
<p><img loading="lazy" alt="otel system diagram" src="/ecosystem-platform/assets/images/fxa-otel-system-diagram-3751506741c3b8c0b7e166136d5f52ea.png" title="image_tooltip" width="622" height="407" class="img_ev3q"></p>
<p>And for a more general FxA view on this. Here’s a diagram showing how traces flow from clients and services to the collector, and are then directed to either jaeger for local development or google cloud trace for stage / production.</p>
<p><img loading="lazy" alt="otel system diagram" src="/ecosystem-platform/assets/images/fxa-tracing-system-diagram-ebcfc4009389dbc75a8843a635f52049.png" title="image_tooltip" width="622" height="407" class="img_ev3q"></p>
<p><em>Dotted lines represent interservice communication and yellow lines represent exported trace data.</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="terminology-of-application-tracing">Terminology of Application Tracing<a href="#terminology-of-application-tracing" class="hash-link" aria-label="Direct link to Terminology of Application Tracing" title="Direct link to Terminology of Application Tracing">​</a></h2>
<p>Once some of the basic terminology for tracing is known it becomes quite approachable. Here’s a quick run down of key terms that are particularly useful for understanding tracing in FxA’s implementation. A full glossary can be found <a href="https://opentelemetry.io/docs/concepts/glossary/" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tooling">Tooling<a href="#tooling" class="hash-link" aria-label="Direct link to Tooling" title="Direct link to Tooling">​</a></h3>
<p>These are the software tools we use to trace. You&#x27;ll see these get referenced a lot.</p>
<p><strong><a href="https://opentelemetry.io/" target="_blank" rel="noopener noreferrer">Open Telemetry</a></strong> - SDKs and APIs used to add distributed tracing to our applications. This provides auto instrumentation, and exports traces to various targets.</p>
<p><strong><a href="https://cloud.google.com/trace" target="_blank" rel="noopener noreferrer">Google Cloud Trace</a></strong> - A cloud native GCP service that allows us to capture and view trace data.</p>
<p><strong><a href="https://www.jaegertracing.io/go" target="_blank" rel="noopener noreferrer">Jaeger</a></strong> - Similar to google cloud trace, this lets us capture and view traces, but it can be run locally with a stand alone docker container.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="general-concepts">General Concepts<a href="#general-concepts" class="hash-link" aria-label="Direct link to General Concepts" title="Direct link to General Concepts">​</a></h3>
<p>Here&#x27;s some terms that come up a lot when talking about tracing. They are universal to distributed tracing platforms.</p>
<p><strong>Span</strong> - A span is just a single operation. In a nutshell it has a start/end time, attributes, some context, parent trace id, and previous span id.</p>
<p><strong>Trace</strong> - A trace is just a set of spans held in a directed acyclic graph. Traces generally ‘fan out’, beginning with a single request, then showing all the subsequent requests that occur as data flows through the system.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="opentelemetry-concepts">OpenTelemetry Concepts<a href="#opentelemetry-concepts" class="hash-link" aria-label="Direct link to OpenTelemetry Concepts" title="Direct link to OpenTelemetry Concepts">​</a></h3>
<p>Here&#x27;s some open telemetry terminology. These terms will be found in our source code, so they are worth mentioning.</p>
<p><strong>Providers</strong> - This ‘provides’ a tracing solution. In our cases it does so for either a nodejs server or a web browser, and it contains the configuration for Samplering, Instrumentation, and Exporting,</p>
<p><strong>Samplers</strong> - This makes the decision about whether or not to capture a trace. We generally capture a subset of traces to limit the amount of data collected.</p>
<p><strong>Instrumentations</strong> - Hooks into existing code, typically popular npm modules, and wraps key calls with spans. This is where the ‘magic’ happens.</p>
<p><strong>Exporter</strong> - Sends spans to a target collector. In our case, some post processing may occur in the exporter. Our exporters are configured to send spans to google cloud trace, or jaeger for local development.</p>
<p><strong>Collectors</strong> - Collects and aggregates spans sent from exporters. Collectors then generally store span data in one or more databases. Collectors may also do some post processing of the data and in some cases might make sampling decisions.</p>
<p><strong>Tracer</strong> - Used to create new spans</p>
<p><strong>Propagators</strong> - These allow trace context to propagate between services. Essentially it just decorates outbound messages with enough data so that the next service has enough info to keep the trace going.</p>
<p><strong>Context</strong> - This is an object that is made available between spans inside a service. It operates in a nested manner. Here’s an <a href="https://opentelemetry.io/docs/concepts/glossary/" target="_blank" rel="noopener noreferrer">example of context</a>.</p>
<h1>Advanced Topics</h1>
<p>In all likelihood, viewing traces and setting a few configuration options is all that will ever be needed to work with tracing. However, there are a couple other topics for more advanced usage that are good to cover.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="custom-instrumentation">Custom Instrumentation<a href="#custom-instrumentation" class="hash-link" aria-label="Direct link to Custom Instrumentation" title="Direct link to Custom Instrumentation">​</a></h3>
<p>Instrumentation is the process of hooking into existing code so traces can be captured. This is mostly automatic. The <a href="https://www.npmjs.com/package/@opentelemetry/auto-instrumentations-node" target="_blank" rel="noopener noreferrer">@opentelemetry/auto-instrumentations-node library</a> provides ‘auto’ instrumentation which allows us to easily instrument most aspects of node applications. For example, auto instrumentation will capture all outbound HTTP requests, and sql queries.</p>
<p>By default, all instrumentations are enabled. In the future we may want to prefer more targeted instrumentation, as this would result in a smaller number of dependent packages; however, at the time of writing, the ability to easily instrument and gain awareness of all the things that can be traced outweighs the desire to have reduced dependencies.</p>
<p>The instrumentation portion of tracing may seem like a bit of magic at first, however, if you look under the hood at some of the source code you will see the instrumentations are actually pretty straightforward and follow some basic patterns. They use a combination of Asynchooks and good old fashion method hijacking to wrap spans around functions making requests.</p>
<p>A lot can be learned from looking at existing trace implementations which can be found <a href="https://github.com/open-telemetry/opentelemetry-js-contrib/blob/main/plugins" target="_blank" rel="noopener noreferrer">here</a>. Is there a custom integration that FxA needs?</p>
<p>It&#x27;s also easy to instrument a single portion of code manually. Perhaps you have a routine that might be time consuming, but you aren&#x27;t sure exactly how time consuming it is. Wrapping it with a span is pretty easy. Just <a href="https://opentelemetry.io/docs/instrumentation/js/instrumentation/#acquiring-a-tracer" target="_blank" rel="noopener noreferrer">aquire the tracer</a> and <a href="https://opentelemetry.io/docs/instrumentation/js/instrumentation/#create-nested-spans" target="_blank" rel="noopener noreferrer">wrap the routine with a new span</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="filtering-pii">Filtering PII<a href="#filtering-pii" class="hash-link" aria-label="Direct link to Filtering PII" title="Direct link to Filtering PII">​</a></h3>
<p>It’s important that we filter out any personally identifiable information from the data we capture in our traces. We should follow the same procedures that are followed for Sentry data. Essentially anything that might identify a user needs to be stripped out. A good example of PII is an email address. Essentially if the data contains something that can be used to identify a user uniquely it is likely PII. When in doubt, ask about the data in question.</p>
<p>In open telemetry filtering can happen in two ways. Some instrumentations support filtering data before it is even captured. Unfortunately, this is not uniform between instrumentations. Therefore, we will opt to filter on export. This allows us to <a href="https://github.com/mozilla/fxa/blob/6a415eb4c4aac4a5eabf4c79857b7874d09811b1/packages/fxa-shared/tracing/exporters/fxa-otlp.ts#L38" target="_blank" rel="noopener noreferrer">modify the data</a> just before it is sent off. We have access to all the spans and their attributes / tags at this point in time. Simply mutating this data should be sufficient for filtering out PII.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="some-final-guidelines-for-filtering-pii-are">Some final guidelines for filtering PII are:<a href="#some-final-guidelines-for-filtering-pii-are" class="hash-link" aria-label="Direct link to Some final guidelines for filtering PII are:" title="Direct link to Some final guidelines for filtering PII are:">​</a></h4>
<ul>
<li>Be proactive about removing PII from traces. If you see something in a trace that could uniquely identify a user, file a ticket calling it out!</li>
<li>Ideally we still leave as much of the data intact as possible. For example, if there is a sql query containing an email address, if possible, leave the query intact and only filter out the email. E.g { query: <code>select * from users where email = [FILTERED]</code> }  as opposed to { query: <code>[FILTERED]</code> }</li>
<li>Be mindful of performance. If a data field is to be processed, consider truncating it. - If there are an extremely large number of elements to loop through, consider short circuiting and remove elements that can’t be processed.</li>
<li>Keep in mind the goal is to provide as much info in the trace as possible while still being pragmatic about removing PII.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sending-traces-to-google-cloud-trace-locally">Sending Traces to Google Cloud Trace Locally<a href="#sending-traces-to-google-cloud-trace-locally" class="hash-link" aria-label="Direct link to Sending Traces to Google Cloud Trace Locally" title="Direct link to Sending Traces to Google Cloud Trace Locally">​</a></h3>
<p>In the event that trace export isn’t working properly on stage or production, the need to debug this locally might arise. If so, follow these steps:</p>
<ol>
<li>Install the <a href="https://cloud.google.com/sdk/docs/install" target="_blank" rel="noopener noreferrer">gcloud</a> cli tool if you don’t already have it.</li>
<li>Make sure you’ve authenticated with gcloud locally, in order to export data. Once you have gcloud install, simply login with this command:
<code>gcloud auth application-default login</code></li>
<li>Set your .env file up like this:<!-- -->
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">     TRACING_SAMPLE_RATE=1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     TRACING_BATCH_PROCESSING=false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     TRACING_OTEL_EXPORTER_ENABLED=true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     TRACING_OTEL_COLLECTOR_ENABLED=true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     TRACING_OTEL_COLLECTOR_GCP_ENABLED=true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>Stop pm2 <code>yarn stop</code></li>
<li>Start up the stack again with the .env file applied, <code>dotenv —- yarn start</code></li>
<li>Check the logs for the collector service, you should see mention of google cloud trace being supported, <code>pm2 log otel-collector</code></li>
<li>Go to google cloud trace. If there are lots of traces try narrowing them down with the following filter, <code>FILTER:/http/host:localhost:9000</code></li>
</ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/mozilla/ecosystem-platform/edit/master/docs/reference/application-tracing.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/ecosystem-platform/reference/application-logging"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Application Logging</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/ecosystem-platform/reference/browser-support"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Browser Support</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#system-diagrams" class="table-of-contents__link toc-highlight">System Diagrams</a></li><li><a href="#terminology-of-application-tracing" class="table-of-contents__link toc-highlight">Terminology of Application Tracing</a><ul><li><a href="#tooling" class="table-of-contents__link toc-highlight">Tooling</a></li><li><a href="#general-concepts" class="table-of-contents__link toc-highlight">General Concepts</a></li><li><a href="#opentelemetry-concepts" class="table-of-contents__link toc-highlight">OpenTelemetry Concepts</a></li><li><a href="#custom-instrumentation" class="table-of-contents__link toc-highlight">Custom Instrumentation</a></li><li><a href="#filtering-pii" class="table-of-contents__link toc-highlight">Filtering PII</a></li><li><a href="#sending-traces-to-google-cloud-trace-locally" class="table-of-contents__link toc-highlight">Sending Traces to Google Cloud Trace Locally</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Mozilla Corporation.</div></div></div></footer></div>
</body>
</html>