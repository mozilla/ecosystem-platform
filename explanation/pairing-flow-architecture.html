<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-explanation/pairing-flow-architecture" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Pairing Flow Architecture | Firefox Ecosystem Platform</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://mozilla.github.io/ecosystem-platform/explanation/pairing-flow-architecture"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Pairing Flow Architecture | Firefox Ecosystem Platform"><meta data-rh="true" name="description" content="Current as of Mar 17th, 2021"><meta data-rh="true" property="og:description" content="Current as of Mar 17th, 2021"><link data-rh="true" rel="icon" href="/ecosystem-platform/img/firefox-logo.png"><link data-rh="true" rel="canonical" href="https://mozilla.github.io/ecosystem-platform/explanation/pairing-flow-architecture"><link data-rh="true" rel="alternate" href="https://mozilla.github.io/ecosystem-platform/explanation/pairing-flow-architecture" hreflang="en"><link data-rh="true" rel="alternate" href="https://mozilla.github.io/ecosystem-platform/explanation/pairing-flow-architecture" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://RFM5H13DFK-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Pairing Flow Architecture","item":"https://mozilla.github.io/ecosystem-platform/explanation/pairing-flow-architecture"}]}</script><link rel="search" type="application/opensearchdescription+xml" title="Firefox Ecosystem Platform" href="/ecosystem-platform/opensearch.xml"><link rel="stylesheet" href="/ecosystem-platform/assets/css/styles.f0831482.css">
<script src="/ecosystem-platform/assets/js/runtime~main.cff540f0.js" defer="defer"></script>
<script src="/ecosystem-platform/assets/js/main.ab8056e9.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/ecosystem-platform/img/firefox-logo.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/ecosystem-platform/"><div class="navbar__logo"><img src="/ecosystem-platform/img/firefox-logo.png" alt="Ecosystem Platform Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/ecosystem-platform/img/firefox-logo.png" alt="Ecosystem Platform Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Firefox Ecosystem Platform</b></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/mozilla/ecosystem-platform" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Meta+k)" aria-keyshortcuts="Meta+k"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 24 24" aria-hidden="true"><circle cx="11" cy="11" r="8" stroke="currentColor" fill="none" stroke-width="1.4"></circle><path d="m21 21-4.3-4.3" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ecosystem-platform/"><span title="Introduction" class="linkLabel_WmDU">Introduction</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link"><span title="For Relying Parties" class="categoryLinkLabel_W154">For Relying Parties</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/ecosystem-platform/relying-parties/tutorials/integration-with-fxa"><span title="Tutorials" class="categoryLinkLabel_W154">Tutorials</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/ecosystem-platform/relying-parties/how-tos/end-to-end-encryption"><span title="How-to Guides" class="categoryLinkLabel_W154">How-to Guides</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/ecosystem-platform/relying-parties/reference/glossary"><span title="Reference" class="categoryLinkLabel_W154">Reference</span></a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--active"><span title="For FxA Engineers" class="categoryLinkLabel_W154">For FxA Engineers</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/ecosystem-platform/tutorials/development-setup"><span title="Tutorials" class="categoryLinkLabel_W154">Tutorials</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/ecosystem-platform/how-tos/ci-guidelines"><span title="How-to Guides" class="categoryLinkLabel_W154">How-to Guides</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/ecosystem-platform/reference/team-processes/development-process"><span title="Reference" class="categoryLinkLabel_W154">Reference</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/ecosystem-platform/explanation/architectural-decision-records"><span title="Explanation" class="categoryLinkLabel_W154">Explanation</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/explanation/architectural-decision-records"><span title="Architectural Decision Records" class="linkLabel_WmDU">Architectural Decision Records</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/explanation/content-server-architecture"><span title="Content-server architecture" class="linkLabel_WmDU">Content-server architecture</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/explanation/onepw-protocol"><span title="onepw Protocol" class="linkLabel_WmDU">onepw Protocol</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/ecosystem-platform/explanation/pairing-flow-architecture"><span title="Pairing Flow Architecture" class="linkLabel_WmDU">Pairing Flow Architecture</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/explanation/scoped-keys"><span title="Scoped Keys" class="linkLabel_WmDU">Scoped Keys</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/explanation/cms-strapi-l10n"><span title="Localization Workflow" class="linkLabel_WmDU">Localization Workflow</span></a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/additional-docs"><span title="Additional Docs" class="linkLabel_WmDU">Additional Docs</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link"><span title="For Support Agents" class="categoryLinkLabel_W154">For Support Agents</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/ecosystem-platform/reference/admin-panel"><span title="Reference" class="categoryLinkLabel_W154">Reference</span></a></div></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/ecosystem-platform/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">For FxA Engineers</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Explanation</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Pairing Flow Architecture</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Pairing Flow Architecture</h1></header><p>Current as of <code>Mar 17th, 2021</code></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="pairing-flow-architecture">Pairing Flow Architecture<a href="#pairing-flow-architecture" class="hash-link" aria-label="Direct link to Pairing Flow Architecture" title="Direct link to Pairing Flow Architecture" translate="no">​</a></h2>
<p>The goal of the pairing flow is to allow users to quickly connect a mobile browser to Firefox Sync, without having to type their password,
Mozilla accounts allows a mobile device to connect by pairing with an authenticated Firefox profile on their PC via scanning a QR code.
See the <a href="https://docs.google.com/document/d/1mFf0sfEK8o1csXLeyK1x4GS9SUMIq4q8bu25LiydPew/edit#" target="_blank" rel="noopener noreferrer" class="">Project Plan Document</a> for more information.</p>
<p>The intended user flow operates as follows:</p>
<ol>
<li class="">On their Desktop (Authority) device, the user selects an option to connect other device, and a QR code is displayed.</li>
<li class="">On their Mobile (Supplicant) device, the user selects an option to connect to Firefox Sync via pairing, which launches a QR code scanner.</li>
<li class="">The user scans the QR code from Desktop with their Mobile device.</li>
<li class="">The devices establish a secure communication channel, and Mobile sends an OAuth request for Desktop to authorize.</li>
<li class="">After confirming on both devices, the user&#x27;s Mobile is connected to their Firefox Account.</li>
</ol>
<p>The Desktop (Authority) and Mobile (Supplicant) devices will not communicate directly, because we cannot assume that they will be on
the same network and because this is difficult to achieve from web content.
Instead, they will exchange encrypted messages via WebSocket to a lightweight &quot;channel server&quot; service which can relay messages back and forth.
The flow performs a remote authorization where the already authenticated device generates Sync keys and an OAuth code for the new device.
PKCE facilitates the transfer of the Sync key between devices and the channel server facilitates direct communication between the two, including the final transfer of the OAuth code.</p>
<!-- -->
<hr>
<!-- -->
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="detailed-flow">Detailed Flow<a href="#detailed-flow" class="hash-link" aria-label="Direct link to Detailed Flow" title="Direct link to Detailed Flow" translate="no">​</a></h3>
<p>It is advised to read the following section while looking at the detail diagram.</p>
<!-- -->
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-desktop-opens-an-encrypted-channel-and-advertises-it-via-qr-code">1) Desktop opens an encrypted channel and advertises it via QR code<a href="#1-desktop-opens-an-encrypted-channel-and-advertises-it-via-qr-code" class="hash-link" aria-label="Direct link to 1) Desktop opens an encrypted channel and advertises it via QR code" title="Direct link to 1) Desktop opens an encrypted channel and advertises it via QR code" translate="no">​</a></h4>
<p>To make itself available for pairing, the Desktop device opens a connection to the Channel Server using the <a href="https://github.com/mozilla/fxa-pairing-channel" target="_blank" rel="noopener noreferrer" class="">fxa-pairing-channel library</a>.</p>
<p>Once connected it will receive a server-allocated channel id, then the library will generate a 32-byte channel key to be used for client-side encryption of messages on the channel.</p>
<ul>
<li class="">The channel key is what secures the pairing flow.<!-- -->
<ul>
<li class="">Any application that learns the channel key will be able to request pairing from the Desktop device, or intercept messages exchanges during the pairing flow.</li>
<li class="">The fxa-pairing-channel library uses a subset the pre-shared key mode of TLS 1.3 for communication between the two devices.</li>
</ul>
</li>
<li class="">The channel id and channel key are encoded using base64url and are then combined into a &quot;pairing url&quot;.</li>
<li class="">The generated URL looks like: <code>https://accounts.firefox.com/pair#channel_id=[channel_id]&amp;channel_key=[channel_key]</code></li>
<li class="">This URL is then encoded in a QR code and displayed on screen.</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-mobile-scans-the-qr-code-and-connects-to-the-encrypted-channel">2) Mobile scans the QR code and connects to the encrypted channel<a href="#2-mobile-scans-the-qr-code-and-connects-to-the-encrypted-channel" class="hash-link" aria-label="Direct link to 2) Mobile scans the QR code and connects to the encrypted channel" title="Direct link to 2) Mobile scans the QR code and connects to the encrypted channel" translate="no">​</a></h4>
<p>To initiate pairing, the Mobile device scans the QR code displayed by Desktop and extracts the channel id and channel key.
It opens a WebSocket to the Channel Server using the same fxa-pairing-channel library specifying the channel id, channel key.
The Channel Server will now relay WebSocket messages from Mobile to Desktop and vice-versa. The <a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-content-server/app/scripts/models/auth_brokers/pairing/supplicant.js" target="_blank" rel="noopener noreferrer" class="">supplicant broker</a> handles the creation of the <code>PairingChannelClient</code> and the state machine. The supplicant triggers messages after user&#x27;s approval and finally sends
the code to the relier by using the existing OAuth redirection broker.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-devices-exchange-metadata-and-show-confirmation-screens">3) Devices exchange metadata and show confirmation screens<a href="#3-devices-exchange-metadata-and-show-confirmation-screens" class="hash-link" aria-label="Direct link to 3) Devices exchange metadata and show confirmation screens" title="Direct link to 3) Devices exchange metadata and show confirmation screens" translate="no">​</a></h4>
<p>At this point the devices have established a baseline level of trust and can exchange metadata to allow the user to confirm the pairing on both sides.
We use explicit confirmation screens to reduce the risk of phishing or over-the-shoulder attacks.</p>
<p>The Mobile device sends what is essentially an OAuth request, delivered over the WebSocket channel rather than opened as a local web page.
It includes all parameters that would appear in an ordinary OAuth authorization request.
The exceptions are the <code>scope</code>and <code>keys_jwk</code> parameters, they just get passed through when authorizing the request.</p>
<p>The Desktop device sends an &quot;account metadata&quot; message that includes information about the account being connected to.
The properties of that messages are listed in the &quot;Pairing messages&quot; section.</p>
<p>This information will help the Mobile device show a meaningful confirmation screen.  It&#x27;s PII, but the channel has established a base level of trust between devices, so it should be safe to share this information directly.</p>
<ul>
<li class="">Upon receiving the metadata message from the other device, both Desktop and Mobile show an explicit confirmation screen.</li>
<li class="">To show the confirmation screen on desktop, the Desktop (Authority) side transitions from <code>about:preferences</code> Firefox UI to
the fxa-content-server hosted page. This engages the <a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-content-server/app/scripts/models/auth_brokers/pairing/authority.js" target="_blank" rel="noopener noreferrer" class="">authority broker</a> and establishes <a href="https://developer.mozilla.org/docs/Mozilla/JavaScript_code_modules/WebChannel.jsm" target="_blank" rel="noopener noreferrer" class="">WebChannel communication</a> with Native code.</li>
<li class="">There&#x27;s no set confirmation order: the Supplicant and the Authority will show the confirmations screens at the same time, and can be accepted in any order.</li>
</ul>
<p>For additional security, the Channel Server annotates each message with information about the originating device, such as geoip lookup data. This may help the user detect if they&#x27;re connecting to a different device than expected.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-desktop-device-authorizes-oauth-request">4) Desktop device authorizes OAuth request<a href="#4-desktop-device-authorizes-oauth-request" class="hash-link" aria-label="Direct link to 4) Desktop device authorizes OAuth request" title="Direct link to 4) Desktop device authorizes OAuth request" translate="no">​</a></h4>
<p>When the user accepts the confirmation screen on the Desktop device, it will use its local credentials to authorize the OAuth request from the Mobile device. This involves no user interaction, and will include the following steps:</p>
<ul>
<li class="">Check that redirect_uri is the expected value; error out if not.</li>
<li class="">Check that scope contains exactly <code>&quot;profile&quot;</code> and <code>&quot;https://identity.mozilla.com/apps/oldsync&quot;</code>; error out if not.</li>
<li class="">Check that client_id is the expected value; error out if not.</li>
<li class="">Check that state exists and is well formed; error out if not.</li>
<li class="">Build the scoped-key bundle for <code>&quot;https://identity.mozilla.com/apps/oldsync&quot;</code>, encrypting it with the provided <code>keys_jwk</code> to produce <code>keys_jwe</code>.</li>
<li class="">POST all of this to fxa-oauth-server at <code>/v1/authorization</code> and receive back an OAuth code and state response parameters.</li>
</ul>
<p>Desktop will then send the code and state parameters back to Mobile over the WebSocket channel, encrypted as before with the channel key.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="5-mobile-receives-oauth-response-and-connects-to-sync">5) Mobile receives OAuth response and connects to Sync<a href="#5-mobile-receives-oauth-response-and-connects-to-sync" class="hash-link" aria-label="Direct link to 5) Mobile receives OAuth response and connects to Sync" title="Direct link to 5) Mobile receives OAuth response and connects to Sync" translate="no">​</a></h4>
<p>When the user accepts the confirmation screen on the Mobile device, it will listen for the message produced by the Desktop device in step (4) above.
After receiving the message, it can tear down its WebSocket channel. The supplicant broker redirect step is captured by the Native app, as part of that step the <code>code</code> and <code>state</code> params are extracted from the redirect url.</p>
<ul>
<li class="">The mobile application can now complete its OAuth flow in its Native code just as if it had received code and state via a standard web-content-based OAuth flow:</li>
<li class="">Submit the code to fxa-oauth-server at <code>/v1/token</code> in exchange for an access token, refresh token, and bundle of encrypted key material.</li>
<li class="">Decrypt the bundle of key material with its keys_jwk private key.</li>
<li class="">Fetch user profile data, and check that it matches the data provided by Desktop in step (3).</li>
<li class="">Use the access token and key material to access Firefox Sync.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="intended-security-properties">Intended Security Properties<a href="#intended-security-properties" class="hash-link" aria-label="Direct link to Intended Security Properties" title="Direct link to Intended Security Properties" translate="no">​</a></h2>
<p>The security-related design goals of this system are as follows:</p>
<ul>
<li class="">The result of the flow is the same as if the Mobile device had done an ordinary
web-content-based OAuth flow. It obtains its own OAuth tokens for the user&#x27;s Firefox
account, with appropriate scopes and a copy of the relevant key material.</li>
<li class="">The messages relayed between Desktop and Mobile cannot be read or forged by any
other party.</li>
<li class="">On the signed-in Desktop device:<!-- -->
<ul>
<li class="">The flow cannot be used to surreptitiously extract FxA key material (such as the
user&#x27;s sync keys) from the browser, not even by Mozilla&#x27;s servers or by web
content running on <a href="https://accounts.firefox.com" target="_blank" rel="noopener noreferrer" class="">https://accounts.firefox.com</a>.</li>
<li class="">There is no way for third-party web content to initiate a pairing flow, which might
be used for phishing purposes.</li>
</ul>
</li>
<li class="">On the connecting Mobile device:<!-- -->
<ul>
<li class="">Handling of FxA key material is as or more secure than the existing web-based
scoped-keys flow.</li>
<li class="">There is no way for third-party apps or web content to trigger the pairing flow,
which might be used for phishing purposes.</li>
<li class="">If the user scans the QRcode with a third-party app rather than a Mobile Firefox
browser, then that app can only gain access to the user&#x27;s account by actively
phishing the user into completing the flow; it cannot silently insert itself as
a meddler-in-the-middle of a legitimate flow with the user&#x27;s actual Firefox browser.</li>
</ul>
</li>
</ul>
<p>These properties are enforced by the following features/mitigations:</p>
<ul>
<li class="">The communication channel between the two devices is secured by:<!-- -->
<ul>
<li class="">Communication between Desktop and Mobile is encrypted and authenticated using a
TLS1.3 PSK handshake, with the key obtained by scanning the QR code. This guards
against eavesdropping or MitM by anyone who does not have the channel key
(including the channelserver that is proxying the messages, since it has no way to
obtain the key).</li>
<li class="">Communications are routed through the Mozilla-hosted channelserver, authenticated
with standard TLS PKI. The channelserver enforces that only two connections are
made on a channel, providing additional protection against eavesdropping or MitM
by third-party software <em>even if</em> such software somehow obtains the channel key.</li>
<li class="">The mobile device must directly scan the QR code in order to initiate the flow.
This prevents a third-party scanner that happens to intercept the channel key
from inserting itself as a MitM, with one channel open to the Desktop device and
a second channel open to the Mobile device.</li>
</ul>
</li>
<li class="">Inside the communication channel, the devices execute a largely unmodified variant of
the existing FxA scoped-keys OAuth flow, so the exchange inherits the existing
security boundaries/properties of that flow.</li>
<li class="">When authorizing the OAuth request, Firefox Desktop is directly responsible for
encrypting the scoped-keys bundle using the OAuth request parameters it received over
the pairing channel. There is thus no opportunity for web content running on the
desktop device to see the raw scoped-keys key material.<!-- -->
<ul>
<li class="">Web content cannot, for example, inject its own <code>keys_jwk</code> parameter into
the OAuth flow in order to MitM the scoped-keys exchange. This is an improvement
over the current state of the web-based OAuth flow, in which web content can
directly handle the account key material.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="exchanged-messages-specification">Exchanged messages specification<a href="#exchanged-messages-specification" class="hash-link" aria-label="Direct link to Exchanged messages specification" title="Direct link to Exchanged messages specification" translate="no">​</a></h2>
<p>The pairing flow is made possible by messages that are forwarded between the Desktop native code and the web content page opened on the supplicant device.</p>
<p>The Firefox Desktop native code gathers information from web content via WebChannels and communicates that to the supplicant using the
channel server socket.</p>
<p>Meanwhile, the web content opened on the supplicant device connects directly to a WebSocket, without native code infrastructure.
It waits for user&#x27;s approval on both sides of the flow and once that is achieved, it can receive the OAuth <code>code</code> and <code>state</code>
from the authority side of the pairing flow.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="pairing-channel-messages">Pairing Channel messages<a href="#pairing-channel-messages" class="hash-link" aria-label="Direct link to Pairing Channel messages" title="Direct link to Pairing Channel messages" translate="no">​</a></h3>
<p>The message payload is a JSON object that contains a message identifier and a data object.
Every message envelope also contains information about the sender (IP address, geolocation..).
Here&#x27;s an example of the channel server envelope:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">data</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ...</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;remoteMetaData&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;city&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Kanata&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;country&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Canada&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;region&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Ontario&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;ua&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.10; rv:40.0) Gecko/20100101 Firefox/40.0&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;ipAddress&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.1.1.1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="pairsupp">pair:supp<!-- -->:request<a href="#pairsupp" class="hash-link" aria-label="Direct link to pairsupp" title="Direct link to pairsupp" translate="no">​</a></h4>
<p>Direction: Supp -&gt; Auth</p>
<p>Description: Sent right after connecting to the pairing channel by the supp. Contains OAuth request parameters, a key encryption JWK if required by the relier.</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  message</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;pair:supp:request&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  data</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// See the OAuth server API doc for a description of the parameters.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    access_type</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    client_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    code_challenge</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    code_challenge_method</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// FxA Scoped Keys key-fetching public key (base64url encoded).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">keys_jwk</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    scope</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    state</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="pairauth">pair:auth<!-- -->:metadata<a href="#pairauth" class="hash-link" aria-label="Direct link to pairauth" title="Direct link to pairauth" translate="no">​</a></h4>
<p>Direction: Auth -&gt; Supp</p>
<p>Description: Sent by the Auth and contains the account and device information of the Auth.</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  message</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;pair:auth:metadata&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  data</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    email</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    avatar</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    deviceName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="pairauth-1">pair:auth<!-- -->:authorize<a href="#pairauth-1" class="hash-link" aria-label="Direct link to pairauth-1" title="Direct link to pairauth-1" translate="no">​</a></h4>
<p>Direction: Auth -&gt; Supp</p>
<p>Description: Sent by the Auth once the pairing has been confirmed by the user on this side. Contains an OAuth code that can be traded for a token.</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  message</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;pair:auth:authorize&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  data</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// See the OAuth server API doc for a description of the parameters.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    code</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    state</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    redirect</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="pairsupp-1">pair:supp<!-- -->:authorize<a href="#pairsupp-1" class="hash-link" aria-label="Direct link to pairsupp-1" title="Direct link to pairsupp-1" translate="no">​</a></h4>
<p>Direction: Supp -&gt; Auth</p>
<p>Description: Sent by the Supp once the pairing has been confirmed by the user on this side.</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  message</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;pair:supp:authorize&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="desktop-webchannel-messages">Desktop WebChannel messages<a href="#desktop-webchannel-messages" class="hash-link" aria-label="Direct link to Desktop WebChannel messages" title="Direct link to Desktop WebChannel messages" translate="no">​</a></h3>
<p>On Desktop, the Mozilla accounts Web Content page communicates with the native code (which owns the pairing channel connection) using WebChannel.
WebChannel messages can only be initiated from the content side, however the native side can send a response.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="fxaccounts">fxaccounts<!-- -->:pair_supplicant_metadata<a href="#fxaccounts" class="hash-link" aria-label="Direct link to fxaccounts" title="Direct link to fxaccounts" translate="no">​</a></h4>
<p>Description: Allows the web content to request the supp’s device information.</p>
<p>Expected response:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ua</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  city</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  region</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  country</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ipAddress</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="fxaccounts-1">fxaccounts<!-- -->:pair_authorize<a href="#fxaccounts-1" class="hash-link" aria-label="Direct link to fxaccounts-1" title="Direct link to fxaccounts-1" translate="no">​</a></h4>
<p>Allows the web content to inform the native side the confirmation dialog has been accepted.</p>
<p>Expected response: N/A</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="fxaccounts-2">fxaccounts<!-- -->:pair_heartbeat<a href="#fxaccounts-2" class="hash-link" aria-label="Direct link to fxaccounts-2" title="Direct link to fxaccounts-2" translate="no">​</a></h4>
<p>Description: Sent by the web content every second or so. Allows to surface errors but to also transition to a &quot;completed&quot; screen once the supp side has confirmed the pairing request.</p>
<p>Expected Response:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  err</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// String</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;OR&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  suppAuthorized</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Boolean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="fxaccounts-3">fxaccounts<!-- -->:pair_complete<a href="#fxaccounts-3" class="hash-link" aria-label="Direct link to fxaccounts-3" title="Direct link to fxaccounts-3" translate="no">​</a></h4>
<p>Description: Allows the web content to inform the native side it is aware the flow is finished, has shown a confirmation screen and the resources can be finalized on the native side.</p>
<p>Expected Response: N/A</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="other-details">Other Details<a href="#other-details" class="hash-link" aria-label="Direct link to Other Details" title="Direct link to Other Details" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="routes">Routes<a href="#routes" class="hash-link" aria-label="Direct link to Routes" title="Direct link to Routes" translate="no">​</a></h3>
<ul>
<li class="">The Mobile (Supplicant) side, implements the following URL: <code>https://accounts.firefox.com/pair/supp</code></li>
</ul>
<p>This view accepts OAuth query parameters equivalent to those on the existing /oauth/ view, and will accept the channel id and channel key as parameters in the URL hash fragment.  The view performs the entire Mobile side of the protocol, including:</p>
<ul>
<li class="">connecting to the provided channel via WebSocket</li>
<li class="">passing the OAuth request to the Desktop over the WebSocket channel</li>
<li class="">displaying a confirmation screen using the account metadata information sent by Desktop</li>
<li class="">receiving OAuth code and state from Desktop over the WebSocket channel.</li>
<li class="">completing the OAuth flow by redirecting back to the relier</li>
</ul>
<ul>
<li class="">The Desktop (Authority) side, loads the following URL: <code>https://accounts.firefox.com/pair/auth</code></li>
</ul>
<p>This view establishes communication with Native Desktop code. The Native Desktop code takes care of the following:</p>
<ul>
<li class="">establishing the WebSocket channel and corresponding secret key</li>
<li class="">displaying the QR code as a URL to <code>https://accounts.firefox.com/pair</code></li>
<li class="">receiving the OAuth request from the Mobile device</li>
<li class="">constructing the keys_jwe bundle and authorizing the OAuth request</li>
<li class="">return the OAuth code to the Mobile device over the WebSocket channel</li>
<li class="">communicating between Native code and Authority web content using WebChannels</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="qr-code-and-urls">QR Code and URLs<a href="#qr-code-and-urls" class="hash-link" aria-label="Direct link to QR Code and URLs" title="Direct link to QR Code and URLs" translate="no">​</a></h3>
<p>The QR code is a URL: <code>https://accounts.firefox.com/pair/#channel_id=XYZ&amp;channel_key=ABC</code></p>
<p>When the Mobile device scans this from the QR code, it parses out the channel parameters and combines them with its OAuth request parameters to produce a URL like the following:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">https://accounts.firefox.com/pair/supp</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">?client_id=&lt;the client&#x27;s oauth client id&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&amp;state=&lt;generated state token&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&amp;scope=&lt;scopes to request&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&amp;code_challenge=&lt;generated PKCE challenge&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&amp;code_challenge_method=&lt;generated PKCE challenge method&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&amp;keys_jwk=&lt;generated public key&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&amp;redirect_uri=&lt;the client&#x27;s registered redirect_uri&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#channel_id=XYZ&amp;channel_key=ABC</span><br></span></code></pre></div></div>
<p>Open the constructed URL, just as it would if it were initiating a standard username-and-password OAuth flow.
Wait for a redirect from the opened OAuth flow to return <code>code</code> and <code>state</code> parameters.</p>
<ul>
<li class="">After the OAuth flow redirects with the <code>code</code>, it can be exchanged for the <code>keys_jwe</code> bundle.</li>
<li class="">Decrypt the key bundle using corresponding private key for <code>keys_jwk</code>.</li>
<li class="">The Desktop pairing flow implements a custom <code>redirect_uri</code> - <code>urn:ietf:wg:oauth:2.0:oob:pair-auth-webchannel</code>. This indicates that this is a pairing flow.</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/mozilla/ecosystem-platform/edit/master/docs/explanation/pairing-flow-architecture.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/ecosystem-platform/explanation/onepw-protocol"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">onepw Protocol</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/ecosystem-platform/explanation/scoped-keys"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Scoped Keys</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#pairing-flow-architecture" class="table-of-contents__link toc-highlight">Pairing Flow Architecture</a><ul><li><a href="#detailed-flow" class="table-of-contents__link toc-highlight">Detailed Flow</a></li></ul></li><li><a href="#intended-security-properties" class="table-of-contents__link toc-highlight">Intended Security Properties</a></li><li><a href="#exchanged-messages-specification" class="table-of-contents__link toc-highlight">Exchanged messages specification</a><ul><li><a href="#pairing-channel-messages" class="table-of-contents__link toc-highlight">Pairing Channel messages</a></li><li><a href="#desktop-webchannel-messages" class="table-of-contents__link toc-highlight">Desktop WebChannel messages</a></li></ul></li><li><a href="#other-details" class="table-of-contents__link toc-highlight">Other Details</a><ul><li><a href="#routes" class="table-of-contents__link toc-highlight">Routes</a></li><li><a href="#qr-code-and-urls" class="table-of-contents__link toc-highlight">QR Code and URLs</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 Mozilla Corporation.</div></div></div></footer></div>
</body>
</html>