<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-explanation/content-server-architecture">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Content-server architecture | Firefox Ecosystem Platform</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://mozilla.github.io/ecosystem-platform/explanation/content-server-architecture"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Content-server architecture | Firefox Ecosystem Platform"><meta data-rh="true" name="description" content="Current as of Jan 20th, 2020"><meta data-rh="true" property="og:description" content="Current as of Jan 20th, 2020"><link data-rh="true" rel="icon" href="/ecosystem-platform/img/firefox-logo.png"><link data-rh="true" rel="canonical" href="https://mozilla.github.io/ecosystem-platform/explanation/content-server-architecture"><link data-rh="true" rel="alternate" href="https://mozilla.github.io/ecosystem-platform/explanation/content-server-architecture" hreflang="en"><link data-rh="true" rel="alternate" href="https://mozilla.github.io/ecosystem-platform/explanation/content-server-architecture" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://RFM5H13DFK-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Firefox Ecosystem Platform" href="/ecosystem-platform/opensearch.xml"><link rel="stylesheet" href="/ecosystem-platform/assets/css/styles.c7edb04e.css">
<link rel="preload" href="/ecosystem-platform/assets/js/runtime~main.44530cc2.js" as="script">
<link rel="preload" href="/ecosystem-platform/assets/js/main.836b3ab5.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(e){}return e}()||function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/ecosystem-platform/"><div class="navbar__logo"><img src="/ecosystem-platform/img/firefox-logo.png" alt="Ecosystem Platform Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/ecosystem-platform/img/firefox-logo.png" alt="Ecosystem Platform Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Firefox Ecosystem Platform</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/mozilla/ecosystem-platform" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ecosystem-platform/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">For Relying Parties</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/relying-parties/tutorials/integration-with-fxa">Tutorials</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/relying-parties/how-tos/end-to-end-encryption">How-to Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/relying-parties/reference/integration-requirements">Reference</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active">For FxA Engineers</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/tutorials/development-setup">Tutorials</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/how-tos/ci-guidelines">How-to Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/reference/team-processes/development-process">Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/ecosystem-platform/explanation/architectural-decision-records">Explanation</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/explanation/architectural-decision-records">Architectural Decision Records</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/ecosystem-platform/explanation/content-server-architecture">Content-server architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/explanation/metrics">Metrics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/explanation/onepw-protocol">onepw Protocol</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/explanation/pairing-flow-architecture">Pairing Flow Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/explanation/scoped-keys">Scoped Keys</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/additional-docs">Additional Docs</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">For Support Agents</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/reference/admin-panel">Reference</a></div></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/ecosystem-platform/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">For FxA Engineers</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Explanation</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Content-server architecture</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Content-server architecture</h1></header><p>Current as of <code>Jan 20th, 2020</code></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="document-purpose">Document purpose<a href="#document-purpose" class="hash-link" aria-label="Direct link to Document purpose" title="Direct link to Document purpose">​</a></h2><p>This is a starting point for developers and contributors of the Firefox Accounts Content Server. The content-server
is responsible for displaying the authentication/authorization and account settings related UI to the user.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="helpful-to-know-before-starting">Helpful to know before starting<a href="#helpful-to-know-before-starting" class="hash-link" aria-label="Direct link to Helpful to know before starting" title="Direct link to Helpful to know before starting">​</a></h2><p>At a high level, FxA is an <a href="https://stackoverflow.com/questions/6556522/authentication-versus-authorization" target="_blank" rel="noopener noreferrer">authentication (authn) and authorization (authz) system</a>. This means a Relying Party (RP) such as Firefox Sync delegates
the responsibility for authenticating and authorizing users to Firefox Accounts. Once the user proves their
identity to FxA, we return one or more tokens the RP can use to access a &quot;protected resource&quot;.
The <a href="https://tools.ietf.org/html/rfc6749" target="_blank" rel="noopener noreferrer">OAuth 2.0 spec</a> does a good job of explaining these concepts.</p><div class="mermaid" data-mermaid-src="sequenceDiagram
  participant rp as Relying Party
  participant fxaback as FxA content server backend
  participant fxaweb as FxA content server UI
  participant fxaother as Other FxA backend services

  rp--&gt;&gt;fxaback: Authn/Authz request
  fxaback--&gt;&gt;fxaweb: send UI
  fxaweb-&gt;&gt;fxaweb: user authenticates/authorizes
  fxaweb--&gt;&gt;fxaother: forward user generated credentials
  fxaother--&gt;&gt;fxaother: check user generated credentials, generate RP credentials
  fxaother--&gt;&gt;fxaweb: return RP credentials
  fxaweb--&gt;&gt;fxaback: send metrics
  fxaweb--&gt;&gt;rp: send RP credentials">sequenceDiagram
  participant rp as Relying Party
  participant fxaback as FxA content server backend
  participant fxaweb as FxA content server UI
  participant fxaother as Other FxA backend services

  rp--&gt;&gt;fxaback: Authn/Authz request
  fxaback--&gt;&gt;fxaweb: send UI
  fxaweb-&gt;&gt;fxaweb: user authenticates/authorizes
  fxaweb--&gt;&gt;fxaother: forward user generated credentials
  fxaother--&gt;&gt;fxaother: check user generated credentials, generate RP credentials
  fxaother--&gt;&gt;fxaweb: return RP credentials
  fxaweb--&gt;&gt;fxaback: send metrics
  fxaweb--&gt;&gt;rp: send RP credentials</div><p>While FxA is an <a href="https://tools.ietf.org/html/rfc6749#section-1.1" target="_blank" rel="noopener noreferrer">OAuth 2.0 authorization server</a>, OAuth is
only one of several <a href="#relying-party-integrations">integration types</a> supported by FxA.
For more information about how FxA came to support so many non-standard integrations, see the <a href="https://docs.google.com/document/d/1jixykayGuyIGU8ecThHvvUpTeC4yq84KRalGr0Jh0xg/" target="_blank" rel="noopener noreferrer">App Services and FxA Unofficial History</a>.</p><p>Detailed <a href="/ecosystem-platform/reference/system-diagrams">Maps of the FxA Universe</a> outline how the various Firefox Accounts micro-services
fit together.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="relying-party-integrations">Relying Party Integrations<a href="#relying-party-integrations" class="hash-link" aria-label="Direct link to Relying Party Integrations" title="Direct link to Relying Party Integrations">​</a></h3><p>The content server architecture was heavily influenced by the number of ways Relying Parties (RPs)
integrate with FxA. If portions of the architecture seem byzantine and complex, chances are this is why.</p><ul><li>4 browser environments for Firefox Sync:<ul><li>Firefox Desktop</li><li>Firefox for Android (Fennec)</li><li>Firefox for Android (Fenix)</li><li>Firefox for iOS</li></ul></li><li>WebExtensions such as Notes and the Firefox Private Network &quot;secure proxy&quot; (FPN)</li><li>OAuth 2.0 such as <a href="https://monitor.firefox.com/" target="_blank" rel="noopener noreferrer">Monitor</a></li><li>Native applications such as the <a href="https://fpn.firefox.com/vpn" target="_blank" rel="noopener noreferrer">Firefox Private Network VPN</a></li><li>&quot;Direct access&quot;, i.e., users browsing directly to <a href="https://accounts.firefox.com" target="_blank" rel="noopener noreferrer">https://accounts.firefox.com</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="content-server-architecture-basics">Content server architecture basics<a href="#content-server-architecture-basics" class="hash-link" aria-label="Direct link to Content server architecture basics" title="Direct link to Content server architecture basics">​</a></h2><p>The content server is comprised of a server and client side components.</p><p>The server side is responsible for serving static content and ingesting metrics and error
reports.</p><p>The client side is a <a href="https://backbonejs.org/" target="_blank" rel="noopener noreferrer">Backbone</a> based Single Page Application (SPA) and responsible for screen rendering,
handling user input, communicating with various FxA backend services, and communicating with RPs or browsers.
The client app runs in modern Web capable systems, see <a href="/ecosystem-platform/reference/browser-support">supported browsers</a> for up to date tier 1 support.  Our use of Backbone isn&#x27;t strictly Model-View-Controller (MVC), ours is more like MVVM. We use Models and Views and have models for the Views.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p><strong>We&#x27;re in the middle of a conversion to React which will obsolete Backbone.</strong>  Read more details about <a href="https://mozilla-hub.atlassian.net/browse/FXA-6441" target="_blank" rel="noopener noreferrer">Phase II</a>.</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="high-level-web-client-components">High Level Web Client Components<a href="#high-level-web-client-components" class="hash-link" aria-label="Direct link to High Level Web Client Components" title="Direct link to High Level Web Client Components">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="auth-brokers">Auth-Brokers<a href="#auth-brokers" class="hash-link" aria-label="Direct link to Auth-Brokers" title="Direct link to Auth-Brokers">​</a></h3><p><a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/app/scripts/models/auth_brokers" target="_blank" rel="noopener noreferrer">Auth-Brokers</a> have two primary responsibilities:</p><ol><li>Mediate communication between Firefox Accounts and the RP</li><li>Screen-&gt;screen state machine</li></ol><p>To minimize the complexity, each integration type has its own broker so that
customizations can be made without interfering with other brokers.</p><p>Brokers are made up of a list of capabilities, methods, and behaviors. Brokers can extend exisiting brokers and overwrite
any of these properites to meet the specification of that integration.</p><ul><li><a href="https://github.com/mozilla/fxa/blob/5c527d8007c416b2f6122d8081f7756f8bc6733b/packages/fxa-content-server/app/scripts/models/auth_brokers/base.js#L539:L602" target="_blank" rel="noopener noreferrer">capabilities</a> can be thought of as feature flags, e.g., <a href="https://github.com/mozilla/fxa/blob/5c527d8007c416b2f6122d8081f7756f8bc6733b/packages/fxa-content-server/app/scripts/models/auth_brokers/base.js#L539:L602" target="_blank" rel="noopener noreferrer">&quot;does this integration support signup?&quot;</a>  (some versions of Firefox for iOS do not)</li><li>methods are invoked by views before and after certain events happen, e.g., <a href="https://github.com/mozilla/fxa/blob/5c527d8007c416b2f6122d8081f7756f8bc6733b/packages/fxa-content-server/app/scripts/models/auth_brokers/base.js#L270:L279" target="_blank" rel="noopener noreferrer"><code>afterSignIn</code></a> is called after a user signs in and can be used to notify the RP. Methods usually return a &quot;behavior&quot;, i.e., &quot;what to do next&quot;.</li><li>behaviors define &quot;what to do next&quot; after a method has completed. For example, <code>afterSignIn</code> by default <a href="https://github.com/mozilla/fxa/blob/5c527d8007c416b2f6122d8081f7756f8bc6733b/packages/fxa-content-server/app/scripts/models/auth_brokers/base.js#L106" target="_blank" rel="noopener noreferrer">sends the user to the /signin_confirmed screen</a>.</li></ul><p>Brokers communicate with RPs via the URL or a <a href="#channels">Channel</a>.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>While placing screen-&gt;screen transition logic in auth_brokers might seem like an odd choice, this resulted
in a huge simplification over when complex transition logic was embedded in views. Some screen-&gt;screen transitions
depend on the integration type, and embedding this logic within the Views resulted in an unmaintainable
mess. The work to completely remove transition logic from views was never completed, and we have since
made many transitions more universal and it may be that we could move some of this logic back into views.
It may also be that distinct state machines outside of brokers would have been a better choice.</p></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="auth-broker-implementations">Auth Broker implementations<a href="#auth-broker-implementations" class="hash-link" aria-label="Direct link to Auth Broker implementations" title="Direct link to Auth Broker implementations">​</a></h4><table><thead><tr><th>Broker</th><th align="center">Description</th></tr></thead><tbody><tr><td><a href="https://github.com/mozilla/fxa/blob/88f6119cc75ae75bd26f87cf5e42dc71e95411d4/packages/fxa-content-server/app/scripts/models/auth_brokers/base.js#L6" target="_blank" rel="noopener noreferrer">base</a></td><td align="center">Base broker that other brokers inhiert from.</td></tr><tr><td><a href="https://github.com/mozilla/fxa/blob/9a26577ee493fca55c4fe752fa940bac0286d066/packages/fxa-content-server/app/scripts/models/auth_brokers/fx-desktop-v3.js#L6" target="_blank" rel="noopener noreferrer">fx-desktop-v3</a></td><td align="center">v3 of the Fx Desktop authentication broker, it allows the uid of a user to change if the user&#x27;s account has been deleted.</td></tr><tr><td><a href="https://github.com/mozilla/fxa/blob/2d5efe1264157e72ccd1ddbfc60d4bb6361a4d7b/packages/fxa-content-server/app/scripts/models/auth_brokers/fx-fennec-v1.js#L15" target="_blank" rel="noopener noreferrer">fx-fennec-v1</a></td><td align="center">Interfaces with Firefox for Android when authenticating for Sync, it communicates with the browser using WebChannels.</td></tr><tr><td><a href="https://github.com/mozilla/fxa/blob/a4f406cddc24478683ef6b8335dfe5423e21a62b/packages/fxa-content-server/app/scripts/models/auth_brokers/fx-ios-v1.js#L7" target="_blank" rel="noopener noreferrer">fx-ios-v1</a></td><td align="center">Interfaces with Sync on Fx for iOS. Uses the same custom protocol as fx-desktop-v1.</td></tr><tr><td><a href="https://github.com/mozilla/fxa/blob/16e58737d95214abe27337bd7ad3bbe07b4da8d2/packages/fxa-content-server/app/scripts/models/auth_brokers/fx-sync.js#L6" target="_blank" rel="noopener noreferrer">fx-sync</a></td><td align="center">Generic broker used to integrate into Sync. This is used as a base class.</td></tr><tr><td><a href="https://github.com/mozilla/fxa/blob/2d5efe1264157e72ccd1ddbfc60d4bb6361a4d7b/packages/fxa-content-server/app/scripts/models/auth_brokers/fx-sync-channel.js#L6" target="_blank" rel="noopener noreferrer">fx-sync-channel</a></td><td align="center">Base broker that communicates with the Firefox browser.</td></tr><tr><td><a href="https://github.com/mozilla/fxa/blob/25f33db4437b980f479911eea36ace35728c00df/packages/fxa-content-server/app/scripts/models/auth_brokers/fx-sync-web-channel.js#L6" target="_blank" rel="noopener noreferrer">fx-sync-web-channel</a></td><td align="center">Variant of Sync broker that communicates via webchannels.</td></tr><tr><td><a href="https://github.com/mozilla/fxa/blob/14543fdcd73d300946b7155c275391072d96e247/packages/fxa-content-server/app/scripts/models/auth_brokers/oauth-redirect.js#L5" target="_blank" rel="noopener noreferrer">oauth-redirect</a></td><td align="center">Oauth broker that finishes oauth flow by redirecting the current window.</td></tr><tr><td><a href="https://github.com/mozilla/fxa/blob/8701348cdd79dbdc9879b2b4a55a23a135a32bc1/packages/fxa-content-server/app/scripts/models/auth_brokers/oauth-redirect-chrome-android.js#L12" target="_blank" rel="noopener noreferrer">oauth-redirect-chrome-android</a></td><td align="center">Created because Chrome for Android will not allow the page to redirect unless its the result of a user action such as a click.</td></tr><tr><td><a href="https://github.com/mozilla/fxa/blob/a4f406cddc24478683ef6b8335dfe5423e21a62b/packages/fxa-content-server/app/scripts/models/auth_brokers/oauth-webchannel-v1.js#L6" target="_blank" rel="noopener noreferrer">oauth-webchannel-v1</a></td><td align="center">WebChannel OAuth broker that speaks &#x27;v1&#x27; of the protocol.</td></tr><tr><td><a href="https://github.com/mozilla/fxa/blob/3173773c00c9d777b9c82d76be10f120e79af7b2/packages/fxa-content-server/app/scripts/models/auth_brokers/web.js#L6" target="_blank" rel="noopener noreferrer">web</a></td><td align="center">Auth broker to handle users who browse directly to the site.</td></tr><tr><td><a href="https://github.com/mozilla/fxa/blob/8701348cdd79dbdc9879b2b4a55a23a135a32bc1/packages/fxa-content-server/app/scripts/models/auth_brokers/pairing/authority.js#L5" target="_blank" rel="noopener noreferrer">pairing/authority</a></td><td align="center">Manages the OAuth flow by WebChannel messages to the browser to help with a pairing-based flow.</td></tr><tr><td><a href="https://github.com/mozilla/fxa/blob/fa545b9bc089c15cba6549a3277df45254fc7527/packages/fxa-content-server/app/scripts/models/auth_brokers/pairing/supplicant.js#L11" target="_blank" rel="noopener noreferrer">pairing/supplicant</a></td><td align="center">SupplicantBroker extends OAuthRedirectBroker to provide a redirect behaviour as an OAuth flow.</td></tr><tr><td><a href="https://github.com/mozilla/fxa/blob/25f33db4437b980f479911eea36ace35728c00df/packages/fxa-content-server/app/scripts/models/auth_brokers/pairing/supplicant-webchannel.js#L10" target="_blank" rel="noopener noreferrer">pairing/supplicant-webchannel</a></td><td align="center">SupplicantWebChannelBroker extends OAuthWebChannelBroker to provide a WebChannel flow.</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="channels">Channels<a href="#channels" class="hash-link" aria-label="Direct link to Channels" title="Direct link to Channels">​</a></h3><p>A <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/app/scripts/lib/channels" target="_blank" rel="noopener noreferrer">channel</a> is a two way communication mechanism between a RP and Firefox Accounts. The method of communication is channel specific.</p><p>There are channels to:</p><ul><li>Communicate between FxA and the browser</li><li>Communicate between FxA and a WebExtension</li><li>Communicate between 2 or more FxA tabs</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="reliers">Reliers<a href="#reliers" class="hash-link" aria-label="Direct link to Reliers" title="Direct link to Reliers">​</a></h3><p>A <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/app/scripts/models/reliers" target="_blank" rel="noopener noreferrer">Relier</a> fetches and holds data about the current RP. A Relier is created on startup and is
a central place to ensure data coming into and out of FxA is safe and well-formed.</p><p>Three primary types of Relier models exist:</p><ol><li>browser (for Sync integrations)</li><li>oauth</li><li>web (called relier)</li></ol><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>Any long lived data (e.g., email address, uid, <code>client_id</code>), coming from an RP or on the URL
<strong>MUST BE</strong> validated and transformed within Reliers. While it seems natural to ingest and sanitize
data in the Views, we are unable to control what users and malicious actors do. Assuming users always
enter at <code>/</code>, or at <code>/complete_sign_up</code>, etc, <em>does not hold</em>. To prevent XSS, we would have to validate
and sanitize long lived data <em>on every screen it is used</em>, and we saw many cases in the past where we
forgot to do this. Ingesting and validating the data on startup in the Relier model ensures the data
is checked once and is ensured to be safe afterwards.</p></div></div><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>The front end could probably be significantly simplified if all query parameter validation logic was moved to the server.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="user">User<a href="#user" class="hash-link" aria-label="Direct link to User" title="Direct link to User">​</a></h3><p>A <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/app/scripts/models/user.js" target="_blank" rel="noopener noreferrer">User</a> holds and persists data about one or more Accounts as well as keeping track of the currently signed in user.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>The user model was a premature solution to allow us to have an &quot;account chooser&quot; where a user visiting
a new RP would be able to choose from any of their signed in Accounts. We never implemented this, and the User
model has been a bit of a pain. The model does handle other things, though we could probably move most of its
responsibilities elsewhere and simplify the overall architecture.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="account">Account<a href="#account" class="hash-link" aria-label="Direct link to Account" title="Direct link to Account">​</a></h3><p>An <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/app/scripts/models/account.js" target="_blank" rel="noopener noreferrer">Account</a> holds data about a given account and provides an API for making updates to the account. The account
model uses the fxa-js-client, fxa-oauth-client, and fxa-profile-client to operate on the account in any way.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="router">Router<a href="#router" class="hash-link" aria-label="Direct link to Router" title="Direct link to Router">​</a></h3><p>The <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/app/scripts/router.js" target="_blank" rel="noopener noreferrer">Router</a> is responsible for reacting to URL changes and displaying the Views.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="views">Views<a href="#views" class="hash-link" aria-label="Direct link to Views" title="Direct link to Views">​</a></h3><p><a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/app/scripts/views" target="_blank" rel="noopener noreferrer">Views</a> represent either an entire screen or a portion of a screen. Views react to user input, and often call
<a href="#brokers">Broker</a> methods to determine where the user should be sent after a successful form submission. Screen
level views are rendered by the <a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-content-server/app/scripts/views/app.js" target="_blank" rel="noopener noreferrer">AppView</a>. See <a href="#view-deepdive">View Deepdive</a> for more info.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="templates">Templates<a href="#templates" class="hash-link" aria-label="Direct link to Templates" title="Direct link to Templates">​</a></h3><p>A <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/app/scripts/templates" target="_blank" rel="noopener noreferrer">template</a> is a serialized HTML representation of a View. A view renders a template using data available to it and writes the rendered template to the DOM. Templates use the <a href="http://mustache.github.io/" target="_blank" rel="noopener noreferrer">mustache</a> template library.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="clients">Clients<a href="#clients" class="hash-link" aria-label="Direct link to Clients" title="Direct link to Clients">​</a></h3><p>Communication with external servers are done via client libraries.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="fxa-js-client">fxa-js-client<a href="#fxa-js-client" class="hash-link" aria-label="Direct link to fxa-js-client" title="Direct link to fxa-js-client">​</a></h4><p>The <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-auth-client" target="_blank" rel="noopener noreferrer">fxa-auth-client</a> communicates with the Firefox Accounts <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-auth-server/" target="_blank" rel="noopener noreferrer">Auth Server</a>. The fxa-js-client is used for all aspects of authenticating a user - sign up, sign in, password reset, etc.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="oauth-client">oauth-client<a href="#oauth-client" class="hash-link" aria-label="Direct link to oauth-client" title="Direct link to oauth-client">​</a></h4><p>The <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/app/scripts/lib/oauth-client.js" target="_blank" rel="noopener noreferrer">oauth-client</a> used to communicate with the Firefox Accounts OAuth Server and now communicates with the OAuth endpoints on the Auth server. The OAuth client is used to fetch OAuth codes and tokens to send to the RP.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="profile-client"><a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/app/scripts/lib/profile-client.js" target="_blank" rel="noopener noreferrer">profile-client</a><a href="#profile-client" class="hash-link" aria-label="Direct link to profile-client" title="Direct link to profile-client">​</a></h4><p>The profile-client communicates with the Firefox Accounts <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-profile-server/" target="_blank" rel="noopener noreferrer">Profile Server</a>. This client allows a user to interact with their profile data.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="application-lifecycle">Application lifecycle<a href="#application-lifecycle" class="hash-link" aria-label="Direct link to Application lifecycle" title="Direct link to Application lifecycle">​</a></h2><p>When the application starts, <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/app/scripts/lib/app-start.js" target="_blank" rel="noopener noreferrer">app-start.js</a> takes care of setting up system-wide dependencies. app-start immediately determines the integration type and creates the appropriate <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/blob/8561ec3c1d06763f454f4ac7cb8ef142eb0c01b0/app/scripts/lib/app-start.js#L234" target="_blank" rel="noopener noreferrer">Broker</a> and <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/blob/8561ec3c1d06763f454f4ac7cb8ef142eb0c01b0/app/scripts/lib/app-start.js#L199" target="_blank" rel="noopener noreferrer">Relier</a>. The broker is queried to check support of the current integration. If the integration is supported, other models and the <a href="https://github.com/mozilla/qfxa/tree/main/packages/fxa-content-server/blob/8561ec3c1d06763f454f4ac7cb8ef142eb0c01b0/app/scripts/lib/app-start.js#L315" target="_blank" rel="noopener noreferrer">router</a> are created. The router takes over and determines the initial View to display based on the browser&#x27;s URL. The router creates the View, which in turn writes a template to the DOM. The user interacts with the View, either by filling out a form or clicking on links and buttons. A view can communicate with external servers using clients or via an Account model. Views usually invoke broker methods to determine next steps, which could be to redirect to another view, display a status message, or stop. Upon successful authentication with Firefox Accounts, the broker is notified, which in turn notifies a RP. The RP is responsible for the final fate of the Firefox Accounts tab. In the case of OAuth redirect, FxA redirects to the RP. In the case of Sync or a WebExtension, the tab may be closed automatically, or the user may have to close the tab themselves.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="view-deepdive">View Deepdive<a href="#view-deepdive" class="hash-link" aria-label="Direct link to View Deepdive" title="Direct link to View Deepdive">​</a></h2><p>View take care of all things UI. Each view has access to several models and libraries, the most commonly used are:</p><ul><li><a href="#brokers">Broker</a> (this.broker)</li><li><a href="#reliers">Relier</a> (this.relier)</li><li><a href="#user">User</a> (this.user)</li></ul><p>Even though React wasn&#x27;t a thing, FxA views have their own lifecylce methods
for <a href="#render-lifecycle-metohds">rendering</a> and <a href="#submit-lifecycle-methods">form submission</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="baseview">BaseView<a href="#baseview" class="hash-link" aria-label="Direct link to BaseView" title="Direct link to BaseView">​</a></h3><p><a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-content-server/app/scripts/views/base.js" target="_blank" rel="noopener noreferrer">BaseView</a> is the parent of all Views. BaseView is responsible for rendering deciding whether to render a view, and if so, for rendering. BaseView also takes care of status messages, hooking up DOM events, <a href="#l10n">l10n</a>, and logging. BaseView does <em>not</em> take care of any form handling, for that, see <a href="#formview">FormView</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="rendering-templates">Rendering templates<a href="#rendering-templates" class="hash-link" aria-label="Direct link to Rendering templates" title="Direct link to Rendering templates">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="setinitialcontext">setInitialContext<a href="#setinitialcontext" class="hash-link" aria-label="Direct link to setInitialContext" title="Direct link to setInitialContext">​</a></h4><p><code>setInitialContext</code> is used to pass data to the Mustache template and is often overridden:</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token method function property-access" style="color:#d73a49">setInitialContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">email</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getAccount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;email&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="render-lifecycle-methods">Render lifecycle methods<a href="#render-lifecycle-methods" class="hash-link" aria-label="Direct link to Render lifecycle methods" title="Direct link to Render lifecycle methods">​</a></h4><table><thead><tr><th>method name</th><th>purpose</th></tr></thead><tbody><tr><td>beforeRender</td><td>Called before <code>renderTemplate</code>, can return a promise. If resolves to <code>false</code>, rendering is aborted, can be used to redirect a user to a different screen if pre-conditions are not met.</td></tr><tr><td>renderTemplate</td><td>Renders the template with <a href="#setinitialcontext">context</a>. Rarely overridden.</td></tr><tr><td>afterRender</td><td>Called after <code>renderTemplate</code>, can return a promise. If resolves to <code>false</code>, view is not displayed, can be used to redirect a user to a different screen if pre-conditions are not met. Often used by mixins to initialize based on elements in view.$el before being added to the DOM.</td></tr><tr><td>afterVisible</td><td>Called after a screen has been added to the DOM.</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="formview">FormView<a href="#formview" class="hash-link" aria-label="Direct link to FormView" title="Direct link to FormView">​</a></h3><p>Extend from <a href="https://github.com/mozilla/fxa/blob/5c527d8007c416b2f6122d8081f7756f8bc6733b/packages/fxa-content-server/app/scripts/views/form.js#L1" target="_blank" rel="noopener noreferrer">FormView</a> for any Views that contain a form that can be submit.
FormView takes care of several aspects of form submission:</p><ul><li>Ensure only one form submission can be in flight at a time</li><li>Form validation</li><li>Print submit error messages</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="submit-lifecycle-methods">Submit lifecycle methods<a href="#submit-lifecycle-methods" class="hash-link" aria-label="Direct link to Submit lifecycle methods" title="Direct link to Submit lifecycle methods">​</a></h4><table><thead><tr><th>method name</th><th>purpose</th></tr></thead><tbody><tr><td>isValidStart</td><td>Perform validation before individual input elements are validated. Return <code>false</code> to indicate form is invalid.</td></tr><tr><td>isValidEnd</td><td>Perform validation after individual input elements are validated. Return <code>false</code> to indicate form is invalid.</td></tr><tr><td>showValidationErrorsStart</td><td>Show validation errors before individual invalid input elements add their tooltips. If a truthy value is returned, no other validation errors are displayed.</td></tr><tr><td>showValidationErrorsEnd</td><td>Show validation errors after individual invalid input elements add their tooltips.</td></tr><tr><td>beforeSubmit</td><td>Called if form is valid, before <code>submit</code>. Can return a promise. Resolve to <code>false</code> to prevent <code>submit</code> from being called.</td></tr><tr><td>submit</td><td><strong>MUST BE OVERRIDDEN</strong> Do the form submission. Can return a promise. If promise rejects, the error will be displayed as an error message.</td></tr><tr><td>afterSubmit</td><td>Called after the <code>submit</code>. Can be used for cleanup housekeeping.</td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_LWe7" id="showing-validation-errors">Showing validation errors<a href="#showing-validation-errors" class="hash-link" aria-label="Direct link to Showing validation errors" title="Direct link to Showing validation errors">​</a></h4><p>The <a href="https://github.com/mozilla/fxa/blob/5c527d8007c416b2f6122d8081f7756f8bc6733b/packages/fxa-content-server/app/scripts/views/form.js#L379" target="_blank" rel="noopener noreferrer">showValidationError</a> method is used to show validation errors on an individual input element, this is most commonly done in <code>showValidationErrorsStart</code> or <code>showValidationErrorsEnd</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="mixins">Mixins<a href="#mixins" class="hash-link" aria-label="Direct link to Mixins" title="Direct link to Mixins">​</a></h3><p>The content server front-end relies heavily on <a href="https://github.com/onsi/cocktail" target="_blank" rel="noopener noreferrer">Cocktail based mixins</a>. Mixins enable code extraction into standalone modules that are &quot;mixed into&quot; other modules. Mixins have several purposes within FxA:</p><ol><li>Share functionality across modules without relying on inheritance.</li><li>Isolate experiment code. If the experiment is deemed a failure,
removing the experiment means removing the mixin rather than updating core View logic.</li><li>Isolate related tasks to simplify reasoning.</li></ol><p>Method name collision between a mixin and a mixed-in View is allowed and frequently used, understanding <a href="https://github.com/onsi/cocktail#but-what-about-collisions" target="_blank" rel="noopener noreferrer">Cocktail&#x27;s collision handling</a> is important to avoid any surprises, especially
relating to return values.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="screen-screen-navigation">screen-&gt;screen navigation<a href="#screen-screen-navigation" class="hash-link" aria-label="Direct link to screen-&gt;screen navigation" title="Direct link to screen-&gt;screen navigation">​</a></h3><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">navigate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;confirm_signin&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// fields here are passed to the next view</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">account</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getAccount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>confirm_signin</code> view can access the data passed from the previous view:</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> account </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;account&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="more-useful-info">More useful info<a href="#more-useful-info" class="hash-link" aria-label="Direct link to More useful info" title="Direct link to More useful info">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="adding-a-new-route">Adding a new route<a href="#adding-a-new-route" class="hash-link" aria-label="Direct link to Adding a new route" title="Direct link to Adding a new route">​</a></h3><ol><li>Create a new View module if needed</li><li>Add a <a href="https://github.com/mozilla/fxa/blob/5c527d8007c416b2f6122d8081f7756f8bc6733b/packages/fxa-content-server/app/scripts/lib/router.js#L98" target="_blank" rel="noopener noreferrer">route entry to the frontend</a></li><li>Add a <a href="https://github.com/mozilla/fxa/blob/5c527d8007c416b2f6122d8081f7756f8bc6733b/packages/fxa-content-server/server/lib/routes/get-frontend.js#L8" target="_blank" rel="noopener noreferrer">route entry to the backend</a></li><li>Add a <a href="https://github.com/mozilla/fxa/blob/5c527d8007c416b2f6122d8081f7756f8bc6733b/packages/fxa-content-server/tests/server/routes.js#L28" target="_blank" rel="noopener noreferrer">test to ensure the new route responds with a 200</a></li><li>Add some functional tests</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="server-errors-and-error-messages">Server errors and error messages<a href="#server-errors-and-error-messages" class="hash-link" aria-label="Direct link to Server errors and error messages" title="Direct link to Server errors and error messages">​</a></h3><p>Any time a new error is added <a href="https://github.com/mozilla/fxa/blob/82553801812397f6fdbbbb748580ee8319a0a542/packages/fxa-auth-server/lib/error.js#L12" target="_blank" rel="noopener noreferrer">to the auth-server</a>, a corresponding entry needs to be added <a href="https://github.com/mozilla/fxa/blob/82553801812397f6fdbbbb748580ee8319a0a542/packages/fxa-content-server/app/scripts/lib/auth-errors.js#L28" target="_blank" rel="noopener noreferrer">to the content server</a> to ensure the error text
is translated.</p><p>Error messages can be customized depending if it makes sense for a particular context by setting the
<code>forceMessage</code> property on an error before display. See <a href="https://github.com/mozilla/fxa/blob/82553801812397f6fdbbbb748580ee8319a0a542/packages/fxa-content-server/app/scripts/views/mixins/signin-mixin.js#L135:L141" target="_blank" rel="noopener noreferrer">this example</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="closing-fxa-and-metrics-aka---missing-metrics">Closing FxA and metrics (aka - missing metrics)<a href="#closing-fxa-and-metrics-aka---missing-metrics" class="hash-link" aria-label="Direct link to Closing FxA and metrics (aka - missing metrics)" title="Direct link to Closing FxA and metrics (aka - missing metrics)">​</a></h3><p>When redirecting to an external site, e.g., an OAuth RP, the content server makes its best attempt
at flushing metrics in an <a href="https://github.com/mozilla/fxa/blob/82553801812397f6fdbbbb748580ee8319a0a542/packages/fxa-content-server/app/scripts/lib/metrics.js#L192" target="_blank" rel="noopener noreferrer"><code>unload</code> handler</a>. The problem with depending on <code>unload</code> handlers
is this only works <em>some of the time</em>. The <code>unload</code> handler is ignored on iOS, so we have to
ensure metrics are flushed before a redirect happens.</p><p>A common problem is setting <code>navigator.location.href = url</code> from within view code without first
flushing metrics. Instead of setting <code>location.href</code>, call <code>this.navigateAway</code> which will ensure
A common problem is setting <code>navigator.location.href = url</code> from within view code.
metrics are flushed. <code>href</code>s from anchor elements are automatically handled by the
<a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-content-server/app/scripts/views/mixins/external-links-mixin.js" target="_blank" rel="noopener noreferrer">ExternalLinksMixin</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="user-data-stored-on-device">User data stored on device<a href="#user-data-stored-on-device" class="hash-link" aria-label="Direct link to User data stored on device" title="Direct link to User data stored on device">​</a></h3><p>Some user data is stored in localStorage to smooth out repeated auth requests and ensure consistent
experiment choices across users.</p><p>All FxA related information is keyed with a <code>__fxa_storage.</code> prefix.</p><p>Account data of all users is located under <code>__fxa_storage.accounts</code>. The entry
is an object where the keys are account UIDs and the values are serialized account
data.</p><p>In environments that support the <code>fxaccounts:fxa_status</code> WebChannel message,
account data stored in localStorage is merged with the <code>signedInUser</code> field
of the <code>fxaccounts:fxa_status</code> response.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="keeping-tabs-synchronized">Keeping tabs synchronized<a href="#keeping-tabs-synchronized" class="hash-link" aria-label="Direct link to Keeping tabs synchronized" title="Direct link to Keeping tabs synchronized">​</a></h3><p>If multiple FxA tabs are open, we try to keep tab signin state synchronized as much
as possible. Whenever the user signs in or out, <a href="https://developer.mozilla.org/docs/Web/API/BroadcastChannel" target="_blank" rel="noopener noreferrer">BroadcastChannel</a>
messages are sent to all other FxA tabs. Whenever another tab receives a message, it responds
appropriately.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="localization">Localization<a href="#localization" class="hash-link" aria-label="Direct link to Localization" title="Direct link to Localization">​</a></h3><p>See <a href="/ecosystem-platform/reference/localization">L10n in the content and auth servers</a>.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/mozilla/ecosystem-platform/edit/master/docs/explanation/content-server-architecture.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/ecosystem-platform/explanation/architectural-decision-records"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Architectural Decision Records</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/ecosystem-platform/explanation/metrics"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Metrics</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#document-purpose" class="table-of-contents__link toc-highlight">Document purpose</a></li><li><a href="#helpful-to-know-before-starting" class="table-of-contents__link toc-highlight">Helpful to know before starting</a><ul><li><a href="#relying-party-integrations" class="table-of-contents__link toc-highlight">Relying Party Integrations</a></li></ul></li><li><a href="#content-server-architecture-basics" class="table-of-contents__link toc-highlight">Content server architecture basics</a></li><li><a href="#high-level-web-client-components" class="table-of-contents__link toc-highlight">High Level Web Client Components</a><ul><li><a href="#auth-brokers" class="table-of-contents__link toc-highlight">Auth-Brokers</a></li><li><a href="#channels" class="table-of-contents__link toc-highlight">Channels</a></li><li><a href="#reliers" class="table-of-contents__link toc-highlight">Reliers</a></li><li><a href="#user" class="table-of-contents__link toc-highlight">User</a></li><li><a href="#account" class="table-of-contents__link toc-highlight">Account</a></li><li><a href="#router" class="table-of-contents__link toc-highlight">Router</a></li><li><a href="#views" class="table-of-contents__link toc-highlight">Views</a></li><li><a href="#templates" class="table-of-contents__link toc-highlight">Templates</a></li><li><a href="#clients" class="table-of-contents__link toc-highlight">Clients</a></li></ul></li><li><a href="#application-lifecycle" class="table-of-contents__link toc-highlight">Application lifecycle</a></li><li><a href="#view-deepdive" class="table-of-contents__link toc-highlight">View Deepdive</a><ul><li><a href="#baseview" class="table-of-contents__link toc-highlight">BaseView</a></li><li><a href="#rendering-templates" class="table-of-contents__link toc-highlight">Rendering templates</a></li><li><a href="#formview" class="table-of-contents__link toc-highlight">FormView</a></li><li><a href="#mixins" class="table-of-contents__link toc-highlight">Mixins</a></li><li><a href="#screen-screen-navigation" class="table-of-contents__link toc-highlight">screen-&gt;screen navigation</a></li></ul></li><li><a href="#more-useful-info" class="table-of-contents__link toc-highlight">More useful info</a><ul><li><a href="#adding-a-new-route" class="table-of-contents__link toc-highlight">Adding a new route</a></li><li><a href="#server-errors-and-error-messages" class="table-of-contents__link toc-highlight">Server errors and error messages</a></li><li><a href="#closing-fxa-and-metrics-aka---missing-metrics" class="table-of-contents__link toc-highlight">Closing FxA and metrics (aka - missing metrics)</a></li><li><a href="#user-data-stored-on-device" class="table-of-contents__link toc-highlight">User data stored on device</a></li><li><a href="#keeping-tabs-synchronized" class="table-of-contents__link toc-highlight">Keeping tabs synchronized</a></li><li><a href="#localization" class="table-of-contents__link toc-highlight">Localization</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Mozilla Corporation.</div></div></div></footer></div>
<script src="/ecosystem-platform/assets/js/runtime~main.44530cc2.js"></script>
<script src="/ecosystem-platform/assets/js/main.836b3ab5.js"></script>
</body>
</html>