"use strict";(self.webpackChunkfirefox_ecosystem_platform=self.webpackChunkfirefox_ecosystem_platform||[]).push([[1947],{27479:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>a,contentTitle:()=>s,default:()=>d,frontMatter:()=>l,metadata:()=>o,toc:()=>c});const o=JSON.parse('{"id":"reference/third-party-authentication","title":"Third Party Authentication","description":"Last updated: Sep 06th, 2023","source":"@site/docs/reference/third-party-authentication.md","sourceDirName":"reference","slug":"/reference/third-party-authentication","permalink":"/ecosystem-platform/reference/third-party-authentication","draft":false,"unlisted":false,"editUrl":"https://github.com/mozilla/ecosystem-platform/edit/master/docs/reference/third-party-authentication.md","tags":[],"version":"current","frontMatter":{"title":"Third Party Authentication"},"sidebar":"docs","previous":{"title":"System Diagrams","permalink":"/ecosystem-platform/reference/system-diagrams"},"next":{"title":"Tokens","permalink":"/ecosystem-platform/reference/tokens"}}');var r=n(74848),i=n(28453);const l={title:"Third Party Authentication"},s=void 0,a={},c=[{value:"Design",id:"design",level:3},{value:"How to enable third party authentication for relying party",id:"how-to-enable-third-party-authentication-for-relying-party",level:3},{value:"How to setup Google auth locally",id:"how-to-setup-google-auth-locally",level:3},{value:"How to setup Apple auth locally",id:"how-to-setup-apple-auth-locally",level:3},{value:"Auth server config",id:"auth-server-config",level:4},{value:"Content server config",id:"content-server-config",level:4},{value:"How to view third party authentication screen",id:"how-to-view-third-party-authentication-screen",level:3},{value:"How to setup local env for https",id:"how-to-setup-local-env-for-https",level:3},{value:"How Apple auth generates secrets",id:"how-apple-auth-generates-secrets",level:3}];function h(e){const t={a:"a",admonition:"admonition",code:"code",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(t.p,{children:["Last updated: ",(0,r.jsx)(t.code,{children:"Sep 06th, 2023"})]}),"\n",(0,r.jsx)(t.p,{children:"FxA currently supports Apple and Google as third party authentication providers."}),"\n",(0,r.jsx)(t.h3,{id:"design",children:"Design"}),"\n",(0,r.jsxs)(t.p,{children:["For both Google and Apple authentication we use the oauth authorization code flow. The scopes requested are the default account\nprofile scopes for a user, ",(0,r.jsx)(t.code,{children:"openid email profile"}),". Using this flow allows FxA to not require loading any additional\nlibraries on our domain."]}),"\n",(0,r.jsxs)(t.p,{children:["At the end of the third party oauth flow, FxA receives an OpenID connect ",(0,r.jsx)(t.code,{children:"id_token"})," and uses that to create\nthe associated FxA account. After successfully creating a Firefox account, a session token is created\nand then the user is sent through the FxA OAuth flow and redirected back to the relying party. Note that\nat the end of this flow, the relying party gets an FxA OAuth token."]}),"\n",(0,r.jsxs)(t.p,{children:["Please reference the ",(0,r.jsx)(t.a,{href:"https://docs.google.com/document/d/1pFzugkDOIR6eoXrBCx9FWWJhfnxFgWnRtk2mWFOp8DQ/edit#heading=h.qrbb2drvq5dg",children:"feature doc"})," for\nadditional design details and flow charts. Note also the ",(0,r.jsx)(t.a,{href:"https://developer.apple.com/sign-in-with-apple/usage-guidelines-for-websites-and-other-platforms/",children:"Apple Usage Guidelines"}),"."]}),"\n",(0,r.jsx)(t.h3,{id:"how-to-enable-third-party-authentication-for-relying-party",children:"How to enable third party authentication for relying party"}),"\n",(0,r.jsx)(t.p,{children:"Third party authentication is currently enabled for all relying on parties (except Sync). If a user only has a linked third party account and no password then attempts to login to Sync, they will be prompted to create a password."}),"\n",(0,r.jsx)(t.h3,{id:"how-to-setup-google-auth-locally",children:"How to setup Google auth locally"}),"\n",(0,r.jsx)(t.p,{children:"To enable Google auth locally, you will need to create a new OAuth client in the Google Cloud Console."}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsxs)(t.li,{children:["\n",(0,r.jsxs)(t.p,{children:["Go to ",(0,r.jsx)(t.a,{href:"https://console.cloud.google.com",children:"Google Cloud Console"})," and sign in with your Mozilla account if needed."]}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["\n",(0,r.jsxs)(t.p,{children:["Click the project picker (top bar), then choose ",(0,r.jsx)(t.strong,{children:"New Project"}),"."]}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Project name:"})," Whatever you like (e.g. ",(0,r.jsx)(t.code,{children:"YourName FxA Dev"}),")"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Organization:"})," ",(0,r.jsx)(t.code,{children:"firefox.gcp.mozilla.com"})]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Location:"})," ",(0,r.jsx)(t.code,{children:"developers"})]}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Create"}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["\n",(0,r.jsxs)(t.p,{children:["Go to ",(0,r.jsx)(t.a,{href:"https://console.cloud.google.com/auth/clients",children:"Auth Clients"})," for your new project and click ",(0,r.jsx)(t.strong,{children:"Create Client"}),"."]}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Application type:"})," Web application"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Name:"})," Whatever you like (e.g. ",(0,r.jsx)(t.code,{children:"Mozilla Accounts"}),")"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Authorized JavaScript origins:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"http://localhost:3030"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"http://localhost"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Authorized redirect URIs:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"http://localhost:3030/oauth/signin"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"http://localhost:3030/post_verify/third_party_auth/callback"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Create"}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["\n",(0,r.jsxs)(t.p,{children:["Your client ID and client secret will be shown. Set these credentials in your ",(0,r.jsx)(t.code,{children:".env"}),":"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"GOOGLE_AUTH_CLIENT_ID=your-client-id\nGOOGLE_AUTH_SECURITY_EVENTS_CLIENT_IDS=your-client-id\nGOOGLE_AUTH_CLIENT_SECRET=your-client-secret\n"})}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["\n",(0,r.jsxs)(t.p,{children:["Go to ",(0,r.jsx)(t.strong,{children:"Audience"}),' and publish the app so you can use any Google account locally. You may see the publishing status set to "Testing" \u2014 click ',(0,r.jsx)(t.strong,{children:"Publish App"}),' and confirm "Push to production". Either option (Testing or In Production) will work, but "Testing" requires you to add allowed test emails.']}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["\n",(0,r.jsxs)(t.p,{children:["You may need to wait several minutes before the client is fully activated. Do a full ",(0,r.jsx)(t.code,{children:"yarn stop"})," and then start with dotenv:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"dotenv -- yarn start mza\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(t.admonition,{type:"note",children:(0,r.jsxs)(t.p,{children:["You may need to clear out any old values set in configs, as you can also have these values set in auth-server and content-server config files instead of using environment variables. If after restarting and trying to log in with Google the client ID in the URL does not match the value you set in your ",(0,r.jsx)(t.code,{children:".env"}),", search the repo for ",(0,r.jsx)(t.code,{children:"googleAuthConfig"})," to make sure it's not set in a different gitignored file."]})}),"\n",(0,r.jsx)(t.h3,{id:"how-to-setup-apple-auth-locally",children:"How to setup Apple auth locally"}),"\n",(0,r.jsxs)(t.p,{children:["To create an Apple OAuth client you will need to have an Apple developer account. To run Apple authentication locally you\nwill also need to have https unfortunately, see ",(0,r.jsx)(t.a,{href:"#how-to-setup-local-env-for-https",children:"setup instructions"}),"."]}),"\n",(0,r.jsx)(t.h4,{id:"auth-server-config",children:"Auth server config"}),"\n",(0,r.jsxs)(t.p,{children:["Update the auth server ",(0,r.jsx)(t.a,{href:"https://github.com/mozilla/fxa/blob/e31b9deb2d7e6ca89b9fc932f2c4f0fa0a89e93c/packages/fxa-auth-server/config/index.ts#L140",children:"config"})," to reflect the current client."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"  appleAuthConfig: {\n    clientId: {\n      default: 'com.mozilla.firefox.accounts.auth',\n      env: 'APPLE_AUTH_CLIENT_ID',\n      format: String,\n      doc: 'Apple auth client id',\n    },\n    clientSecret: {\n      default: 'SSHH',\n      env: 'APPLE_AUTH_CLIENT_SECRET',\n      format: String,\n      doc: 'Apple auth client secret',\n    },\n    redirectUri: {\n      default:\n        'https://localhost.dev:3030/post_verify/third_party_auth/callback',\n      env: 'APPLE_AUTH_REDIRECT_URI',\n      format: String,\n      doc: 'Apple auth redirect uri',\n    },\n    tokenEndpoint: {\n      default: 'https://appleid.apple.com/auth/token',\n      env: 'APPLE_AUTH_TOKEN_ENDPOINT',\n      format: String,\n      doc: 'Apple auth token endpoint',\n    },\n  },\n"})}),"\n",(0,r.jsx)(t.h4,{id:"content-server-config",children:"Content server config"}),"\n",(0,r.jsxs)(t.p,{children:["Update config to reflect your ",(0,r.jsx)(t.a,{href:"https://github.com/mozilla/fxa/blob/e31b9deb2d7e6ca89b9fc932f2c4f0fa0a89e93c/packages/fxa-content-server/server/lib/configuration.js#L272",children:"client"}),"."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"  appleAuthConfig: {\n    enabled: {\n      default: true,\n      env: 'APPLE_AUTH_ENABLED',\n      format: String,\n    },\n    clientId: {\n      default: 'com.mozilla.firefox.accounts.auth',\n      env: 'APPLE_AUTH_CLIENT_ID',\n      format: String,\n      doc: 'Apple auth client id',\n    },\n    redirectUri: {\n      default:\n        'https://localhost.dev:3030/post_verify/third_party_auth/callback',\n      env: 'APPLE_AUTH_REDIRECT_URI',\n      format: String,\n      doc: 'Apple auth redirect uri',\n    },\n    authorizationEndpoint: {\n      default: 'https://appleid.apple.com/auth/authorize',\n      env: 'APPLE_AUTH_AUTHORIZATION_ENDPOINT',\n      format: String,\n      doc: 'Apple auth token endpoint',\n    },\n  },\n"})}),"\n",(0,r.jsx)(t.h3,{id:"how-to-view-third-party-authentication-screen",children:"How to view third party authentication screen"}),"\n",(0,r.jsxs)(t.p,{children:["Once Apple and Google clients are configured, you can simply open ",(0,r.jsx)(t.code,{children:"http://localhost:3030/?forceExperiment=thirdPartyAuth&forceExperimentGroup=google"}),"."]}),"\n",(0,r.jsx)(t.h3,{id:"how-to-setup-local-env-for-https",children:"How to setup local env for https"}),"\n",(0,r.jsxs)(t.p,{children:["For local https you can use ",(0,r.jsx)(t.a,{href:"https://github.com/FiloSottile/mkcert",children:"mkcert"})," to create your certs. Once those are created you will need to update your host file to point to the https enabled domain."]}),"\n",(0,r.jsxs)(t.p,{children:["Ex. On OSX you can run ",(0,r.jsx)(t.code,{children:"sudo nano /etc/hosts"})," and add ",(0,r.jsx)(t.code,{children:"localhost.dev"})," for https"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"##\n# Host Database\n#\n# localhost is used to configure the loopback interface\n# when the system is booting.  Do not change this entry.\n##\n127.0.0.1       localhost\n127.0.0.1       localhost.dev\n"})}),"\n",(0,r.jsxs)(t.p,{children:["To enable auth and content server to run in https mode you will need to update ",(0,r.jsx)(t.a,{href:"https://github.com/mozilla/fxa/blob/e31b9deb2d7e6ca89b9fc932f2c4f0fa0a89e93c/packages/fxa-content-server/server/lib/configuration.js#L385",children:"config"})," to specify a key file from mkcert and toggle ",(0,r.jsx)(t.code,{children:"use_https"})," to true."]}),"\n",(0,r.jsx)(t.h3,{id:"how-apple-auth-generates-secrets",children:"How Apple auth generates secrets"}),"\n",(0,r.jsxs)(t.p,{children:["All Apple login requests generate a secret just for that request. It follows the same process found in this ",(0,r.jsx)(t.a,{href:"https://developer.okta.com/blog/2019/06/04/what-the-heck-is-sign-in-with-apple",children:"blog"}),"."]})]})}function d(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>l,x:()=>s});var o=n(96540);const r={},i=o.createContext(r);function l(e){const t=o.useContext(i);return o.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),o.createElement(i.Provider,{value:t},e.children)}}}]);