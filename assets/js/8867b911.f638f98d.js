"use strict";(self.webpackChunkfirefox_ecosystem_platform=self.webpackChunkfirefox_ecosystem_platform||[]).push([[3783],{27875:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>r,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"reference/rate-limiting","title":"Rate limiting","description":"Fastly Next-Gen WAF","source":"@site/docs/reference/rate-limiting.md","sourceDirName":"reference","slug":"/reference/rate-limiting","permalink":"/ecosystem-platform/reference/rate-limiting","draft":false,"unlisted":false,"editUrl":"https://github.com/mozilla/ecosystem-platform/edit/master/docs/reference/rate-limiting.md","tags":[],"version":"current","frontMatter":{"title":"Rate limiting"},"sidebar":"docs","previous":{"title":"OAuth Details","permalink":"/ecosystem-platform/reference/oauth-details"},"next":{"title":"Storybook Deploys with CircleCI","permalink":"/ecosystem-platform/reference/storybook-deploys-with-circleci"}}');var s=n(74848),o=n(28453);const r={title:"Rate limiting"},a="Rate Limiting",l={},c=[{value:"Fastly Next-Gen WAF",id:"fastly-next-gen-waf",level:2},{value:"Updating settings and custom rules",id:"updating-settings-and-custom-rules",level:3},{value:"Blocking/unblock emergencies",id:"blockingunblock-emergencies",level:3},{value:"Triage (WIP)",id:"triage-wip",level:3},{value:"Customs V2",id:"customs-v2",level:2},{value:"Defining Rules",id:"defining-rules",level:3},{value:"Property Options",id:"property-options",level:3},{value:"Policy Options",id:"policy-options",level:3},{value:"The &#39;default&#39; Rule",id:"the-default-rule",level:3},{value:"Testing &amp; Development Considerations",id:"testing--development-considerations",level:3},{value:"Exclude specific attributes like ip, email, or UID",id:"exclude-specific-attributes-like-ip-email-or-uid",level:4},{value:"Auth Server specifics",id:"auth-server-specifics",level:3},{value:"Graphql Specifics",id:"graphql-specifics",level:3},{value:"New Blocking Scenarios",id:"new-blocking-scenarios",level:3},{value:"FAQ",id:"faq",level:2},{value:"How is it different from V1?",id:"how-is-it-different-from-v1",level:3},{value:"Why the rewrite?",id:"why-the-rewrite",level:3},{value:"Great, can I just turn it off? It\u2019s annoying while developing\u2026",id:"great-can-i-just-turn-it-off-its-annoying-while-developing",level:3},{value:"What\u2019s the difference between a block, a ban, and report policy again?",id:"whats-the-difference-between-a-block-a-ban-and-report-policy-again",level:3},{value:"What\u2019s up with the \u2018default\u2019 rule again?",id:"whats-up-with-the-default-rule-again",level:3},{value:"I\u2019m adding a new rule but I\u2019m concerned about the impact, can I monitor this?",id:"im-adding-a-new-rule-but-im-concerned-about-the-impact-can-i-monitor-this",level:3},{value:"Once a user is blocked, do they get unblocked? How does this work exactly?",id:"once-a-user-is-blocked-do-they-get-unblocked-how-does-this-work-exactly",level:3},{value:"A user is having trouble with being blocked. Can I help them?",id:"a-user-is-having-trouble-with-being-blocked-can-i-help-them",level:3},{value:"Legacy Customs V1 Docs (Kept for historical Record, will be removed!)",id:"legacy-customs-v1-docs-kept-for-historical-record-will-be-removed",level:2},{value:"Policies",id:"policies",level:3},{value:"Usage in Auth-server",id:"usage-in-auth-server",level:3}];function d(e){const i={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(i.header,{children:(0,s.jsx)(i.h1,{id:"rate-limiting",children:"Rate Limiting"})}),"\n",(0,s.jsx)(i.h2,{id:"fastly-next-gen-waf",children:"Fastly Next-Gen WAF"}),"\n",(0,s.jsxs)(i.p,{children:["Fastly Next-Gen WAF is the company-wide solution implemented to protect our publicly available web services from web-application and DDoS attacks. The Product Security team provides support for the WAF and maintains ",(0,s.jsx)(i.a,{href:"https://mozilla-hub.atlassian.net/wiki/spaces/SECURITY/pages/1655931003/Fastly+WAF+Service+offering",children:"the docs"}),".  FxA's responsibility is to configure, fine-tune, and monitor WAF metrics and logs regularly.  The following public FxA endpoints are behind the WAF:"]}),"\n",(0,s.jsx)(i.p,{children:"Stage"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsx)(i.li,{children:"accounts.stage.mozaws.net"}),"\n",(0,s.jsx)(i.li,{children:"api-accounts.stage.mozaws.net"}),"\n",(0,s.jsx)(i.li,{children:"eventbroker.accounts.allizom.org"}),"\n",(0,s.jsx)(i.li,{children:"fxa-graphql-api.stage.mozaws.net"}),"\n",(0,s.jsx)(i.li,{children:"oauth.stage.mozaws.net"}),"\n",(0,s.jsx)(i.li,{children:"payments-next.allizom.org"}),"\n",(0,s.jsx)(i.li,{children:"payments-server.allizom.org"}),"\n",(0,s.jsx)(i.li,{children:"profile.stage.mozaws.net"}),"\n"]}),"\n",(0,s.jsx)(i.p,{children:"Production"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsx)(i.li,{children:"profile.accounts.firefox.com"}),"\n",(0,s.jsx)(i.li,{children:"api.accounts.firefox.com"}),"\n",(0,s.jsx)(i.li,{children:"accounts.firefox.com"}),"\n",(0,s.jsx)(i.li,{children:"oauth.accounts.firefox.com"}),"\n",(0,s.jsx)(i.li,{children:"graphql.accounts.firefox.com"}),"\n",(0,s.jsx)(i.li,{children:"eventbroker-prod.fxa.prod.cloudops.mozgcp.net"}),"\n",(0,s.jsx)(i.li,{children:"payments.firefox.com"}),"\n",(0,s.jsx)(i.li,{children:"subscriptions.firefox.com"}),"\n"]}),"\n",(0,s.jsx)(i.h3,{id:"updating-settings-and-custom-rules",children:"Updating settings and custom rules"}),"\n",(0,s.jsxs)(i.p,{children:["Settings and custom rules have been created and should be updated via Terraform. Find the settings files (",(0,s.jsx)(i.code,{children:"fxa/tf/stage/waf.tf"})," and ",(0,s.jsx)(i.code,{children:"fxa/tf/prod/waf.tf"}),') in the webservices-infra repository. Access to the dashboards for each endpoint are available via SSO (select "Sites" dropdown to choose an endpoint): ',(0,s.jsx)(i.a,{href:"https://dashboard.signalsciences.net/corps/mozilla/overview",children:"https://dashboard.signalsciences.net/corps/mozilla/overview"})]}),"\n",(0,s.jsx)(i.h3,{id:"blockingunblock-emergencies",children:"Blocking/unblock emergencies"}),"\n",(0,s.jsx)(i.p,{children:'From the overview dashboard of an endpoint, notice the green pill button at the top-right that reads "Blocking". In case of emergency, e.g. a false-positive block of a relying party, this can be switched to "Not blocking" to quickly and temporarily unblock all IPs. Preferably, we would instead identify a single IP to unblock under "Monitor > Events" and pressing the "Allow IP" button. Use the GUI to quickly unblock as needed, but if it\'s not an emergency commit changes using Terraform instead.'}),"\n",(0,s.jsx)(i.h3,{id:"triage-wip",children:"Triage (WIP)"}),"\n",(0,s.jsx)(i.p,{children:"Triage duty is still being worked out, however we should spend ~30 min monitoring activity each morning. In the future we might link WAF data to Grafana for a single source to monitor all endpoints.  For now, triage might include the following routine:"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsx)(i.li,{children:"visit each production endpoint"}),"\n",(0,s.jsx)(i.li,{children:'navigate to "Monitor > Events"'}),"\n",(0,s.jsx)(i.li,{children:'investigate each IP labeled "Active". These are actively being flagged/blocked and are mostly all obvious attackers.'}),"\n"]}),"\n",(0,s.jsx)(i.h2,{id:"customs-v2",children:"Customs V2"}),"\n",(0,s.jsx)(i.p,{children:"FxA now uses a rate-limit library that communicates with a dedicated Redis instance to conduct rate-limiting operations. The following is essentially just a rehashed version of the libraries readme file which can be found here. Always check the lib's readme for the most up to date doc!"}),"\n",(0,s.jsx)(i.h3,{id:"defining-rules",children:"Defining Rules"}),"\n",(0,s.jsx)(i.p,{children:"This library is driven by a simple grammar for defining rules. The grammar is as follows:"}),"\n",(0,s.jsx)(i.p,{children:(0,s.jsx)(i.code,{children:" ${action} : ${property} : ${attempts} : ${window} : ${duration} : ${policy}"})}),"\n",(0,s.jsx)(i.p,{children:"Where a 'section' is separated by ':' and leading and trailing whitespace within a section is trimmed.\nNote that comments can be added by starting a line with '#'. Adding comments explaining what the rulesets try to achieve is encouraged!"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.code,{children:"action"}),"   - This is the user action being checked and counted. For example, accountLogin would check when an account login is attempted."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.code,{children:"property"})," - The property/attribute we are counting for a given action. Options are ip, email, ip_email, uid and ip_uid."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.code,{children:"attempts"})," - Number of tries until the rule is considered violated and block (or ban) occurs"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.code,{children:"window"}),"   - Time span over which actions are counted. Once the window ends, actions are allowed again."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.code,{children:"duration"})," - How long the block (or ban) remains active. Note that while the block is active, attempts are not counted!"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.code,{children:"policy"}),"   - Determines what happens after a rate limit is exceeded. Options are block, ban, or report"]}),"\n"]}),"\n",(0,s.jsx)(i.h3,{id:"property-options",children:"Property Options"}),"\n",(0,s.jsx)(i.p,{children:"Here the valid options that can be provided in the property column, and their significance."}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsx)(i.li,{children:"ip        - The user's IP. This is often useful for 'ban' policies, where we want to flag an IP that is making a large number of requests."}),"\n",(0,s.jsx)(i.li,{children:"ip_email  - The user's IP with the user's email appended. This is useful for ensuring one user cannot impact another user's experience."}),"\n",(0,s.jsx)(i.li,{children:"email     - The user's email. This is useful only when the account isn't known and for some reason, we don't want to use ip_email."}),"\n",(0,s.jsx)(i.li,{children:"uid       - The user's account id. This can be useful for stopping a user that has logged in from doing something malicious, like trying to mine data."}),"\n",(0,s.jsx)(i.li,{children:"ip_uid    - The user's account id with the user's uid appended. This is useful for ensuring one user cannot impact another user's experience."}),"\n"]}),"\n",(0,s.jsx)(i.h3,{id:"policy-options",children:"Policy Options"}),"\n",(0,s.jsx)(i.p,{children:"The block on policy describes what happens when a rate limit is exceeded. Or in other words when a given block on property is has seen more than the\nthe allotted max attempts."}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsx)(i.li,{children:"block  - The action+property for the rule is no longer permitted until the duration expires or the user provides an unblock code on sign in and clears the block."}),"\n",(0,s.jsx)(i.li,{children:"ban    - Any and all rules for the given property are no longer permitted until the duration expires. Bans cannot be cleared by end users! So be very careful defining bans."}),"\n",(0,s.jsx)(i.li,{children:"report - The rule for the given action and property is only reported on, i.e. we emit metrics that can be monitored, but we do not actually block the action/property."}),"\n"]}),"\n",(0,s.jsx)(i.h3,{id:"the-default-rule",children:"The 'default' Rule"}),"\n",(0,s.jsx)(i.p,{children:"To avoid lots of repetitive configuration, we have one special rule known as the 'default' rule. This rule\nis used as a fallback in the event an action is supplied to the rate limiter, but it cannot be found in the\nset of configured rules. When the 'default' rule is used, the action count is still kept distinct per action,\nbut the policy from the default rule is used."}),"\n",(0,s.jsx)(i.p,{children:"For example, if we were to call"}),"\n",(0,s.jsx)(i.p,{children:(0,s.jsx)(i.code,{children:"rateLimit.check('foo', { ip:0.0.0.0})"})}),"\n",(0,s.jsx)(i.p,{children:"And our rules file looked like this:"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{children:"default : ip       : 100 : 10 minutes : 10 minutes : block\nbar     : ip_email : 5   : 10 minutes : 10 minutes : block\n"})}),"\n",(0,s.jsx)(i.p,{children:"Then we'd increment the redis count for action foo blocking on ip, but we'd use the default rule's settings to\ndetermine the rate limit. So the redis state would like this after calling check:"}),"\n",(0,s.jsx)(i.p,{children:(0,s.jsx)(i.code,{children:"rate-limit:attempts:ip=0.0.0.0:foo:100-600-600 => 1"})}),"\n",(0,s.jsx)(i.h3,{id:"testing--development-considerations",children:"Testing & Development Considerations"}),"\n",(0,s.jsx)(i.p,{children:"When developing new features, running functional test suites locally, or running smoke tests remotely, rate-limiting behavior can be annoying \u2014 or even downright disruptive. To work around this, there are a few options:"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:['You override ride them via an environment variable, RATE_LIMIT__RULES="" ',(0,s.jsx)(i.em,{children:"(Preferred option, since it works across the board.)"})]}),"\n",(0,s.jsx)(i.li,{children:"You use dev.json and override the config."}),"\n",(0,s.jsxs)(i.li,{children:["You can set the maxAttempt to be all be very high (or vary low if you want to test blocking scenarios quickly). ",(0,s.jsx)(i.em,{children:"(Not great, you might accidently commit your changes.)"})]}),"\n",(0,s.jsxs)(i.li,{children:["You can simply delete the contents of the rules in rate-limit-rules.txt. ",(0,s.jsx)(i.em,{children:"(Not preferred cause you might accidently commit the change!)"})]}),"\n"]}),"\n",(0,s.jsx)(i.p,{children:"_ Note, you could also just add your IP to the RATE_LIMIT__IGNORE_IPS filter as mentioned below. Same options above apply here as to where / how you set this filter._"}),"\n",(0,s.jsx)(i.h4,{id:"exclude-specific-attributes-like-ip-email-or-uid",children:"Exclude specific attributes like ip, email, or UID"}),"\n",(0,s.jsx)(i.p,{children:"When running smoke tests against a remote server, the first approach may not work \u2014 so we also support excluding specific emails or IP addresses from being checked by the rate limiter. To do this, define these values in your server's config file and pass them to the rate limiter."}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsx)(i.li,{children:"Email ignore values can use regex filters."}),"\n",(0,s.jsx)(i.li,{children:"IP addresses and UIDs must be exact string matches."}),"\n"]}),"\n",(0,s.jsx)(i.p,{children:(0,s.jsx)(i.em,{children:"Note that when using the email filter, checks run on IP only may still be susceptible to getting blocked! For this reason the IP filter might be a better approach if you can use static IPs."})}),"\n",(0,s.jsx)(i.h3,{id:"auth-server-specifics",children:"Auth Server specifics"}),"\n",(0,s.jsxs)(i.p,{children:["The auth server has a special config for auto checking all endpoints. To turn this on set ",(0,s.jsx)(i.code,{children:"RATE_LIMIT__CHECK_ALL_ENDPOINTS=true"}),"."]}),"\n",(0,s.jsx)(i.p,{children:"At the time of writing this isn't currently enabled, but it might be in the future. And if it is, a couple things to note:"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsx)(i.li,{children:"When this is enabled, we should define the 'default' rule! Otherwise calls will fall back to the legacy customs service, and this could result in a spike of blocked requests."}),"\n",(0,s.jsxs)(i.li,{children:["It's also important to note that individual endpoints can be configured with the following pattern, ",(0,s.jsx)(i.code,{children:"${HTTP_METHOD}_${PATH}"})," where path is lower case and non alpha numeric characters are converted to underscores."]}),"\n",(0,s.jsxs)(i.li,{children:["Some endpoints like ",(0,s.jsx)(i.code,{children:"/v1/verify"})," have very high traffic, so specific rules should be added for these endpoints. For example ",(0,s.jsx)(i.code,{children:"post__v1_verify : 100 : ip : 1 minute : 1 minute : report"})," would be a safe rule to add if turning on check all end points."]}),"\n",(0,s.jsxs)(i.li,{children:["Alternatively we might even consider skipping high traffic endpoints from rate-limiting checks. To do this add the high traffic endpoint to the ",(0,s.jsx)(i.code,{children:"RATE_LIMIT__SKIP_ENDPOINTS"})," config setting."]}),"\n"]}),"\n",(0,s.jsx)(i.h3,{id:"graphql-specifics",children:"Graphql Specifics"}),"\n",(0,s.jsxs)(i.p,{children:["Graphql also has the ability to run custom checks on on various actions. To do this simply decorate the endpoint to protect with ",(0,s.jsx)(i.code,{children:"@UseGuards(GqlCustomsGuard('updateDisplayName'))"}),", where updateDisplayName is the action you wan to rate limit."]}),"\n",(0,s.jsx)(i.p,{children:"Same as auth-server, you can define default rules in the rate-limit-rules.txt file, or via the RATE_LIMIT__RULES env."}),"\n",(0,s.jsx)(i.p,{children:(0,s.jsx)(i.em,{children:"At the time of writing, there is no way to check all graphql endpoints automatically..."})}),"\n",(0,s.jsx)(i.h3,{id:"new-blocking-scenarios",children:"New Blocking Scenarios"}),"\n",(0,s.jsx)(i.p,{children:"We have begun to collect blocking scenarios as a team in an attempt to strategize around how to provide rules that protect our end users, but also aren't overly aggressive or annoying. If you are interested in these scnearios, or are considering adding a new one, please reach out to an FxA team member or look for the blocking scenarios in our internal docs for more info on how we approach setting up robust rate limiting rules."}),"\n",(0,s.jsx)(i.h2,{id:"faq",children:"FAQ"}),"\n",(0,s.jsx)(i.h3,{id:"how-is-it-different-from-v1",children:"How is it different from V1?"}),"\n",(0,s.jsxs)(i.p,{children:["The new version no longer uses a \u2018service\u2019. It talks directly to redis via the ",(0,s.jsx)(i.code,{children:"libs/accounts/rate-limit"})," library. This library serves as the abstraction for configuring and enforcing rate limit policies."]}),"\n",(0,s.jsx)(i.h3,{id:"why-the-rewrite",children:"Why the rewrite?"}),"\n",(0,s.jsx)(i.p,{children:"There\u2019s several reasons."}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsx)(i.li,{children:"It\u2019s smaller. The service had 3426 lines of codes, and the new library had 960 lines."}),"\n",(0,s.jsx)(i.li,{children:"It\u2019s config driven. The customs configuration is now easy to read and understand. There\u2019s no more second guessing what customs is doing, just check the config. There\u2019s also no need to edit code to add a rule, just update the config."}),"\n",(0,s.jsx)(i.li,{children:"It\u2019s more efficient and more direct. We skip a whole round of http web requests and json serialization. The new lib talks directly to redis."}),"\n",(0,s.jsx)(i.li,{children:"It allows for more grain tuning of rules. We can now distinguish between blocking and banning, and we can do this on ip, email, uid, ip+email, or ip+uid. The old service would inevitably block on ip or email and bugs like this would happen."}),"\n",(0,s.jsx)(i.li,{children:"It can be configured independently per service. Previously the custom\u2019s service had a config that was specific to the services that used it. This is a prime example of feature envy. The old customs service was effectively concerned with aspects of the services it was being called from. This relationship is backward. In the new approach the library has no configuration defined. And has no knowledge of the calling code. The requirements for configuration have been shifted to calling code where they belong."}),"\n"]}),"\n",(0,s.jsx)(i.h3,{id:"great-can-i-just-turn-it-off-its-annoying-while-developing",children:"Great, can I just turn it off? It\u2019s annoying while developing\u2026"}),"\n",(0,s.jsx)(i.p,{children:"Yes, this is very easy. Simply set the rateLimit.rules to an empty string, and voila it\u2019s off. Any of the following work for this:"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:["Set ",(0,s.jsx)(i.code,{children:"RATE_LIMIT__RULES=\u201d\u201d"})," in your .env file or .bashrc"]}),"\n",(0,s.jsx)(i.li,{children:"Override the config setting in dev.json as you would any other config in fxa."}),"\n",(0,s.jsx)(i.li,{children:"Delete the contents of rate-limit-rules.txt that customs reads from by default."}),"\n"]}),"\n",(0,s.jsx)(i.p,{children:"Please note, we\u2019d like you to develop with customs on! Ignoring customs is like ignoring an important piece of functionality in the code base."}),"\n",(0,s.jsx)(i.p,{children:"We currently have plenty of examples where customs errors are not handled correctly. This probably stems from people developing with customs off. A better approach is to alter the \u2018max attempts\u2019 in the rate-limit-rules.txt files as needed. You could increase max attempts value to make customs less active, or decrease the max attempts value to make customs more active and make it easier to test blocking behavior."}),"\n",(0,s.jsx)(i.h3,{id:"whats-the-difference-between-a-block-a-ban-and-report-policy-again",children:"What\u2019s the difference between a block, a ban, and report policy again?"}),"\n",(0,s.jsx)(i.p,{children:"Blocks only apply to the current rule. You can think of a block as blocking an isolated action once the max attempts are hit."}),"\n",(0,s.jsx)(i.p,{children:"Bans apply to the current rule, and all other rules. If a user trips a ban, then they are effectively blocked from that action, and all other actions, hence the term \u2018ban\u2019."}),"\n",(0,s.jsx)(i.p,{children:"Report is the final policy option for . It allows you to record metrics, but not actually do a block. This is great for testing out hypotheticals with little risk. But, be careful not to clobber other existing rules when you use this!"}),"\n",(0,s.jsx)(i.h3,{id:"whats-up-with-the-default-rule-again",children:"What\u2019s up with the \u2018default\u2019 rule again?"}),"\n",(0,s.jsxs)(i.p,{children:["The default rule is a special case. When configured, it will act as the fallback in the event a rule isn\u2019t found. For example, let\u2019s say you have a call like this: ",(0,s.jsx)(i.code,{children:"rateLimit.check(\u2018foo\u2019, {ip});"})," If there is no rule for action foo in the current rate limit rules config, then if and only if there\u2019s a default rule defined, we will use that."]}),"\n",(0,s.jsx)(i.p,{children:"Be sure to set defaults for ALL blocks on policies. Otherwise, you might get an error."}),"\n",(0,s.jsx)(i.p,{children:"Be very careful with the default. It should have plenty of overhead!"}),"\n",(0,s.jsx)(i.h3,{id:"im-adding-a-new-rule-but-im-concerned-about-the-impact-can-i-monitor-this",children:"I\u2019m adding a new rule but I\u2019m concerned about the impact, can I monitor this?"}),"\n",(0,s.jsx)(i.p,{children:"Yep! We got graphs over in yardstick. If you can't find them reach out to a teammate."}),"\n",(0,s.jsx)(i.p,{children:"A couple things to note about these graphs. We have some that are specific to auth-server. These metrics look like fxa_auth_server_customs_*. These are legacy metrics and we use these comparisons before and after a rule rolls out."}),"\n",(0,s.jsxs)(i.p,{children:["We also have the metrics emitted by the rate-limit library. These metrics offer further information about what got blocked and why. This graph provides a lot of detail about the exact nature of blocks that are occurring. These are rules targeting ",(0,s.jsx)(i.code,{children:"${SERVICE_NAME}_rate_limit_*"}),". These will be referenced in dashboards titled \u2018Rate Limit Library - $VIEW`."]}),"\n",(0,s.jsx)(i.p,{children:"As noted above, when rolling out a new rule, it\u2019s often a good idea to roll it out initially with the \u2018report\u2019 policy, so no blocks occur at first. This can give a baseline for whether or not blocks seem reasonable. Once you feel good with blocking, i.e. we don\u2019t see a sky high number of blocks, you can change the \u2018report\u2019 policy to a block or ban policy."}),"\n",(0,s.jsx)(i.h3,{id:"once-a-user-is-blocked-do-they-get-unblocked-how-does-this-work-exactly",children:"Once a user is blocked, do they get unblocked? How does this work exactly?"}),"\n",(0,s.jsxs)(i.p,{children:["Yes, a user can become unblocked if they provide an unblock code at sign in. If the code is valid, all blocks will be cleared for the users\u2019s current IP, email, uid, ip+email, and ip+uid that proved the sign in code correct\u2026 Checkout how the ",(0,s.jsx)(i.code,{children:"/account/login/send_unblock_code"})," is invoked, and how the ",(0,s.jsx)(i.code,{children:"RateLimit::unblock"})," method is called for exact details."]}),"\n",(0,s.jsx)(i.p,{children:"It\u2019s important to note that \u2018bans\u2019 WILL NOT BE CLEARED. Which is why we should be very careful with ban operations and only apply them in cases where the behavior is clearly malicious like incorrect attempts at passwords or codes."}),"\n",(0,s.jsx)(i.h3,{id:"a-user-is-having-trouble-with-being-blocked-can-i-help-them",children:"A user is having trouble with being blocked. Can I help them?"}),"\n",(0,s.jsx)(i.p,{children:"This is a work in progress, but sometime soon, you sure can go to admin panel, and navigate to the rate limit section. You will have 3 OR filters at the top for ip, email, and uid. If you enter any of these, any active block or ban will be displayed below. Assuming you have admin privileges, you can clear these blocks and bans."}),"\n",(0,s.jsx)(i.hr,{}),"\n",(0,s.jsx)(i.h2,{id:"legacy-customs-v1-docs-kept-for-historical-record-will-be-removed",children:"Legacy Customs V1 Docs (Kept for historical Record, will be removed!)"}),"\n",(0,s.jsxs)(i.p,{children:["Last updated: ",(0,s.jsx)(i.code,{children:"June 21th, 2022"})]}),"\n",(0,s.jsxs)(i.p,{children:["The ",(0,s.jsx)(i.a,{href:"https://github.com/mozilla/fxa/blob/main/packages/fxa-customs-server/README.md",children:"Customs server"})," is the service responsible for maintaining and implementing rate limiting in FxA.\nIt was developed to help detect and deter ",(0,s.jsx)(i.a,{href:"https://wiki.mozilla.org/Identity/Firefox_Accounts/Fraud_and_abuse",children:"fraud and abuse"}),"."]}),"\n",(0,s.jsxs)(i.p,{children:["Currently, only it is used by the ",(0,s.jsx)(i.a,{href:"https://github.com/mozilla/fxa-auth-server",children:"Mozilla accounts Auth Server"}),"."]}),"\n",(0,s.jsx)(i.p,{children:"The Customs server uses a sliding window to keep track of the current count of a specific type of action and trims the count as needed."}),"\n",(0,s.jsx)(i.h3,{id:"policies",children:"Policies"}),"\n",(0,s.jsx)(i.p,{children:"There are two types of policies:"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:["rate-limiting: slows down attackers by temporarily blocking requests for 15 minutes (see ",(0,s.jsx)(i.code,{children:"config.limits.rateLimitIntervalSeconds"}),")"]}),"\n",(0,s.jsxs)(i.li,{children:["block / ban: stops attacks by temporarily blocking requests for 24 hours (see ",(0,s.jsx)(i.code,{children:"config.limits.blockIntervalSeconds"}),")"]}),"\n"]}),"\n",(0,s.jsx)(i.p,{children:"We currently have the following policies in place:"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:["rate-limiting when too many emails (",(0,s.jsx)(i.code,{children:"config.limits.maxEmails"})," defaults to 3) have been sent to the same email address in a given time period (",(0,s.jsx)(i.code,{children:"config.limits.rateLimitIntervalSeconds"})," defaults to 15 minutes)"]}),"\n",(0,s.jsxs)(i.li,{children:["rate-limiting when too many requests to look up account status by email address (",(0,s.jsx)(i.code,{children:"config.limits.maxAccountStatusCheck"}),") have been sent from the same ip address during"]}),"\n",(0,s.jsxs)(i.li,{children:["rate-limiting when too many sms (",(0,s.jsx)(i.code,{children:"config.limits.smsRateLimit.maxSms"}),") have been sent from the same ip address during period (",(0,s.jsx)(i.code,{children:"config.limits.smsRateLimit.limitIntervalSeconds"})," defaults to 60 minutes)"]}),"\n",(0,s.jsxs)(i.li,{children:["rate-limiting when too many sms (",(0,s.jsx)(i.code,{children:"config.limits.smsRateLimit.maxSms"}),") have been sent from the same email address during period (",(0,s.jsx)(i.code,{children:"config.limits.smsRateLimit.limitIntervalSeconds"})," defaults to 60 minutes)"]}),"\n",(0,s.jsxs)(i.li,{children:["rate-limiting when too many sms (",(0,s.jsx)(i.code,{children:"config.limits.smsRateLimit.maxSms"}),") have been sent to the same phone number during period (",(0,s.jsx)(i.code,{children:"config.limits.smsRateLimit.limitIntervalSeconds"})," defaults to 60 minutes)"]}),"\n",(0,s.jsxs)(i.li,{children:["rate-limiting when too many failed login attempts (",(0,s.jsx)(i.code,{children:"config.limits.maxBadLogins"})," defaults to 2) have occurred for a given account and IP address, in a given time period (",(0,s.jsx)(i.code,{children:"config.limits.rateLimitIntervalSeconds"})," defaults to 15 minutes)"]}),"\n",(0,s.jsxs)(i.li,{children:["rate-limiting too many attempts to verify randomly-generated codes (",(0,s.jsx)(i.code,{children:"config.limits.maxVerifyCodes"})," defaults to 10) have occurred for a given account and IP address, in a given time period (",(0,s.jsx)(i.code,{children:"config.limits.rateLimitIntervalSeconds"})," defaults to 15 minutes)"]}),"\n",(0,s.jsxs)(i.li,{children:["manual blocking of an account (see ",(0,s.jsx)(i.code,{children:"/blockEmail"})," API call)"]}),"\n",(0,s.jsxs)(i.li,{children:["manual blocking of an IP address (see ",(0,s.jsx)(i.code,{children:"/blockIp"})," API call)"]}),"\n"]}),"\n",(0,s.jsxs)(i.p,{children:["The data that these policies are based on is stored in a memcache instance (keyed by ",(0,s.jsx)(i.code,{children:"email"}),", ",(0,s.jsx)(i.code,{children:"ip"})," or ",(0,s.jsx)(i.code,{children:"ip + email"})," depending on the policy) and the code that implements them is split across these three files:"]}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.code,{children:"email_record.js"})," handles blocking and rate-limiting based only on the email address"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.code,{children:"ip_email_record.js"})," handles rate-limiting based on both the email and IP address of the request"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.code,{children:"ip_record.js"})," handles blocking based only on the IP address"]}),"\n"]}),"\n",(0,s.jsxs)(i.p,{children:["The rate-limiting and blocking policies are conveyed to the auth server via the ",(0,s.jsx)(i.code,{children:"block"})," property in the response to ",(0,s.jsx)(i.code,{children:"/check"}),"."]}),"\n",(0,s.jsx)(i.h3,{id:"usage-in-auth-server",children:"Usage in Auth-server"}),"\n",(0,s.jsx)(i.p,{children:"In the auth-server, we utilized a helper library to make calls to the custom server api. The request could contain email, ip, and the action being performed."}),"\n",(0,s.jsxs)(i.p,{children:["For example, the call ",(0,s.jsx)(i.code,{children:"customs.check(request, email, 'accountCreate')"})," would increment the ",(0,s.jsx)(i.code,{children:"accountCreate"})," event for the user coming from this ip address and email."]}),"\n",(0,s.jsx)(i.p,{children:"Below are the current actions supported:"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-javascript",children:"// Actions that, if allowed, would allow an attacker\n// to try a candidtate password against an account.\nconst PASSWORD_CHECKING_ACTION = {\n  accountLogin: true,\n  accountDestroy: true,\n  passwordChange: true,\n};\n\n// Actions that, if allowed, would allow an attacker\n// to try a guess at a randomly-generated security code.\n// Code are higher entropy so we can allow more of these,\n// but if you're doing it a lot, you're probably a baddie.\nconst CODE_VERIFYING_ACTION = {\n  recoveryEmailVerifyCode: true,\n  passwordForgotVerifyCode: true,\n  verifyRecoveryCode: true,\n  verifySessionCode: true,\n  // not high entropy\n  // changes at 60 seconds\n  // limits by email\n  verifyTotpCode: true,\n};\n\n// Actions that, if allowed, would allow an attacker\n// to check whether an account exists or has certain\n// properties for a particular user.\n// Basically any unauthenticated endpoint that takes\n// an email address as input.\nconst ACCOUNT_STATUS_ACTION = {\n  accountCreate: true,\n  accountLogin: true,\n  accountDestroy: true,\n  passwordChange: true,\n  passwordForgotSendCode: true,\n  accountStatusCheck: true,\n  sendUnblockCode: true,\n  recoveryKeyExists: true,\n};\n\n// Actions that send an email, and hence might make\n// us look like spammers if abused.\nconst EMAIL_SENDING_ACTION = {\n  accountCreate: true,\n  createEmail: true,\n  recoveryEmailResendCode: true,\n  recoveryEmailSecondaryResendCode: true,\n  passwordForgotSendCode: true,\n  passwordForgotResendCode: true,\n  sendUnblockCode: true,\n};\n\n// Actions that can send sms, and could make us\n// very annoying to a user if abused.\nconst SMS_SENDING_ACTION = {\n  connectDeviceSms: true,\n};\n"})})]})}function h(e={}){const{wrapper:i}={...(0,o.R)(),...e.components};return i?(0,s.jsx)(i,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},28453:(e,i,n)=>{n.d(i,{R:()=>r,x:()=>a});var t=n(96540);const s={},o=t.createContext(s);function r(e){const i=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(i):{...i,...e}}),[i,e])}function a(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),t.createElement(o.Provider,{value:i},e.children)}}}]);