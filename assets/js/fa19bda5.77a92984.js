"use strict";(self.webpackChunkfirefox_ecosystem_platform=self.webpackChunkfirefox_ecosystem_platform||[]).push([[8286],{63891:(e,o,i)=>{i.r(o),i.d(o,{assets:()=>l,contentTitle:()=>s,default:()=>p,frontMatter:()=>r,metadata:()=>a,toc:()=>c});var t=i(74848),n=i(28453);const r={id:"google-iap",title:"Google IAP",sidebar_label:"Google IAP"},s=void 0,a={id:"relying-parties/how-tos/google-iap",title:"Google IAP",description:"Introduction",source:"@site/docs/relying-parties/how-tos/google-iap.md",sourceDirName:"relying-parties/how-tos",slug:"/relying-parties/how-tos/google-iap",permalink:"/ecosystem-platform/relying-parties/how-tos/google-iap",draft:!1,unlisted:!1,editUrl:"https://github.com/mozilla/ecosystem-platform/edit/master/docs/relying-parties/how-tos/google-iap.md",tags:[],version:"current",frontMatter:{id:"google-iap",title:"Google IAP",sidebar_label:"Google IAP"},sidebar:"docs",previous:{title:"End-to-end Encryption",permalink:"/ecosystem-platform/relying-parties/how-tos/end-to-end-encryption"},next:{title:"Apple IAP",permalink:"/ecosystem-platform/relying-parties/how-tos/apple-iap"}},l={},c=[{value:"Introduction",id:"introduction",level:2},{value:"Recent changes to Google Play Billing Library",id:"recent-changes-to-google-play-billing-library",level:3},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Create an IAP configuration document",id:"create-an-iap-configuration-document",level:3},{value:"Add Google Play Developer API keys in SubPlat",id:"add-google-play-developer-api-keys-in-subplat",level:3},{value:"Send Real-time developer notifications to SubPlat",id:"send-real-time-developer-notifications-to-subplat",level:3},{value:"Map Google IAP to Stripe plans",id:"map-google-iap-to-stripe-plans",level:3},{value:"Prevent Google IAP subscribers from double subscribing",id:"prevent-google-iap-subscribers-from-double-subscribing",level:3},{value:"SubPlat API Calls",id:"subplat-api-calls",level:2},{value:"Getting the current subscription status for a FxA user",id:"getting-the-current-subscription-status-for-a-fxa-user",level:3},{value:"Registering a Google IAP subscriber",id:"registering-a-google-iap-subscriber",level:3},{value:"(Optional) Migrating existing Google IAP subscribers to SubPlat",id:"optional-migrating-existing-google-iap-subscribers-to-subplat",level:3},{value:"Testing your integration",id:"testing-your-integration",level:2},{value:"End-to-end testing of SubPlat APIs",id:"end-to-end-testing-of-subplat-apis",level:3}];function d(e){const o={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",ul:"ul",...(0,n.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(o.h2,{id:"introduction",children:"Introduction"}),"\n",(0,t.jsxs)(o.p,{children:["As of November 2021, Subscription Platform (SubPlat) supports ",(0,t.jsx)(o.a,{href:"https://developer.android.com/google/play/billing",children:"Google IAP"})," integrations for products with Mozilla VPN as one example. An integration allows us to maintain an awareness of a Google IAP subscriber's subscription status for a given Android app, including any state changes, which we forward on to the relevant relying party (RP)."]}),"\n",(0,t.jsx)(o.p,{children:"Importantly, Google provides read-only access to Google IAP subscriptions. Consequently, we do not (and cannot) modify Google IAP subscriptions (e.g. making plan changes such as upgrades)."}),"\n",(0,t.jsxs)(o.p,{children:["A more technical discussion (geared toward Mozilla accounts (FxA) engineers) can be found in ",(0,t.jsx)(o.a,{href:"/ecosystem-platform/tutorials/subscription-platform#google-iap-integration",children:"Google IAP Integration"}),"."]}),"\n",(0,t.jsx)(o.h3,{id:"recent-changes-to-google-play-billing-library",children:"Recent changes to Google Play Billing Library"}),"\n",(0,t.jsxs)(o.p,{children:["As of May 2022, the Google Play Billing Library introduced changes in the way subscription products are defined and managed in the Google Play Console. This includes the deprecation of the ",(0,t.jsx)(o.code,{children:"SkuDetails"})," class and renaming all ",(0,t.jsx)(o.code,{children:"sku"})," references to the more aptly named ",(0,t.jsx)(o.code,{children:"productId"}),"."]}),"\n",(0,t.jsxs)(o.p,{children:["Importantly, Google has included backwards compatibility to allow for a gradual migration. In our codebase, we are currently still referencing the outdated ",(0,t.jsx)(o.code,{children:"sku"}),". However, as this is a How-to Guide for RPs, and what one can expect to see in Google Play Console, this guide will reference all new field names, and in particular, ",(0,t.jsx)(o.code,{children:"productId"}),"."]}),"\n",(0,t.jsxs)(o.p,{children:["For more information on these changes and updated field mappings, see ",(0,t.jsx)(o.a,{href:"https://support.google.com/googleplay/android-developer/answer/12154973",children:"Understanding subscriptions"})," and ",(0,t.jsx)(o.a,{href:"https://developer.android.com/google/play/billing/compatibility",children:"May 2022 subscription changes guide"}),"."]}),"\n",(0,t.jsx)(o.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,t.jsxs)(o.p,{children:["This guide assumes you are already integrated with FxA/SubPlat; please see ",(0,t.jsx)(o.a,{href:"/ecosystem-platform/relying-parties/tutorials/integration-with-subscription-platform",children:"Integration with Subscription Platform"})," for more information."]}),"\n",(0,t.jsxs)(o.p,{children:["Ideally, you will also want to grant 1-2 SubPlat engineers working on the integration developer access to your Android app in ",(0,t.jsx)(o.a,{href:"https://play.google.com/console",children:"Google Play Console"})," (",(0,t.jsx)(o.a,{href:"https://bugzilla.mozilla.org/show_bug.cgi?id=1726184",children:"example bug"}),"). This allows us to access your Android app\u2019s ",(0,t.jsx)(o.a,{href:"https://developers.google.com/android-publisher",children:"Google Play Developer API"})," keys, to look up needed app-specific information and to configure an endpoint to receive ",(0,t.jsx)(o.a,{href:"https://developer.android.com/google/play/billing/rtdn-reference",children:"Real-time developer notifications (RTDN)"}),"."]}),"\n",(0,t.jsx)(o.h2,{id:"configuration",children:"Configuration"}),"\n",(0,t.jsxs)(o.p,{children:["These steps can be done by a product manager or developer and in parallel with steps in ",(0,t.jsx)(o.a,{href:"#subplat-api-calls",children:"SubPlat API Calls"}),". More information regarding specific Stripe metadata keys mentioned below can be found in the ",(0,t.jsx)(o.a,{href:"/ecosystem-platform/tutorials/subscription-platform#stripe-productplans",children:"Subscription Platform integration tutorial"}),"."]}),"\n",(0,t.jsx)(o.h3,{id:"create-an-iap-configuration-document",children:"Create an IAP configuration document"}),"\n",(0,t.jsxs)(o.p,{children:["This document represents a list of Play Store plans (identified uniquely by their Play Store ",(0,t.jsx)(o.a,{href:"https://support.google.com/googleplay/android-developer/answer/140504#zippy=%2Ccreate-a-new-subscription",children:(0,t.jsx)(o.code,{children:"productId"})})," for your product."]}),"\n",(0,t.jsxs)(o.ol,{children:["\n",(0,t.jsxs)(o.li,{children:["Go into Google Play Console and find details about your Android app by ",(0,t.jsx)(o.a,{href:"https://support.google.com/googleplay/android-developer/answer/140504#zippy=%2Ccreate-a-new-subscription",children:(0,t.jsx)(o.code,{children:"productId"})}),"."]}),"\n",(0,t.jsxs)(o.li,{children:["Create a configuration document similar in form to ",(0,t.jsx)(o.a,{href:"https://api.accounts.firefox.com/v1/oauth/subscriptions/iap/plans/guardian-vpn",children:"https://api.accounts.firefox.com/v1/oauth/subscriptions/iap/plans/guardian-vpn"})," (omitting iOS plans) using the details retrieved in Step 1. This can be in a Google document for now.","\n",(0,t.jsxs)(o.ul,{children:["\n",(0,t.jsxs)(o.li,{children:["Note: The only information SubPlat uses from the VPN document currently is the ",(0,t.jsx)(o.code,{children:"productId"})," and ",(0,t.jsx)(o.code,{children:"platform"}),". The VPN configuration document is structured in this way for historical reasons. We may change how this information is structured for future integrations."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(o.li,{children:["File a ticket in the ",(0,t.jsx)(o.a,{href:"https://mozilla-hub.atlassian.net/browse/FXA",children:"FXA Jira project"}),' to create a new document in SubPlat\'s "IAP config" Firestore collection, and provide the document from Step 2 along with an ',(0,t.jsx)(o.code,{children:"appName"}),".","\n",(0,t.jsxs)(o.ul,{children:["\n",(0,t.jsxs)(o.li,{children:[(0,t.jsx)(o.code,{children:"appName"})," is a human-readable name that SubPlat uses to uniquely identify your app in our system (e.g. ",(0,t.jsx)(o.code,{children:'"guardian-vpn"'})," is the ",(0,t.jsx)(o.code,{children:"appName"})," for the Mozilla VPN in the link above).\nWhen the ticket is complete and deployed, you should be able to view your configuration at ",(0,t.jsx)(o.a,{href:"https://api.accounts.firefox.com/v1/oauth/subscriptions/iap/plans/$%7BappName%7D",children:"https://api.accounts.firefox.com/v1/oauth/subscriptions/iap/plans/${appName}"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(o.h3,{id:"add-google-play-developer-api-keys-in-subplat",children:"Add Google Play Developer API keys in SubPlat"}),"\n",(0,t.jsxs)(o.p,{children:["A SubPlat engineer with developer access to Google Play Console (see ",(0,t.jsx)(o.a,{href:"#prerequisites",children:"Prerequisites"}),") can configure this for you when ready."]}),"\n",(0,t.jsxs)(o.p,{children:["Google Play Developer API keys are needed for SubPlat to make calls to Google API. For more information on how to obtain these keys, see ",(0,t.jsx)(o.a,{href:"https://support.google.com/googleapi/answer/6158862",children:"Setting up API keys"}),"."]}),"\n",(0,t.jsx)(o.h3,{id:"send-real-time-developer-notifications-to-subplat",children:"Send Real-time developer notifications to SubPlat"}),"\n",(0,t.jsxs)(o.p,{children:["A SubPlat engineer with developer access to Google Play Console (see ",(0,t.jsx)(o.a,{href:"#prerequisites",children:"Prerequisites"}),") can configure this for you when ready."]}),"\n",(0,t.jsx)(o.p,{children:"When ready, the Production endpoint in RTDN must be updated with SubPlat's notification endpoint in order for our system to receive RTDN."}),"\n",(0,t.jsx)(o.h3,{id:"map-google-iap-to-stripe-plans",children:"Map Google IAP to Stripe plans"}),"\n",(0,t.jsxs)(o.p,{children:["In order to know what capabilities to grant a given Google IAP user, we map Play Store ",(0,t.jsx)(o.code,{children:"productId"}),"s to ",(0,t.jsxs)(o.a,{href:"https://support.stripe.com/questions/how-to-create-products-and-prices",children:["Stripe ",(0,t.jsx)(o.code,{children:"price"})," or ",(0,t.jsx)(o.code,{children:"plan"})]})," IDs (",(0,t.jsx)(o.code,{children:"price"}),"s supersede ",(0,t.jsx)(o.code,{children:"plan"}),"s)."]}),"\n",(0,t.jsxs)(o.ol,{children:["\n",(0,t.jsxs)(o.li,{children:["Go into the Google Play Console and find your Android app\u2019s human-readable ",(0,t.jsx)(o.code,{children:"productId"}),"s."]}),"\n",(0,t.jsxs)(o.li,{children:["In the Stripe dashboard for the desired environment (stage or production), create a new, valid product in Stripe and a new, valid plan underneath that product.","\n",(0,t.jsxs)(o.ul,{children:["\n",(0,t.jsxs)(o.li,{children:["We hope to simplify this process in SubPlat 3.0, expected in 2023; see this ",(0,t.jsx)(o.a,{href:"https://mozilla-hub.atlassian.net/browse/PSP-64?focusedCommentId=627245",children:"Jira comment"})," for more details."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(o.li,{children:["Add each Play Store ",(0,t.jsx)(o.code,{children:"productId"})," as a comma-separated value to a new ",(0,t.jsx)(o.code,{children:"playSkuIds"})," metadata property on the newly created plan."]}),"\n"]}),"\n",(0,t.jsx)(o.h3,{id:"prevent-google-iap-subscribers-from-double-subscribing",children:"Prevent Google IAP subscribers from double subscribing"}),"\n",(0,t.jsx)(o.p,{children:"As noted previously, we don\u2019t support upgrades or any plan changes for Google IAP subscribers. However, it is possible for a Google IAP subscriber to try to sign up again for your product on the SubPlat website. Follow these steps to prevent them from double subscribing."}),"\n",(0,t.jsxs)(o.ol,{children:["\n",(0,t.jsxs)(o.li,{children:["In the Stripe dashboard for the given environment (stage or production), remove any ",(0,t.jsx)(o.code,{children:"productSet"})," properties that may have been previously set on the newly created product/plan from ",(0,t.jsx)(o.a,{href:"#map-google-iap-to-stripe-plans",children:"Map Google IAP to Stripe plans"}),"."]}),"\n",(0,t.jsxs)(o.li,{children:["Add a ",(0,t.jsx)(o.code,{children:"productSet"})," metadata key with a value equal to the comma-separated list of all the unique ",(0,t.jsx)(o.code,{children:"productSet"}),"s for all your product\u2019s plans in the environment to the new product referenced in Step 1. Without their own ",(0,t.jsx)(o.code,{children:"productSet"})," specified, the new plan will inherit its product\u2019s ",(0,t.jsx)(o.code,{children:"productSet"}),"."]}),"\n"]}),"\n",(0,t.jsx)(o.h2,{id:"subplat-api-calls",children:"SubPlat API Calls"}),"\n",(0,t.jsxs)(o.p,{children:["These steps can be done by a developer and in parallel with the steps in ",(0,t.jsx)(o.a,{href:"#configuration",children:"Configuration"}),"."]}),"\n",(0,t.jsxs)(o.p,{children:["As mentioned in the ",(0,t.jsx)(o.a,{href:"#introduction",children:"Introduction"}),", SubPlat has read-only access to Play Store subscription information. We will store Google IAP subscribers' data in our system and update the information when we receive notifications from RTDN, broadcasting updates in real time to the relevant RPs."]}),"\n",(0,t.jsx)(o.h3,{id:"getting-the-current-subscription-status-for-a-fxa-user",children:"Getting the current subscription status for a FxA user"}),"\n",(0,t.jsxs)(o.p,{children:["Assuming you are already integrated with FxA generally (see ",(0,t.jsx)(o.a,{href:"#prerequisites",children:"Prerequisites"}),"), are receiving subscription updates for other types of subscriptions (e.g. for PayPal or Stripe), and you have completed the ",(0,t.jsx)(o.a,{href:"#map-google-iap-to-stripe-plans",children:"mapping of Play Store to Stripe plans"}),", no further work is required to continue receiving these updates for Google IAP subscribers. You can also pull this information from FxA with the existing ",(0,t.jsx)(o.a,{href:"/ecosystem-platform/api#tag/Account/operation/getAccountProfile",children:(0,t.jsx)(o.code,{children:"/account/profile"})})," endpoint without any further changes."]}),"\n",(0,t.jsx)(o.h3,{id:"registering-a-google-iap-subscriber",children:"Registering a Google IAP subscriber"}),"\n",(0,t.jsxs)(o.p,{children:["SubPlat needs to be able to associate a Google IAP subscription in Google's system to a specific FxA user. This is done by registering each Google IAP subscriber with the ",(0,t.jsx)(o.a,{href:"/ecosystem-platform/api#tag/Subscriptions/operation/postOauthSubscriptionsIapPlaytokenAppname",children:(0,t.jsx)(o.code,{children:"/subscriptions/iap/play-token/${appName}"})})," endpoint."]}),"\n",(0,t.jsxs)(o.p,{children:["By design, we allow only one FxA user per Play Store ",(0,t.jsx)(o.a,{href:"https://support.google.com/googleplay/android-developer/answer/140504#zippy=%2Ccreate-a-new-subscription",children:(0,t.jsx)(o.code,{children:"productId"})}),", which is how Google uniquely identifies the user's device when the subscription was purchased."]}),"\n",(0,t.jsxs)(o.p,{children:["This endpoint can be used to register a new Google IAP subscriber or to migrate an existing Google IAP subscriber. For the latter, see ",(0,t.jsx)(o.a,{href:"#optional-migrating-existing-google-iap-subscribers-to-subplat",children:"(Optional) Migrate existing Google IAP subscribers to SubPlat"}),"."]}),"\n",(0,t.jsx)(o.h3,{id:"optional-migrating-existing-google-iap-subscribers-to-subplat",children:"(Optional) Migrating existing Google IAP subscribers to SubPlat"}),"\n",(0,t.jsx)(o.p,{children:"This section only applies to products that currently have a direct integration with Google who need to migrate existing subscribers to SubPlat."}),"\n",(0,t.jsxs)(o.p,{children:["This step can be done by a developer. Before proceeding, complete the steps under ",(0,t.jsx)(o.a,{href:"#configuration",children:"Configuration"})," and ",(0,t.jsx)(o.a,{href:"#subplat-api-calls",children:"SubPlat API Calls"}),". See also the ",(0,t.jsx)(o.a,{href:"#testing-your-integration",children:"Testing your integration"})," section."]}),"\n",(0,t.jsxs)(o.p,{children:["To migrate existing subscribers to SubPlat, use the existing registration endpoint (",(0,t.jsx)(o.a,{href:"/ecosystem-platform/api#tag/Subscriptions/operation/postOauthSubscriptionsIapPlaytokenAppname",children:(0,t.jsx)(o.code,{children:"/subscriptions/iap/play-token/${appName}"})}),") to register each existing user with SubPlat."]}),"\n",(0,t.jsx)(o.h2,{id:"testing-your-integration",children:"Testing your integration"}),"\n",(0,t.jsxs)(o.p,{children:["Currently, there is no sandbox or separate test environment. To create a test subscription, append ",(0,t.jsx)(o.code,{children:"(Stage)"})," to the end of a subscription title in the Google Play Console to differentiate from a Production subscription. This approach will enable RPs to test multiple scenarios to understand what to expect."]}),"\n",(0,t.jsx)(o.h3,{id:"end-to-end-testing-of-subplat-apis",children:"End-to-end testing of SubPlat APIs"}),"\n",(0,t.jsx)(o.p,{children:"After development and the steps above are complete (and importantly, before involving QA), it is recommended for the lead RP integration engineer to pair with the lead SubPlat integration engineer to test the following:"}),"\n",(0,t.jsxs)(o.ul,{children:["\n",(0,t.jsx)(o.li,{children:(0,t.jsx)(o.a,{href:"#getting-the-current-subscription-status-for-a-fxa-user",children:"Getting the current subscription status for a FxA user"})}),"\n",(0,t.jsx)(o.li,{children:(0,t.jsx)(o.a,{href:"#registering-a-google-iap-subscriber",children:"Registering a Google IAP subscriber"})}),"\n",(0,t.jsx)(o.li,{children:(0,t.jsx)(o.a,{href:"#send-real-time-developer-notifications-to-subplat",children:"Send Real-time developer notifications to SubPlat"})}),"\n",(0,t.jsx)(o.li,{children:(0,t.jsx)(o.a,{href:"#optional-migrating-existing-google-iap-subscribers-to-subplat",children:"(Optional) Migrating existing Google IAP subscribers to SubPlat"})}),"\n"]})]})}function p(e={}){const{wrapper:o}={...(0,n.R)(),...e.components};return o?(0,t.jsx)(o,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},28453:(e,o,i)=>{i.d(o,{R:()=>s,x:()=>a});var t=i(96540);const n={},r=t.createContext(n);function s(e){const o=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(o):{...o,...e}}),[o,e])}function a(e){let o;return o=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:s(e.components),t.createElement(r.Provider,{value:o},e.children)}}}]);