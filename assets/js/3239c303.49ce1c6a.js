"use strict";(self.webpackChunkfirefox_ecosystem_platform=self.webpackChunkfirefox_ecosystem_platform||[]).push([[8300],{73985:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>s,default:()=>d,frontMatter:()=>a,metadata:()=>r,toc:()=>h});var i=t(85893),o=t(11151);const a={title:"Pairing Flow Architecture"},s=void 0,r={id:"explanation/pairing-flow-architecture",title:"Pairing Flow Architecture",description:"Current as of Mar 17th, 2021",source:"@site/docs/explanation/pairing-flow-architecture.md",sourceDirName:"explanation",slug:"/explanation/pairing-flow-architecture",permalink:"/ecosystem-platform/explanation/pairing-flow-architecture",draft:!1,unlisted:!1,editUrl:"https://github.com/mozilla/ecosystem-platform/edit/master/docs/explanation/pairing-flow-architecture.md",tags:[],version:"current",frontMatter:{title:"Pairing Flow Architecture"},sidebar:"docs",previous:{title:"onepw Protocol",permalink:"/ecosystem-platform/explanation/onepw-protocol"},next:{title:"Scoped Keys",permalink:"/ecosystem-platform/explanation/scoped-keys"}},c={},h=[{value:"Pairing Flow Architecture",id:"pairing-flow-architecture",level:2},{value:"Detailed Flow",id:"detailed-flow",level:3},{value:"1) Desktop opens an encrypted channel and advertises it via QR code",id:"1-desktop-opens-an-encrypted-channel-and-advertises-it-via-qr-code",level:4},{value:"2) Mobile scans the QR code and connects to the encrypted channel",id:"2-mobile-scans-the-qr-code-and-connects-to-the-encrypted-channel",level:4},{value:"3) Devices exchange metadata and show confirmation screens",id:"3-devices-exchange-metadata-and-show-confirmation-screens",level:4},{value:"4) Desktop device authorizes OAuth request",id:"4-desktop-device-authorizes-oauth-request",level:4},{value:"5) Mobile receives OAuth response and connects to Sync",id:"5-mobile-receives-oauth-response-and-connects-to-sync",level:4},{value:"Intended Security Properties",id:"intended-security-properties",level:2},{value:"Exchanged messages specification",id:"exchanged-messages-specification",level:2},{value:"Pairing Channel messages",id:"pairing-channel-messages",level:3},{value:"pair:supp",id:"pairsupp",level:4},{value:"pair:auth",id:"pairauth",level:4},{value:"pair:auth",id:"pairauth-1",level:4},{value:"pair:supp",id:"pairsupp-1",level:4},{value:"Desktop WebChannel messages",id:"desktop-webchannel-messages",level:3},{value:"fxaccounts",id:"fxaccounts",level:4},{value:"fxaccounts",id:"fxaccounts-1",level:4},{value:"fxaccounts",id:"fxaccounts-2",level:4},{value:"fxaccounts",id:"fxaccounts-3",level:4},{value:"Other Details",id:"other-details",level:2},{value:"Routes",id:"routes",level:3},{value:"QR Code and URLs",id:"qr-code-and-urls",level:3}];function l(e){const n={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,o.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:["Current as of ",(0,i.jsx)(n.code,{children:"Mar 17th, 2021"})]}),"\n",(0,i.jsx)(n.h2,{id:"pairing-flow-architecture",children:"Pairing Flow Architecture"}),"\n",(0,i.jsxs)(n.p,{children:["The goal of the pairing flow is to allow users to quickly connect a mobile browser to Firefox Sync, without having to type their password,\nMozilla accounts allows a mobile device to connect by pairing with an authenticated Firefox profile on their PC via scanning a QR code.\nSee the ",(0,i.jsx)(n.a,{href:"https://docs.google.com/document/d/1mFf0sfEK8o1csXLeyK1x4GS9SUMIq4q8bu25LiydPew/edit#",children:"Project Plan Document"})," for more information."]}),"\n",(0,i.jsx)(n.p,{children:"The intended user flow operates as follows:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"On their Desktop (Authority) device, the user selects an option to connect other device, and a QR code is displayed."}),"\n",(0,i.jsx)(n.li,{children:"On their Mobile (Supplicant) device, the user selects an option to connect to Firefox Sync via pairing, which launches a QR code scanner."}),"\n",(0,i.jsx)(n.li,{children:"The user scans the QR code from Desktop with their Mobile device."}),"\n",(0,i.jsx)(n.li,{children:"The devices establish a secure communication channel, and Mobile sends an OAuth request for Desktop to authorize."}),"\n",(0,i.jsx)(n.li,{children:"After confirming on both devices, the user's Mobile is connected to their Firefox Account."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:'The Desktop (Authority) and Mobile (Supplicant) devices will not communicate directly, because we cannot assume that they will be on\nthe same network and because this is difficult to achieve from web content.\nInstead, they will exchange encrypted messages via WebSocket to a lightweight "channel server" service which can relay messages back and forth.\nThe flow performs a remote authorization where the already authenticated device generates Sync keys and an OAuth code for the new device.\nPKCE facilitates the transfer of the Sync key between devices and the channel server facilitates direct communication between the two, including the final transfer of the OAuth code.'}),"\n",(0,i.jsx)(n.mermaid,{value:"flowchart TD\n    A[Desktop Firefox] <--\x3e|Credential Management| C(FxA Servers)\n    B[Mobile Firefox]  <--\x3e|Credential Management| C(FxA Servers)\n    A <--\x3e |Proxied Communication Channel| D(Channel Server)\n    B <--\x3e |Proxied Communication Channel| D(Channel Server)"}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.mermaid,{value:"\nsequenceDiagram\n    participant Firefox Desktop\n    participant Channel Server\n    participant FxA Servers\n    participant Firefox Mobile\n\n    Firefox Desktop->>Channel Server: Create new websocket channel\n    Channel Server->>Firefox Desktop: Return channel ID\n    Firefox Desktop->>Firefox Mobile: Send channel ID and key via QR code\n    Firefox Mobile->>Channel Server: Connect to channel\n    rect rgb(100, 55, 100)\n    note left of Firefox Desktop: Communication between Firefox Desktop and Mobile<br/> happen via the websocket open on the channel server.  <br/>For simplicity in this diagram the two are <br/>shown sending data directly to each other.\n    Firefox Mobile->>Firefox Desktop: Send OAuth Request\n    note left of Firefox Desktop: Prompt for confirmation\n    Firefox Desktop->>Firefox Mobile: Send account metadata\n    note right of Firefox Mobile: Prompt for confirmation\n    Firefox Desktop->>FxA Servers: Authorize OAuth request and send key bundle\n    FxA Servers->>Firefox Desktop: Return OAuth code\n    Firefox Desktop->>Firefox Mobile: Send Oauth code\n    end\n    Firefox Mobile->>FxA Servers: Redeem OAuth code\n    FxA Servers->>Firefox Mobile: Return OAuth tokens and key bundle\n    note right of Firefox Mobile: Decrypt key bundle\n    note right of Firefox Mobile: Start to sync!\n\n"}),"\n",(0,i.jsx)(n.h3,{id:"detailed-flow",children:"Detailed Flow"}),"\n",(0,i.jsx)(n.p,{children:"It is advised to read the following section while looking at the detail diagram."}),"\n",(0,i.jsx)(n.mermaid,{value:"sequenceDiagram\n    actor User\n    participant Mozilla accounts on Desktop\n    participant Firefox Desktop\n    participant Channel Server\n    participant OAuth Server\n    participant Firefox Mobile\n    participant Mozilla accounts on Mobile\n\n    Firefox Desktop->>Channel Server: Create new websocket channel\n    Channel Server->>Firefox Desktop: Return channel ID\n    Firefox Desktop->>Firefox Desktop: Generate key, show QR\n    Firefox Desktop->>Firefox Mobile: Send channel ID and key via QR code\n    Firefox Mobile->>Firefox Mobile: Generate OAuth parameters\n    Firefox Mobile->>Mozilla accounts on Mobile: Open FxA w/ OAuth and channel params\n    Mozilla accounts on Mobile->>Channel Server: Connect to channel\n    Channel Server->>Mozilla accounts on Mobile: \n    Mozilla accounts on Mobile->>Channel Server: pair:supp:request w/ OAuth params\n    Channel Server->>Firefox Desktop: \n    Firefox Desktop->>Firefox Desktop: Get account and device info\n    Firefox Desktop->>Channel Server: pair:auth:metadata w/ account & device info\n    Channel Server->>Mozilla accounts on Mobile: \n    Mozilla accounts on Mobile->>Mozilla accounts on Mobile: Show confirmation screen\n    Firefox Desktop->>Mozilla accounts on Desktop: Open FxA to pairing confirm screen\n    Mozilla accounts on Desktop->>Firefox Desktop: fxaccounts:pair_supplicant_metadata\n    Firefox Desktop->>Mozilla accounts on Desktop: Supp info received earlier in pair:auth:metadata\n    Mozilla accounts on Desktop->>Mozilla accounts on Desktop: Show confirmation screen    \n    \n    User->>Mozilla accounts on Desktop: Confirms connection\n    Mozilla accounts on Desktop->>Firefox Desktop: fxaccounts:pair_authorize\n    Firefox Desktop->>Firefox Desktop: Encrypt key bundle using supp's keys_jwk\n    Firefox Desktop->>OAuth Server: Authorize OAuth request w/ supp's OAuth params & encrypted key bundle\n    OAuth Server->>Firefox Desktop: OAuth code/state\n    Firefox Desktop->>Channel Server: pair:auth:authorize w/ OAuth state & code\n    Channel Server->> Mozilla accounts on Mobile: \n    \n    note left of User: The pairing confirmations<br/> can happen in any order\n    User->> Mozilla accounts on Mobile: Confirms other side\n    Mozilla accounts on Mobile->>Channel Server: pair:supp:authorize\n    Channel Server->>Firefox Desktop: \n\n    note left of Mozilla accounts on Desktop: The heartbeat starts as soon as the confirmation screen is displayed.<br/>It helps web content surface errors and inform the remote user<br/>has accepted the pairing connection (pair:supp:authorize observed)\n    loop every second\n    Mozilla accounts on Desktop->>Firefox Desktop: fxaccounts:pair_heartbeat\n    Firefox Desktop->>Mozilla accounts on Desktop: suppAuthorized / [errors]\n    end\n\n    rect rgb(191, 223, 255)\n    note left of Firefox Mobile: [Optional] pair:auth:authorize observed AND this side confirmed\n    Mozilla accounts on Mobile->>Firefox Mobile: Redirect to relier redirect_url w/ OAuth code, state\n    Firefox Mobile->>Firefox Mobile: Trade code for token and sign-in the user\n    end\n\n    rect rgb(191, 223, 255)\n    note left of Mozilla accounts on Desktop: [Optional] suppAuthorized AND this side confirmed\n    Firefox Desktop->>Firefox Desktop: Show complete screen\n    Firefox Desktop->>Mozilla accounts on Desktop: fxaccounts:pair_complete\n    end\n"}),"\n",(0,i.jsx)(n.h4,{id:"1-desktop-opens-an-encrypted-channel-and-advertises-it-via-qr-code",children:"1) Desktop opens an encrypted channel and advertises it via QR code"}),"\n",(0,i.jsxs)(n.p,{children:["To make itself available for pairing, the Desktop device opens a connection to the Channel Server using the ",(0,i.jsx)(n.a,{href:"https://github.com/mozilla/fxa-pairing-channel",children:"fxa-pairing-channel library"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Once connected it will receive a server-allocated channel id, then the library will generate a 32-byte channel key to be used for client-side encryption of messages on the channel."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["The channel key is what secures the pairing flow.","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Any application that learns the channel key will be able to request pairing from the Desktop device, or intercept messages exchanges during the pairing flow."}),"\n",(0,i.jsx)(n.li,{children:"The fxa-pairing-channel library uses a subset the pre-shared key mode of TLS 1.3 for communication between the two devices."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:'The channel id and channel key are encoded using base64url and are then combined into a "pairing url".'}),"\n",(0,i.jsxs)(n.li,{children:["The generated URL looks like: ",(0,i.jsx)(n.code,{children:"https://accounts.firefox.com/pair#channel_id=[channel_id]&channel_key=[channel_key]"})]}),"\n",(0,i.jsx)(n.li,{children:"This URL is then encoded in a QR code and displayed on screen."}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"2-mobile-scans-the-qr-code-and-connects-to-the-encrypted-channel",children:"2) Mobile scans the QR code and connects to the encrypted channel"}),"\n",(0,i.jsxs)(n.p,{children:["To initiate pairing, the Mobile device scans the QR code displayed by Desktop and extracts the channel id and channel key.\nIt opens a WebSocket to the Channel Server using the same fxa-pairing-channel library specifying the channel id, channel key.\nThe Channel Server will now relay WebSocket messages from Mobile to Desktop and vice-versa. The ",(0,i.jsx)(n.a,{href:"https://github.com/mozilla/fxa/blob/main/packages/fxa-content-server/app/scripts/models/auth_brokers/pairing/supplicant.js",children:"supplicant broker"})," handles the creation of the ",(0,i.jsx)(n.code,{children:"PairingChannelClient"})," and the state machine. The supplicant triggers messages after user's approval and finally sends\nthe code to the relier by using the existing OAuth redirection broker."]}),"\n",(0,i.jsx)(n.h4,{id:"3-devices-exchange-metadata-and-show-confirmation-screens",children:"3) Devices exchange metadata and show confirmation screens"}),"\n",(0,i.jsx)(n.p,{children:"At this point the devices have established a baseline level of trust and can exchange metadata to allow the user to confirm the pairing on both sides.\nWe use explicit confirmation screens to reduce the risk of phishing or over-the-shoulder attacks."}),"\n",(0,i.jsxs)(n.p,{children:["The Mobile device sends what is essentially an OAuth request, delivered over the WebSocket channel rather than opened as a local web page.\nIt includes all parameters that would appear in an ordinary OAuth authorization request.\nThe exceptions are the ",(0,i.jsx)(n.code,{children:"scope"}),"and ",(0,i.jsx)(n.code,{children:"keys_jwk"})," parameters, they just get passed through when authorizing the request."]}),"\n",(0,i.jsx)(n.p,{children:'The Desktop device sends an "account metadata" message that includes information about the account being connected to.\nThe properties of that messages are listed in the "Pairing messages" section.'}),"\n",(0,i.jsx)(n.p,{children:"This information will help the Mobile device show a meaningful confirmation screen.  It's PII, but the channel has established a base level of trust between devices, so it should be safe to share this information directly."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Upon receiving the metadata message from the other device, both Desktop and Mobile show an explicit confirmation screen."}),"\n",(0,i.jsxs)(n.li,{children:["To show the confirmation screen on desktop, the Desktop (Authority) side transitions from ",(0,i.jsx)(n.code,{children:"about:preferences"})," Firefox UI to\nthe fxa-content-server hosted page. This engages the ",(0,i.jsx)(n.a,{href:"https://github.com/mozilla/fxa/blob/main/packages/fxa-content-server/app/scripts/models/auth_brokers/pairing/authority.js",children:"authority broker"})," and establishes ",(0,i.jsx)(n.a,{href:"https://developer.mozilla.org/docs/Mozilla/JavaScript_code_modules/WebChannel.jsm",children:"WebChannel communication"})," with Native code."]}),"\n",(0,i.jsx)(n.li,{children:"There's no set confirmation order: the Supplicant and the Authority will show the confirmations screens at the same time, and can be accepted in any order."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"For additional security, the Channel Server annotates each message with information about the originating device, such as geoip lookup data. This may help the user detect if they're connecting to a different device than expected."}),"\n",(0,i.jsx)(n.h4,{id:"4-desktop-device-authorizes-oauth-request",children:"4) Desktop device authorizes OAuth request"}),"\n",(0,i.jsx)(n.p,{children:"When the user accepts the confirmation screen on the Desktop device, it will use its local credentials to authorize the OAuth request from the Mobile device. This involves no user interaction, and will include the following steps:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Check that redirect_uri is the expected value; error out if not."}),"\n",(0,i.jsxs)(n.li,{children:["Check that scope contains exactly ",(0,i.jsx)(n.code,{children:'"profile"'})," and ",(0,i.jsx)(n.code,{children:'"https://identity.mozilla.com/apps/oldsync"'}),"; error out if not."]}),"\n",(0,i.jsx)(n.li,{children:"Check that client_id is the expected value; error out if not."}),"\n",(0,i.jsx)(n.li,{children:"Check that state exists and is well formed; error out if not."}),"\n",(0,i.jsxs)(n.li,{children:["Build the scoped-key bundle for ",(0,i.jsx)(n.code,{children:'"https://identity.mozilla.com/apps/oldsync"'}),", encrypting it with the provided ",(0,i.jsx)(n.code,{children:"keys_jwk"})," to produce ",(0,i.jsx)(n.code,{children:"keys_jwe"}),"."]}),"\n",(0,i.jsx)(n.li,{children:"Generate a BrowserID assertion with the fxa-oauth-server as audience."}),"\n",(0,i.jsxs)(n.li,{children:["POST all of this to fxa-oauth-server at ",(0,i.jsx)(n.code,{children:"/v1/authorization"})," and receive back an OAuth code and state response parameters."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Desktop will then send the code and state parameters back to Mobile over the WebSocket channel, encrypted as before with the channel key."}),"\n",(0,i.jsx)(n.h4,{id:"5-mobile-receives-oauth-response-and-connects-to-sync",children:"5) Mobile receives OAuth response and connects to Sync"}),"\n",(0,i.jsxs)(n.p,{children:["When the user accepts the confirmation screen on the Mobile device, it will listen for the message produced by the Desktop device in step (4) above.\nAfter receiving the message, it can tear down its WebSocket channel. The supplicant broker redirect step is captured by the Native app, as part of that step the ",(0,i.jsx)(n.code,{children:"code"})," and ",(0,i.jsx)(n.code,{children:"state"})," params are extracted from the redirect url."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"The mobile application can now complete its OAuth flow in its Native code just as if it had received code and state via a standard web-content-based OAuth flow:"}),"\n",(0,i.jsxs)(n.li,{children:["Submit the code to fxa-oauth-server at ",(0,i.jsx)(n.code,{children:"/v1/token"})," in exchange for an access token, refresh token, and bundle of encrypted key material."]}),"\n",(0,i.jsx)(n.li,{children:"Decrypt the bundle of key material with its keys_jwk private key."}),"\n",(0,i.jsx)(n.li,{children:"Fetch user profile data, and check that it matches the data provided by Desktop in step (3)."}),"\n",(0,i.jsx)(n.li,{children:"Use the access token and key material to access Firefox Sync."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"intended-security-properties",children:"Intended Security Properties"}),"\n",(0,i.jsx)(n.p,{children:"The security-related design goals of this system are as follows:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"The result of the flow is the same as if the Mobile device had done an ordinary\nweb-content-based OAuth flow. It obtains its own OAuth tokens for the user's Firefox\naccount, with appropriate scopes and a copy of the relevant key material."}),"\n",(0,i.jsx)(n.li,{children:"The messages relayed between Desktop and Mobile cannot be read or forged by any\nother party."}),"\n",(0,i.jsxs)(n.li,{children:["On the signed-in Desktop device:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["The flow cannot be used to surreptitiously extract FxA key material (such as the\nuser's sync keys) from the browser, not even by Mozilla's servers or by web\ncontent running on ",(0,i.jsx)(n.a,{href:"https://accounts.firefox.com",children:"https://accounts.firefox.com"}),"."]}),"\n",(0,i.jsx)(n.li,{children:"There is no way for third-party web content to initiate a pairing flow, which might\nbe used for phishing purposes."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["On the connecting Mobile device:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Handling of FxA key material is as or more secure than the existing web-based\nscoped-keys flow."}),"\n",(0,i.jsx)(n.li,{children:"There is no way for third-party apps or web content to trigger the pairing flow,\nwhich might be used for phishing purposes."}),"\n",(0,i.jsx)(n.li,{children:"If the user scans the QRcode with a third-party app rather than a Mobile Firefox\nbrowser, then that app can only gain access to the user's account by actively\nphishing the user into completing the flow; it cannot silently insert itself as\na meddler-in-the-middle of a legitimate flow with the user's actual Firefox browser."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"These properties are enforced by the following features/mitigations:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["The communication channel between the two devices is secured by:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Communication between Desktop and Mobile is encrypted and authenticated using a\nTLS1.3 PSK handshake, with the key obtained by scanning the QR code. This guards\nagainst eavesdropping or MitM by anyone who does not have the channel key\n(including the channelserver that is proxying the messages, since it has no way to\nobtain the key)."}),"\n",(0,i.jsxs)(n.li,{children:["Communications are routed through the Mozilla-hosted channelserver, authenticated\nwith standard TLS PKI. The channelserver enforces that only two connections are\nmade on a channel, providing additional protection against eavesdropping or MitM\nby third-party software ",(0,i.jsx)(n.em,{children:"even if"})," such software somehow obtains the channel key."]}),"\n",(0,i.jsx)(n.li,{children:"The mobile device must directly scan the QR code in order to initiate the flow.\nThis prevents a third-party scanner that happens to intercept the channel key\nfrom inserting itself as a MitM, with one channel open to the Desktop device and\na second channel open to the Mobile device."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"Inside the communication channel, the devices execute a largely unmodified variant of\nthe existing FxA scoped-keys OAuth flow, so the exchange inherits the existing\nsecurity boundaries/properties of that flow."}),"\n",(0,i.jsxs)(n.li,{children:["When authorizing the OAuth request, Firefox Desktop is directly responsible for\nencrypting the scoped-keys bundle using the OAuth request parameters it received over\nthe pairing channel. There is thus no opportunity for web content running on the\ndesktop device to see the raw scoped-keys key material.","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Web content cannot, for example, inject its own ",(0,i.jsx)(n.code,{children:"keys_jwk"})," parameter into\nthe OAuth flow in order to MitM the scoped-keys exchange. This is an improvement\nover the current state of the web-based OAuth flow, in which web content can\ndirectly handle the account key material."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"exchanged-messages-specification",children:"Exchanged messages specification"}),"\n",(0,i.jsx)(n.p,{children:"The pairing flow is made possible by messages that are forwarded between the Desktop native code and the web content page opened on the supplicant device."}),"\n",(0,i.jsx)(n.p,{children:"The Firefox Desktop native code gathers information from web content via WebChannels and communicates that to the supplicant using the\nchannel server socket."}),"\n",(0,i.jsxs)(n.p,{children:["Meanwhile, the web content opened on the supplicant device connects directly to a WebSocket, without native code infrastructure.\nIt waits for user's approval on both sides of the flow and once that is achieved, it can receive the OAuth ",(0,i.jsx)(n.code,{children:"code"})," and ",(0,i.jsx)(n.code,{children:"state"}),"\nfrom the authority side of the pairing flow."]}),"\n",(0,i.jsx)(n.h3,{id:"pairing-channel-messages",children:"Pairing Channel messages"}),"\n",(0,i.jsx)(n.p,{children:"The message payload is a JSON object that contains a message identifier and a data object.\nEvery message envelope also contains information about the sender (IP address, geolocation..).\nHere's an example of the channel server envelope:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'data: {\n  ...,\n  "remoteMetaData": {\n    "city": "Kanata",\n    "country": "Canada",\n    "region": "Ontario",\n    "ua": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.10; rv:40.0) Gecko/20100101 Firefox/40.0",\n    "ipAddress": "1.1.1.1"\n  }\n}\n'})}),"\n",(0,i.jsxs)(n.h4,{id:"pairsupp",children:["pair:supp",":request"]}),"\n",(0,i.jsx)(n.p,{children:"Direction: Supp -> Auth"}),"\n",(0,i.jsx)(n.p,{children:"Description: Sent right after connecting to the pairing channel by the supp. Contains OAuth request parameters, a key encryption JWK if required by the relier."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  message: "pair:supp:request",\n  data: {\n    // See the OAuth server API doc for a description of the parameters.\n    access_type,\n    client_id,\n    code_challenge,\n    code_challenge_method,\n    // FxA Scoped Keys key-fetching public key (base64url encoded).\n    [keys_jwk,].\n    scope,\n    state,\n  },\n}\n'})}),"\n",(0,i.jsxs)(n.h4,{id:"pairauth",children:["pair:auth",":metadata"]}),"\n",(0,i.jsx)(n.p,{children:"Direction: Auth -> Supp"}),"\n",(0,i.jsx)(n.p,{children:"Description: Sent by the Auth and contains the account and device information of the Auth."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  message: "pair:auth:metadata",\n  data: {\n    email,\n    avatar,\n    displayName,\n    deviceName,\n  },\n}\n'})}),"\n",(0,i.jsxs)(n.h4,{id:"pairauth-1",children:["pair:auth",":authorize"]}),"\n",(0,i.jsx)(n.p,{children:"Direction: Auth -> Supp"}),"\n",(0,i.jsx)(n.p,{children:"Description: Sent by the Auth once the pairing has been confirmed by the user on this side. Contains an OAuth code that can be traded for a token."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  message: "pair:auth:authorize",\n  data: {\n    // See the OAuth server API doc for a description of the parameters.\n    code,\n    state,\n    redirect,\n  },\n}\n'})}),"\n",(0,i.jsxs)(n.h4,{id:"pairsupp-1",children:["pair:supp",":authorize"]}),"\n",(0,i.jsx)(n.p,{children:"Direction: Supp -> Auth"}),"\n",(0,i.jsx)(n.p,{children:"Description: Sent by the Supp once the pairing has been confirmed by the user on this side."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  message: "pair:supp:authorize",\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"desktop-webchannel-messages",children:"Desktop WebChannel messages"}),"\n",(0,i.jsx)(n.p,{children:"On Desktop, the Mozilla accounts Web Content page communicates with the native code (which owns the pairing channel connection) using WebChannel.\nWebChannel messages can only be initiated from the content side, however the native side can send a response."}),"\n",(0,i.jsxs)(n.h4,{id:"fxaccounts",children:["fxaccounts",":pair_supplicant_metadata"]}),"\n",(0,i.jsx)(n.p,{children:"Description: Allows the web content to request the supp\u2019s device information."}),"\n",(0,i.jsx)(n.p,{children:"Expected response:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:"{\n  ua,\n  city,\n  region,\n  country,\n  ipAddress,\n}\n"})}),"\n",(0,i.jsxs)(n.h4,{id:"fxaccounts-1",children:["fxaccounts",":pair_authorize"]}),"\n",(0,i.jsx)(n.p,{children:"Allows the web content to inform the native side the confirmation dialog has been accepted."}),"\n",(0,i.jsx)(n.p,{children:"Expected response: N/A"}),"\n",(0,i.jsxs)(n.h4,{id:"fxaccounts-2",children:["fxaccounts",":pair_heartbeat"]}),"\n",(0,i.jsx)(n.p,{children:'Description: Sent by the web content every second or so. Allows to surface errors but to also transition to a "completed" screen once the supp side has confirmed the pairing request.'}),"\n",(0,i.jsx)(n.p,{children:"Expected Response:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:"{\n  err, // String\n}\n<OR>\n{\n  suppAuthorized, // Boolean\n}\n\n"})}),"\n",(0,i.jsxs)(n.h4,{id:"fxaccounts-3",children:["fxaccounts",":pair_complete"]}),"\n",(0,i.jsx)(n.p,{children:"Description: Allows the web content to inform the native side it is aware the flow is finished, has shown a confirmation screen and the resources can be finalized on the native side."}),"\n",(0,i.jsx)(n.p,{children:"Expected Response: N/A"}),"\n",(0,i.jsx)(n.h2,{id:"other-details",children:"Other Details"}),"\n",(0,i.jsx)(n.h3,{id:"routes",children:"Routes"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["The Mobile (Supplicant) side, implements the following URL: ",(0,i.jsx)(n.code,{children:"https://accounts.firefox.com/pair/supp"})]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"This view accepts OAuth query parameters equivalent to those on the existing /oauth/ view, and will accept the channel id and channel key as parameters in the URL hash fragment.  The view performs the entire Mobile side of the protocol, including:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"connecting to the provided channel via WebSocket"}),"\n",(0,i.jsx)(n.li,{children:"passing the OAuth request to the Desktop over the WebSocket channel"}),"\n",(0,i.jsx)(n.li,{children:"displaying a confirmation screen using the account metadata information sent by Desktop"}),"\n",(0,i.jsx)(n.li,{children:"receiving OAuth code and state from Desktop over the WebSocket channel."}),"\n",(0,i.jsx)(n.li,{children:"completing the OAuth flow by redirecting back to the relier"}),"\n"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["The Desktop (Authority) side, loads the following URL: ",(0,i.jsx)(n.code,{children:"https://accounts.firefox.com/pair/auth"})]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"This view establishes communication with Native Desktop code. The Native Desktop code takes care of the following:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"establishing the WebSocket channel and corresponding secret key"}),"\n",(0,i.jsxs)(n.li,{children:["displaying the QR code as a URL to ",(0,i.jsx)(n.code,{children:"https://accounts.firefox.com/pair"})]}),"\n",(0,i.jsx)(n.li,{children:"receiving the OAuth request from the Mobile device"}),"\n",(0,i.jsx)(n.li,{children:"constructing the keys_jwe bundle and authorizing the OAuth request"}),"\n",(0,i.jsx)(n.li,{children:"return the OAuth code to the Mobile device over the WebSocket channel"}),"\n",(0,i.jsx)(n.li,{children:"communicating between Native code and Authority web content using WebChannels"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"qr-code-and-urls",children:"QR Code and URLs"}),"\n",(0,i.jsxs)(n.p,{children:["The QR code is a URL: ",(0,i.jsx)(n.code,{children:"https://accounts.firefox.com/pair/#channel_id=XYZ&channel_key=ABC"})]}),"\n",(0,i.jsx)(n.p,{children:"When the Mobile device scans this from the QR code, it parses out the channel parameters and combines them with its OAuth request parameters to produce a URL like the following:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"https://accounts.firefox.com/pair/supp\n?client_id=<the client's oauth client id>\n&state=<generated state token>\n&scope=<scopes to request>\n&code_challenge=<generated PKCE challenge>\n&code_challenge_method=<generated PKCE challenge method>\n&keys_jwk=<generated public key>\n&redirect_uri=<the client's registered redirect_uri>\n#channel_id=XYZ&channel_key=ABC\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Open the constructed URL, just as it would if it were initiating a standard username-and-password OAuth flow.\nWait for a redirect from the opened OAuth flow to return ",(0,i.jsx)(n.code,{children:"code"})," and ",(0,i.jsx)(n.code,{children:"state"})," parameters."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["After the OAuth flow redirects with the ",(0,i.jsx)(n.code,{children:"code"}),", it can be exchanged for the ",(0,i.jsx)(n.code,{children:"keys_jwe"})," bundle."]}),"\n",(0,i.jsxs)(n.li,{children:["Decrypt the key bundle using corresponding private key for ",(0,i.jsx)(n.code,{children:"keys_jwk"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["The Desktop pairing flow implements a custom ",(0,i.jsx)(n.code,{children:"redirect_uri"})," - ",(0,i.jsx)(n.code,{children:"urn:ietf:wg:oauth:2.0:oob:pair-auth-webchannel"}),". This indicates that this is a pairing flow."]}),"\n"]})]})}function d(e={}){const{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},11151:(e,n,t)=>{t.d(n,{Z:()=>r,a:()=>s});var i=t(67294);const o={},a=i.createContext(o);function s(e){const n=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);