<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-relying-parties/tutorials/integration-with-fxa" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Integration with FxA | Firefox Ecosystem Platform</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://mozilla.github.io/ecosystem-platform/relying-parties/tutorials/integration-with-fxa"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Integration with FxA | Firefox Ecosystem Platform"><meta data-rh="true" name="description" content="Last updated: September 7th, 2023"><meta data-rh="true" property="og:description" content="Last updated: September 7th, 2023"><link data-rh="true" rel="icon" href="/ecosystem-platform/img/firefox-logo.png"><link data-rh="true" rel="canonical" href="https://mozilla.github.io/ecosystem-platform/relying-parties/tutorials/integration-with-fxa"><link data-rh="true" rel="alternate" href="https://mozilla.github.io/ecosystem-platform/relying-parties/tutorials/integration-with-fxa" hreflang="en"><link data-rh="true" rel="alternate" href="https://mozilla.github.io/ecosystem-platform/relying-parties/tutorials/integration-with-fxa" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://RFM5H13DFK-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Firefox Ecosystem Platform" href="/ecosystem-platform/opensearch.xml"><link rel="stylesheet" href="/ecosystem-platform/assets/css/styles.b0ab5bf8.css">
<script src="/ecosystem-platform/assets/js/runtime~main.cd4a9361.js" defer="defer"></script>
<script src="/ecosystem-platform/assets/js/main.d163ad31.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/ecosystem-platform/img/firefox-logo.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/ecosystem-platform/"><div class="navbar__logo"><img src="/ecosystem-platform/img/firefox-logo.png" alt="Ecosystem Platform Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/ecosystem-platform/img/firefox-logo.png" alt="Ecosystem Platform Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Firefox Ecosystem Platform</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/mozilla/ecosystem-platform" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ecosystem-platform/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active">For Relying Parties</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/ecosystem-platform/relying-parties/tutorials/integration-with-fxa">Tutorials</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/ecosystem-platform/relying-parties/tutorials/integration-with-fxa">Integration with FxA</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/relying-parties/tutorials/integration-with-subscription-platform">Integration with Subscription Platform</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/relying-parties/tutorials/pairing">Pairing authentication</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/ecosystem-platform/relying-parties/how-tos/end-to-end-encryption">How-to Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/ecosystem-platform/relying-parties/reference/glossary">Reference</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">For FxA Engineers</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/ecosystem-platform/tutorials/development-setup">Tutorials</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/ecosystem-platform/how-tos/ci-guidelines">How-to Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/ecosystem-platform/reference/team-processes/development-process">Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/ecosystem-platform/explanation/architectural-decision-records">Explanation</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/additional-docs">Additional Docs</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">For Support Agents</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/ecosystem-platform/reference/admin-panel">Reference</a></div></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/ecosystem-platform/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">For Relying Parties</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Tutorials</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Integration with FxA</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Integration with FxA</h1></header><p>Last updated: <code>September 7th, 2023</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2>
<p>Mozilla accounts integration is available for Mozilla groups on request. This integration is handled using <a href="https://openid.net/connect/" target="_blank" rel="noopener noreferrer">OpenID Connect (OIDC)</a>, <a href="https://auth0.com/docs/protocols/oauth2" target="_blank" rel="noopener noreferrer">OAuth 2.0</a>, and <a href="https://en.wikipedia.org/wiki/Webhook" target="_blank" rel="noopener noreferrer">webhooks</a> for authentication, authorization, and receiving events regarding FxA users. Integrations with FxA assume the role of a <a href="https://en.wikipedia.org/wiki/Relying_party" target="_blank" rel="noopener noreferrer">Relying Party (RP)</a> and/or a <a href="https://www.oauth.com/oauth2-servers/the-resource-server/" target="_blank" rel="noopener noreferrer">Resource Server (RS)</a> depending on the type of integration, with FxA assuming the role of an OpenID Provider.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>This tutorial will help you integrate with Mozilla accounts but there are <a href="/ecosystem-platform/relying-parties/reference/integration-requirements">additional requirements a relying party is expected to fulfill and maintain</a>.  Please ensure you&#x27;re in compliance with expectations to continue uninterrupted service.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="pre-development">Pre-Development<a href="#pre-development" class="hash-link" aria-label="Direct link to Pre-Development" title="Direct link to Pre-Development">​</a></h2>
<p>Before starting integration, please send a request to fxa-staff[at]mozilla.com to request a short meeting so we can all document our expectations and timelines.  Please include answers to the following questions in the email:</p>
<ol start="0">
<li>
<p><strong>What type of Relying Party / Resource Server are you integrating?</strong>
Examples would be, a web site, a native app, a browser, an API, or an extension in the browser.</p>
<p>Most integrations will be a Relying Party, not a Resource Server. <a href="#relying-party-vs-resource-server">See below for clarification</a> on the differences.</p>
</li>
<li>
<p><strong>Do you know how to implement OIDC/OAuth?</strong></p>
</li>
<li>
<p><strong>Will you need read access to a user’s profile data?</strong>
See <a href="#profile-data">available profile data</a>.</p>
</li>
<li>
<p><strong>Will you need <em>ongoing</em> read access to a user’s profile data even if the user isn&#x27;t actively logging in?</strong>
If necessary, a relying party can use a <em>refresh token</em> to query
for a user&#x27;s profile data, whether or not that user is logged in to the
relying party.  For example, if a user changes their email address and
the relying party wants to update their local database with the changes.</p>
<p>A refresh token is given out if <code>access_type=offline</code> when making the
authorization request.</p>
</li>
<li>
<p><strong>Will you need <em>write</em> access to a user’s profile data?</strong>
Only the <code>avatar</code> and <code>displayname</code> can be changed remotely.  See the <a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-profile-server/docs/API.md#api-endpoints" target="_blank" rel="noopener noreferrer">API
documentation</a>.</p>
</li>
<li>
<p><strong>Will you need to access Sync data?</strong>
This is likely only needed for browser integrations.  Most relying parties
will not need this.</p>
</li>
<li>
<p><strong>Will you need encryption keys to encrypt user data?</strong>
Optionally, when a relying party gets their access token they can also get
a stable encryption key back (this is a <em>scoped key</em>).  This key is derived
from the user&#x27;s password and <strong>if the user changes or forgets their
password this key will change</strong>.</p>
</li>
<li>
<p><strong>Will your application display its own “enter your email” form?</strong>
Providing your own form can give users a tight knit experience, but you&#x27;ll
need to send your own <a href="#self-hosted-email-first-flow">top of funnel
metrics</a> if you do.</p>
</li>
<li>
<p><strong>Who are the stakeholders?</strong></p>
</li>
<li>
<p><strong>Who can be contacted for important updates, e.g., API changes?</strong></p>
</li>
<li>
<p><strong>What is the schedule and key dates?</strong>
At a minimum, when will QA start, when do you want to be live?</p>
</li>
<li>
<p><strong>Roughly, what amount of traffic do you expect?</strong></p>
</li>
<li>
<p><strong>Will your integration provide a subscription service?</strong>
If it will, please describe the products your integration will provide
service for.</p>
</li>
<li>
<p><strong>Will your integration include subscription lead pages?</strong>
These are generally marketing pages that include a link to start the
subscription flow.</p>
</li>
<li>
<p><strong>Will you utilize JWT tokens?</strong>
This is rare.  <a href="/ecosystem-platform/reference/tokens#jwt-access-tokens">Learn more</a>.</p>
</li>
</ol>
<p>We communicate with our relying parties via the <a href="https://groups.google.com/a/mozilla.com/g/firefox-accounts-notices" target="_blank" rel="noopener noreferrer">firefox-accounts-notices group</a>.  Please join this list to avoid any surprises.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="openid-connect-integration">OpenID Connect Integration<a href="#openid-connect-integration" class="hash-link" aria-label="Direct link to OpenID Connect Integration" title="Direct link to OpenID Connect Integration">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="relying-party-vs-resource-server">Relying Party vs. Resource Server<a href="#relying-party-vs-resource-server" class="hash-link" aria-label="Direct link to Relying Party vs. Resource Server" title="Direct link to Relying Party vs. Resource Server">​</a></h3>
<p>A Relying Party (RP) is an application or website that outsources its user authentication functionality to an OpenID Provider, defined as part of the OpenID specifications. The user will be prompted to login to the Relying Party with their Firefox Account, and is able to see the login as a distinct <a href="https://accounts.firefox.com/settings#connected-services" target="_blank" rel="noopener noreferrer">Connected Service</a> in FxA Settings. OpenID Connect contains many specifications for a variety of identity exchange and authorization, based on the OAuth 2.0 framework of specifications.</p>
<p>A Relying Party may also act as a Resource Server, an OAuth 2.0 term for an API server. In that case a user will never see a direct Relying Party login and will not see a distinct row in their Connected Devices list on the FxA Settings page. Services that are accessed via Firefox (Sync, Relay, etc.) using its OAuth token are all examples of Resource Servers. Their access shows up in FxA Settings as the browser session the user is logged into.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="development">Development<a href="#development" class="hash-link" aria-label="Direct link to Development" title="Direct link to Development">​</a></h3>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>You are encouraged to use <a href="https://accounts.stage.mozaws.net/" target="_blank" rel="noopener noreferrer">our staging servers</a> to develop against.  Our staging server has a persistent database and changes made there are saved.  Spot testing and some new accounts are fine but you are expected to clean up any significant amount of data (eg. accounts made from automated testing).  If you&#x27;re using PyFxA <a href="https://pypi.org/project/PyFxA/#testing-email-addresses" target="_blank" rel="noopener noreferrer">here is an example</a> using <code>destroy_account()</code>.</p></div></div>
<ol start="0">
<li>Review the <a href="https://openid.net/developers/how-connect-works/" target="_blank" rel="noopener noreferrer">OpenID Connect</a> and <a href="https://auth0.com/docs/protocols/oauth2" target="_blank" rel="noopener noreferrer">OAuth 2.0</a> documentation.</li>
<li>Register for staging OAuth credentials by filing an issue in the SVCSE project in <a href="https://mozilla-hub.atlassian.net" target="_blank" rel="noopener noreferrer">Mozilla&#x27;s Jira</a>. See <a href="#oauth-credentials">OAuth credentials</a>.</li>
<li>Your development servers should point to: <code>https://oauth.stage.mozaws.net</code>.</li>
<li>User authentication follows the <a href="https://openid.net/connect/" target="_blank" rel="noopener noreferrer">OpenID Connect</a> protocol.</li>
<li><a href="#authorization-query-parameters">Query parameters</a> are set and validate when redirecting to Mozilla accounts.</li>
<li>If you are <a href="#self-hosted-email-first-flow">hosting your own login form</a> initialize and propagate the top of funnel metrics.</li>
<li><a href="#user-data-hygiene">User data and account notifications are properly</a> handled and compliant with Firefox Account requirements.</li>
<li>An icon suitable to display in Firefox Account’s <a href="https://accounts.firefox.com/settings#connected-services" target="_blank" rel="noopener noreferrer">Connected Services</a> list has been sent to Firefox Account developers.  Please confirm with Mozilla accounts what the current requirements are.</li>
<li>If multiple <a href="https://www.oauth.com/oauth2-servers/the-resource-server/" target="_blank" rel="noopener noreferrer">Resource Servers</a> are accessed, create a distinct token for communicating with each server, limited to only the scopes required by that server.  This may mean dropping your initial access token and using a refresh token to get additional, less privileged access tokens.</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="preparing-for-production">Preparing for Production<a href="#preparing-for-production" class="hash-link" aria-label="Direct link to Preparing for Production" title="Direct link to Preparing for Production">​</a></h3>
<ol start="0">
<li>Update your deployment bug asking for production OAuth credentials and setup of your production <a href="#register-for-webhooks">webhook endpoint</a>.</li>
<li>Production servers point to <code>https://oauth.accounts.firefox.com/</code>.  Additional endpoints can be discovered dynamically at <code>https://accounts.firefox.com/.well-known/openid-configuration</code>.</li>
<li>Someone from the FxA team has reviewed the integration code and tested the flow.</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="user-authentication-with-openid-connect-in-a-nutshell">User Authentication with OpenID Connect in a nutshell<a href="#user-authentication-with-openid-connect-in-a-nutshell" class="hash-link" aria-label="Direct link to User Authentication with OpenID Connect in a nutshell" title="Direct link to User Authentication with OpenID Connect in a nutshell">​</a></h3>
<ol start="0">
<li>Create a state token (randomly generated and unguessable) and associate it with a local session.</li>
<li>Send <a href="#authorization-query-parameters">/authentication request</a> to Mozilla accounts. Upon completion, Mozilla accounts redirects back to your app with state and code.</li>
<li>Confirm the returned state token by comparing it with the state token associated with the local session.</li>
<li>Exchange the code for an access token and possibly a refresh token.</li>
<li>If you asked for <code>scope=profile</code> you can fetch user profile information, using the access token, from the FxA Profile Server.</li>
<li>Associate the profile information with the local session and create an account in the local application database as needed.</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="oauth-credentials">OAuth Credentials<a href="#oauth-credentials" class="hash-link" aria-label="Direct link to OAuth Credentials" title="Direct link to OAuth Credentials">​</a></h3>
<p>OAuth Client Credentials are needed for each application accessing FxA. For example, a website that users can login to with mobile applications for iOS and Android should request 3 sets of OAuth credentials, one for each mobile app/platform, and one for the web service.</p>
<ol start="0">
<li>client_id - a public identifier that is used to identify your service. Can be public.</li>
<li>client_secret - a private secret that is sent from the backend when interacting with the OAuth server. Must not be shared publicly, checked into a public repository, or bundled with compiled code.</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="profile-data">Profile Data<a href="#profile-data" class="hash-link" aria-label="Direct link to Profile Data" title="Direct link to Profile Data">​</a></h3>
<p>Mozilla accounts only stores core identity data and associated profile information about users. Mozilla accounts does not store user data specific to relying services. Core identity data stored in Mozilla accounts includes:</p>
<ul>
<li>a stable user identifier (uid)</li>
<li>the user provided email address</li>
<li>the user&#x27;s locale provided by the browser during account creation</li>
<li>an optional display name</li>
<li>an optional profile image</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="authorization-query-parameters">/authorization query parameters<a href="#authorization-query-parameters" class="hash-link" aria-label="Direct link to /authorization query parameters" title="Direct link to /authorization query parameters">​</a></h3>
<ol start="0">
<li><code>client_id</code> (required)</li>
<li><code>scope</code> (required). This is a space separated string. Review the list of <a href="#scopes">scopes</a>.</li>
<li><code>state</code> (required).  This must be a randomly generated unguessable string.</li>
<li><code>entrypoint</code> (required).  This is for metrics purposes and should represent the service making the request.  This should be agreed upon by the Mozilla accounts team.</li>
<li><code>email</code> (required for <a href="#self-hosted-email-first-flow">self hosted email-first flow</a>)</li>
<li><code>flow_begin_time</code> (required for <a href="#self-hosted-email-first-flow">self hosted email-first flow</a>)</li>
<li><code>flow_id</code> (required for <a href="#self-hosted-email-first-flow">self hosted email-first flow</a>)</li>
<li><code>code_challenge</code> (required for PKCE) This is a hash of a randomly generated string.</li>
<li><code>code_challenge_method</code> (required for PKCE) As of this writing only <code>s256</code> is supported.</li>
<li><code>action</code> (suggested).  This should be either <code>email</code> or <code>force_auth</code>.</li>
<li><code>access_type</code> (suggested).  This should be either <code>online</code> or <code>offline</code>.</li>
<li><code>utm_campaign</code> (suggested)</li>
<li><code>utm_source</code> (suggested)</li>
<li><code>utm_medium</code> (optional)</li>
<li><code>utm_term</code> (optional)</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="scopes">Scopes<a href="#scopes" class="hash-link" aria-label="Direct link to Scopes" title="Direct link to Scopes">​</a></h3>
<p>This will be <code>scope=profile</code> for most Relying Parties, but there is <a href="/ecosystem-platform/reference/oauth-details#oauth-scopes">further documentation</a> which integrations acting as a <a href="https://www.oauth.com/oauth2-servers/the-resource-server/" target="_blank" rel="noopener noreferrer">Resource Server</a> should be aware of.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="webhook-events">Webhook Events<a href="#webhook-events" class="hash-link" aria-label="Direct link to Webhook Events" title="Direct link to Webhook Events">​</a></h3>
<p>If your integration includes an application service that stores profile information, you should create a <a href="https://en.wikipedia.org/wiki/Webhook" target="_blank" rel="noopener noreferrer">webhook</a> URL handler to handle <a href="https://tools.ietf.org/html/rfc8417" target="_blank" rel="noopener noreferrer">Security Event Tokens (SET)</a> for <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-event-broker#relying-party-event-format" target="_blank" rel="noopener noreferrer">Relying Party events</a>. These events will need to be verified using the FxA JWT keys that can be found from following the <code>jwks_uri</code> in the FxA well-known open-id configuration. For production, this URL is <code>https://accounts.firefox.com/.well-known/openid-configuration</code>.</p>
<p>The FxA JWT public keys should be retrieved from this URL at start-up, and used to verify the webhook JWT. The <a href="https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-tokens-verifying-a-jwt.html" target="_blank" rel="noopener noreferrer">documentation on verifying a JWT</a> for Step 1/2 are applicable to FxA JWT events.</p>
<p>Integrations that are acting as a <a href="https://www.oauth.com/oauth2-servers/the-resource-server/" target="_blank" rel="noopener noreferrer">Resource Server</a> will need to respond successfully with a 200 status code even if the user referenced has not used the integration.</p>
<p>If you&#x27;re using TypeScript, an example of verifying a JWT is shown here:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> http </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;http&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> jwt </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;jsonwebtoken&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> jwkToPem </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;jwk-to-pem&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">authenticate</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">request</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">IncomingMessage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> object </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Assuming this is how you retrieve your auth header.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> authHeader </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> request</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">headers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">authorization</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Require an auth header</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token plain">authHeader</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">throw</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">Error</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;No auth header found&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Extract the first portion which should be &#x27;Bearer&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> headerType </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> authHeader</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">substr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> authHeader</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">indexOf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27; &#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">headerType </span><span class="token operator" style="color:rgb(137, 221, 255)">!==</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Bearer&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">throw</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">Error</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Invalid auth type&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// The remaining portion, which should be the token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> headerToken </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> authHeader</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">substr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">authHeader</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">indexOf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27; &#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Decode the token, require it to come out ok as an object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> token </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> jwt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">decode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">headerToken</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> complete</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token plain">token </span><span class="token operator" style="color:rgb(137, 221, 255)">||</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">typeof</span><span class="token plain"> token </span><span class="token operator" style="color:rgb(137, 221, 255)">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;string&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">throw</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">Error</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Invalid token type&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Verify we have a key for this kid, this assumes that you have fetched</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// the publicJwks from FxA and put both them in an Array.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> jwk </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> publicJwks</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">find</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">j </span><span class="token operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> j</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">kid </span><span class="token operator" style="color:rgb(137, 221, 255)">===</span><span class="token plain"> token</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">header</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">kid</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token plain">jwk</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">throw</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">Error</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;No jwk found for this kid: &#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> token</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">header</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">kid</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> jwkPem </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">jwkToPem</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">jwk</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Verify the token is valid</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> decoded</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">string</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> object </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> jwt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">verify</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">headerToken</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> jwkPem</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        algorithms</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;RS256&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token function" style="color:rgb(130, 170, 255)">isIdToken</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">decoded</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">throw</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">Error</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Invalid token format: &#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> decoded</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// This is the JWT data itself.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> decoded</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Webhooks are processed from our event broker service. Currently, we emit events for password change, profile change, subscription change and delete account.</p>
<p>For additional documentation please reference the <a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-event-broker/README.md" target="_blank" rel="noopener noreferrer">readme</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="register-for-webhooks">Register for webhooks<a href="#register-for-webhooks" class="hash-link" aria-label="Direct link to Register for webhooks" title="Direct link to Register for webhooks">​</a></h3>
<p>Once you have setup a service to receive webhook events, you can then register the webhook url by creating a pull request in <a href="https://github.com/mozilla-services/cloudops-infra" target="_blank" rel="noopener noreferrer">cloudops-infra</a>. To edit webhooks coming from FxA stage, you&#x27;ll need to edit <a href="https://github.com/mozilla-services/cloudops-infra/blob/master/projects/fxa/tf/nonprod/envs/stage/resources/eventbroker.tf#L16-L77" target="_blank" rel="noopener noreferrer">projects/fxa/tf/nonprod/envs/stage/resources/eventbroker.tf</a>. To edit webhooks coming from FxA prod you&#x27;ll need to edit <a href="https://github.com/mozilla-services/cloudops-infra/blob/master/projects/fxa/tf/prod/envs/prod/resources/eventbroker.tf#L16-L82" target="_blank" rel="noopener noreferrer">projects/fxa/tf/prod/envs/prod/resources/eventbroker.tf</a>. You&#x27;ll need to add your client id to <code>endpoint_topic_config</code>, and your webhook url to <code>endpoint_subscription_config</code>. See an <a href="https://github.com/mozilla-services/cloudops-infra/pull/3727" target="_blank" rel="noopener noreferrer">example PR</a>.</p>
<p>Integrations that are acting as a <a href="https://www.oauth.com/oauth2-servers/the-resource-server/" target="_blank" rel="noopener noreferrer">Resource Server</a> should indicate their role when having their webhook URL endpoint configured by the FxA team, this is a separate option in the webhook configuration.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="some-flow-diagrams">Some flow diagrams<a href="#some-flow-diagrams" class="hash-link" aria-label="Direct link to Some flow diagrams" title="Direct link to Some flow diagrams">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="a-full-oauth-flow">A full oauth flow<a href="#a-full-oauth-flow" class="hash-link" aria-label="Direct link to A full oauth flow" title="Direct link to A full oauth flow">​</a></h3>
</div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/mozilla/ecosystem-platform/edit/master/docs/relying-parties/tutorials/integrating-with-fxa.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/ecosystem-platform/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Introduction</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/ecosystem-platform/relying-parties/tutorials/integration-with-subscription-platform"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Integration with Subscription Platform</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#pre-development" class="table-of-contents__link toc-highlight">Pre-Development</a></li><li><a href="#openid-connect-integration" class="table-of-contents__link toc-highlight">OpenID Connect Integration</a><ul><li><a href="#relying-party-vs-resource-server" class="table-of-contents__link toc-highlight">Relying Party vs. Resource Server</a></li><li><a href="#development" class="table-of-contents__link toc-highlight">Development</a></li><li><a href="#preparing-for-production" class="table-of-contents__link toc-highlight">Preparing for Production</a></li><li><a href="#user-authentication-with-openid-connect-in-a-nutshell" class="table-of-contents__link toc-highlight">User Authentication with OpenID Connect in a nutshell</a></li><li><a href="#oauth-credentials" class="table-of-contents__link toc-highlight">OAuth Credentials</a></li><li><a href="#profile-data" class="table-of-contents__link toc-highlight">Profile Data</a></li><li><a href="#authorization-query-parameters" class="table-of-contents__link toc-highlight">/authorization query parameters</a></li><li><a href="#scopes" class="table-of-contents__link toc-highlight">Scopes</a></li><li><a href="#webhook-events" class="table-of-contents__link toc-highlight">Webhook Events</a></li><li><a href="#register-for-webhooks" class="table-of-contents__link toc-highlight">Register for webhooks</a></li></ul></li><li><a href="#some-flow-diagrams" class="table-of-contents__link toc-highlight">Some flow diagrams</a><ul><li><a href="#a-full-oauth-flow" class="table-of-contents__link toc-highlight">A full oauth flow</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Mozilla Corporation.</div></div></div></footer></div>
</body>
</html>