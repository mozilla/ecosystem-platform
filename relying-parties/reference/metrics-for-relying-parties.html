<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-relying-parties/reference/metrics-for-relying-parties" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">Metrics for Relying Parties | Firefox Ecosystem Platform</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://mozilla.github.io/ecosystem-platform/relying-parties/reference/metrics-for-relying-parties"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Metrics for Relying Parties | Firefox Ecosystem Platform"><meta data-rh="true" name="description" content="Last updated: March 24th, 2023"><meta data-rh="true" property="og:description" content="Last updated: March 24th, 2023"><link data-rh="true" rel="icon" href="/ecosystem-platform/img/firefox-logo.png"><link data-rh="true" rel="canonical" href="https://mozilla.github.io/ecosystem-platform/relying-parties/reference/metrics-for-relying-parties"><link data-rh="true" rel="alternate" href="https://mozilla.github.io/ecosystem-platform/relying-parties/reference/metrics-for-relying-parties" hreflang="en"><link data-rh="true" rel="alternate" href="https://mozilla.github.io/ecosystem-platform/relying-parties/reference/metrics-for-relying-parties" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://RFM5H13DFK-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Firefox Ecosystem Platform" href="/ecosystem-platform/opensearch.xml"><link rel="stylesheet" href="/ecosystem-platform/assets/css/styles.e5583d03.css">
<script src="/ecosystem-platform/assets/js/runtime~main.47963293.js" defer="defer"></script>
<script src="/ecosystem-platform/assets/js/main.c2a56957.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/ecosystem-platform/"><div class="navbar__logo"><img src="/ecosystem-platform/img/firefox-logo.png" alt="Ecosystem Platform Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/ecosystem-platform/img/firefox-logo.png" alt="Ecosystem Platform Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Firefox Ecosystem Platform</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/mozilla/ecosystem-platform" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ecosystem-platform/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active">For Relying Parties</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/relying-parties/tutorials/integration-with-fxa">Tutorials</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/relying-parties/how-tos/end-to-end-encryption">How-to Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/ecosystem-platform/relying-parties/reference/integration-requirements">Reference</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/relying-parties/reference/integration-requirements">Integration Requirements</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/ecosystem-platform/relying-parties/reference/metrics-for-relying-parties">Metrics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/relying-parties/reference/query-parameters">Query Parameters</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/relying-parties/reference/sub-plat-overview">Subscription Platform Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/relying-parties/reference/sub-plat-features">Subscription Features</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/relying-parties/reference/sub-plat-contentful">Subscription Platform - Contentful</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/relying-parties/reference/sub-plat-coupons">Subscription Coupons</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/relying-parties/reference/using-apis">Using APIs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/api">⚙️ API Reference</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/gql-api">⚙️ GQL API Reference</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">For FxA Engineers</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/tutorials/development-setup">Tutorials</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/how-tos/ci-guidelines">How-to Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/reference/team-processes/development-process">Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/explanation/architectural-decision-records">Explanation</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/additional-docs">Additional Docs</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">For Support Agents</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/reference/admin-panel">Reference</a></div></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/ecosystem-platform/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">For Relying Parties</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Reference</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Metrics</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Metrics for Relying Parties</h1></header><p>Last updated: <code>March 24th, 2023</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="subscriptions-services-data-sources">Subscriptions Services Data Sources<a href="#subscriptions-services-data-sources" class="hash-link" aria-label="Direct link to Subscriptions Services Data Sources" title="Direct link to Subscriptions Services Data Sources">​</a></h2>
<p>Subscription Platform provides product metrics in BigQuery by obtaining subscriptions data from the following sources: Stripe, mobile app store providers, and FxA logs.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="stripe">Stripe<a href="#stripe" class="hash-link" aria-label="Direct link to Stripe" title="Direct link to Stripe">​</a></h3>
<p>The bulk of Subscriptions Services data comes from Stripe and is synced to BigQuery using Fivetran and its <a href="https://fivetran.com/docs/applications/stripe" target="_blank" rel="noopener noreferrer">Stripe connector</a>. This data reflects the current subscription state of all active subscriptions paid for via Stripe or PayPal. It also includes information regarding subscriptions and customers, as well as products, plans, invoices, cards, charges, discounts, coupons, and promotion codes.</p>
<p>Some of the customer information includes the customer&#x27;s postal code, state, and country for a subscription, which helps resolve issues for customers across a particular dimension (e.g., country, payment provider, etc.). However, as it intentionally excludes any personal identifiable information of customers (e.g., name, street address, phone number, email address), it can be challenging to use to help on an individual customer level. Other uses for this data is for retrieving all-time counts (e.g., total number of active subscriptions).</p>
<p>Fivetran preserves historical data within <code>subscription_history</code> by comparing the current state of the subscription with the most recent record in the history table and adding a new record if they vary. However, there are limitations with the Fivetran Stripe sync, as it only records historical state/changes for top-level subscription fields and not the associated subscription items which indicate the subscribed plan. As we have to rely on the subscription metadata fields <code>previous_plan_id</code> and <code>plan_change_date</code>, which only records the most recent plan change, we can potentially miss/lose history if there are any problems with the Fivetran sync.</p>
<p>The Stripe Firestore DB was set up in October 2021. As of February 2023, Subscription Platform also syncs Stripe Firestore Customer and Subscriptions collections in BigQuery, including the latest data and changelogs.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mobile-app-store-providers">Mobile app store providers<a href="#mobile-app-store-providers" class="hash-link" aria-label="Direct link to Mobile app store providers" title="Direct link to Mobile app store providers">​</a></h3>
<p>Subscriptions Services data is also obtained from two mobile app store providers: Apple and Google. This includes current and historical IAP subscription states, as well as information, such as date of billing and expired dates, subscription change event, etc. Apple provides limited data - it does not provide the country, price, or currency of subscriptions.</p>
<p>As of December 2022, Subscription Platform supports <a href="/ecosystem-platform/tutorials/subscription-platform#apple-iap-integration">Apple IAP</a> subscriptions, and stores current subscription state from that point forward in the Firestore database and synced in BigQuery.</p>
<p>Similar to Apple, Subscription Platform also handles the current state of Google IAP subscriptions, which are also stored in Firestore and synced in BigQuery.</p>
<p>These collections of IAP subscriptions synced in BigQuery each have changelogs that also get synced into a BigQuery table. These changelogs contain the historical state for IAP subscriptions - there is a BigQuery view for each that represents the current state of the collection calculated based on the latest changelog for each document. Since the historical state and changes are only recorded by the BigQuery sync itself, there are only records of the changes that occurred after the BigQuery syncs were set up.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><ul>
<li>Google IAP sync started 2021-10-18</li>
<li>Apple IAP sync started 2022-12-15</li>
</ul></div></div>
<p>The general use of this data is to understand what the subscription state was over time, as well as sequences of events.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="fxa-logs">FxA logs<a href="#fxa-logs" class="hash-link" aria-label="Direct link to FxA logs" title="Direct link to FxA logs">​</a></h3>
<p>FxA logs include account and subscription management event data that can help provide insights regarding the customers&#x27; journey through the FxA sign-in/sign-up process. It can also help identify potential drivers (e.g., call-to-action, medium, paid search term, etc.) that directed customers to a page for acquisition and attribution purposes, if query parameters are set up properly (see below for more information).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="relying-party-hosted-email-form">Relying-Party Hosted Email Form<a href="#relying-party-hosted-email-form" class="hash-link" aria-label="Direct link to Relying-Party Hosted Email Form" title="Direct link to Relying-Party Hosted Email Form">​</a></h2>
<p>Reliers must do either one of the following when integrating with Mozilla accounts:
0. Self-host the first step in the FxA authentication flow themselves (e.g. the form capturing the user&#x27;s email)
0. Send users to a FxA-hosted form at <a href="https://accounts.firefox.com/" target="_blank" rel="noopener noreferrer">https://accounts.firefox.com/</a>.</p>
<p>In the first case, when the email entry form is hosted by the relying party, the relying party must:</p>
<ol start="0">
<li>When the page that hosts the FxA form loads, have it make an XHR call to <code>https://accounts.firefox.com/metrics-flow</code>. The domain name of the request should match the FxA page that is being redirected to (e.g. <a href="https://accounts.firefox.com" target="_blank" rel="noopener noreferrer">https://accounts.firefox.com</a>). You can use <code>fetch</code> to get this info.</li>
<li>Include the following query parameters in the above request (see chart below for descriptions):</li>
</ol>
<ul>
<li><code>entrypoint</code></li>
<li><code>entrypoint_experiment</code></li>
<li><code>entrypoint_variation</code></li>
<li><code>utm_source</code></li>
<li><code>utm_campaign</code></li>
<li><code>form_type</code></li>
<li>An example: <code>https://accounts.firefox.com/metrics-flow?entrypoint=my_page&amp;utm_source=my_referrer&amp;utm_campaign=my_campaign&amp;form_type=email</code></li>
</ul>
<ol start="0">
<li>The response from <code>metrics-flow</code> will be a JSON object that contains the fields <code>flowId</code> and <code>flowBeginTime</code>. These values will need to be propagated to FxA as query parameters, which can be done using hidden form fields with the names <code>flow_id</code> and <code>flow_begin_time</code>. You can see an example of how the <a href="about:welcome" target="_blank" rel="noopener noreferrer">about<!-- -->:welcome</a> page does this by looking <a href="https://github.com/mozilla/activity-stream/blob/06aeeb331e9dd497e4d115d0e6cba51b9b25b36c/content-src/asrouter/templates/StartupOverlay/StartupOverlay.jsx#L30" target="_blank" rel="noopener noreferrer">here</a>.</li>
</ol>
<p>Following these instructions will provide FxA and the relying party with the data needed to ensure a healthy user flow.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="relying-party-engage-events">Relying-Party &quot;Engage&quot; Events<a href="#relying-party-engage-events" class="hash-link" aria-label="Direct link to Relying-Party &quot;Engage&quot; Events" title="Direct link to Relying-Party &quot;Engage&quot; Events">​</a></h2>
<p><em>Note: this is a limited, temporary solution for cross-product metrics that is due to be replaced in early 2020. Please contact the FxA team if you think you need access.</em></p>
<p>The metrics that the Mozilla accounts platform sends to Amplitude reflect mainly direct interactions with FxA. These are mostly authentication events (registering, logging in, etc) or events related to account management (e.g. changes to a user’s account settings). This means that interaction events within “relying” products of FxA (such as Firefox Monitor) that do not involve authentication are not logged to the FxA amplitude metrics system. To address this shortcoming, FxA-relying products can log metrics about product usage directly via the FxA metrics system. FxA has not previously allowed for the direct logging of these types of metrics by relying products, but we feel that this change is necessary to ensure that company-level metrics accurately reflect product usage.</p>
<p>Only one event is allowed per RP, and the required query parameters are different from other requests:</p>
<ol start="0">
<li>When the event of interest occurs, the RP server (not the user&#x27;s browser) should submit a GET request to <code>https://accounts.firefox.com/metrics-flow</code> with the <code>Origin</code> header set to the RP&#x27;s registered FxA OAuth domain.</li>
<li>Include the following query parameters in the request:</li>
</ol>
<ul>
<li><code>event_type</code> - the static string “engage” - this ping tells us that a user engaged with a service in some way that we’ve defined out of band</li>
<li><code>service</code> - the oauth client identifier for the RP, this is an opaque 8-byte hex string that isn’t private</li>
<li><code>uid</code> - the Mozilla accounts user id - this is an opaque hex string that identifies the user across all FxA relying parties. Here, it’s the user who has engaged with the service in some way. (In the future, we plan to replace this with an anonymous / pseudonymous identifier supplied by ecosystem telemetry)</li>
</ul>
<p>Note that the RP&#x27;s domain needs to be manually  added to the FxA <code>allowed_metrics_flow_origins</code> list before these events will be accepted. Otherwise, they will be silently dropped.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="metrics-related-query-parameters">Metrics-Related Query Parameters<a href="#metrics-related-query-parameters" class="hash-link" aria-label="Direct link to Metrics-Related Query Parameters" title="Direct link to Metrics-Related Query Parameters">​</a></h2>
<p>The values that are passed in the parameters below are subject to validation via regular expressions. <strong>If the parameter values do not conform to their associated regexes in <a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-content-server/server/lib/flow-event.js" target="_blank" rel="noopener noreferrer">this file</a> then all metrics events associated with the non-conforming parameters will not be logged!</strong></p>
<table><thead><tr><th>Name</th><th>Description</th><th>Example Values</th><th>Validation regex</th><th>Amplitude Chart Example</th></tr></thead><tbody><tr><td><code>entrypoint</code></td><td>The specific page or browser UI element containing the first step of the FxA sign-in/sign-up process (e.g., enter email form)</td><td><code>firstrun</code></td><td>^[\w.:-]+$</td><td><a href="https://analytics.amplitude.com/mozilla-corp/chart/n8cd9no" target="_blank" rel="noopener noreferrer">Firstrun form views</a></td></tr><tr><td><code>entrypoint_experiment</code></td><td>Identifier for the experiment the user is part of (if any)</td><td></td><td>^[\w.:-]+$</td><td></td></tr><tr><td><code>entrypoint_variation</code></td><td>Identifier for the experiment variation the user is part of (if any)</td><td></td><td>^[\w.:-]+$</td><td></td></tr><tr><td><code>form_type</code></td><td>For self-hosted forms only (see above) the type of form that the user submits to begin the FxA flow</td><td>either: <code>email</code> if the form captures the user&#x27;s email, otherwise <code>other</code></td><td></td><td>NA</td></tr><tr><td><code>utm_source</code></td><td>Unambiguous identifier of site or browser UI element that linked to the page containing the beginning of the FxA sign-in/sign-up process</td><td><code>blog.mozilla.org</code></td><td>^[\w/.%-]+$</td><td><a href="https://analytics.amplitude.com/mozilla-corp/chart/f5sz7kt" target="_blank" rel="noopener noreferrer">Registration form views segmented by utm_source</a></td></tr><tr><td><code>utm_campaign</code></td><td>More general label for the campaign that the site is part of</td><td><code>firstrun</code></td><td>^[\w/.%-]+$</td><td>TBD</td></tr><tr><td><code>utm_content</code></td><td>Used to track the name of an A-B test</td><td><code>my-experiment</code></td><td>^[\w/.%-]+$</td><td>TBD</td></tr><tr><td><code>utm_term</code></td><td>Used to track the cohort or variation in an A-B test</td><td><code>my-experiment-var-a</code></td><td>^[\w/.%-]+$</td><td>TBD</td></tr><tr><td><code>utm_medium</code></td><td>What type of link was used to direct to the page, if it came through a marketing campaign</td><td><code>email</code>, <code>cpc</code></td><td>^[\w/.%-]+$</td><td>TBD</td></tr><tr><td><code>context</code></td><td>Not relevant to metrics, but this is <strong>required</strong> to be set to one of <code>fx_desktop_v3</code>, <code>fx_fennec_v1</code> or <code>fx_ios_v1</code> if <code>service=sync</code>. Please use the value that reflects the most likely operating system of the user.</td><td><code>fx_desktop_v3</code>, <code>fx_fennec_v1</code>, <code>fx_ios_v1</code></td><td>^[0-9a-z_-]+$/</td><td>NA</td></tr></tbody></table>
<p><strong>Note these may not be all the parameters you need to pass for your integration to work!</strong> A more exhaustive but <a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-content-server/docs/query-params.md" target="_blank" rel="noopener noreferrer">less detailed list can be found here.</a> What is documented above are only the parameters that are relevant for metrics analysis in (e.g.) amplitude.</p>
<p>Other Notes:</p>
<ul>
<li>
<p>You must have access to the mozilla amplitude account to see the example charts. If you are a Mozilla employee, please contact Leif for information on gaining access to amplitude.</p>
</li>
<li>
<p>Regarding <code>utm_term</code>: note that the current usage of this parameter is different from what is typical. In most scenarios, it is used to track the search terms that led the users to the page. If you would like to use the parameter in this way, please inform the Mozilla accounts team.</p>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="user-opt-out">User Opt-out<a href="#user-opt-out" class="hash-link" aria-label="Direct link to User Opt-out" title="Direct link to User Opt-out">​</a></h2>
<p>Users may opt-out of metrics from the FxA settings page. If they do, FxA will not collect or store metrics and relying parties must not either.</p>
<p><a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-profile-server/docs/API.md#get-v1profile" target="_blank" rel="noopener noreferrer">User profiles</a> include the <code>metricsEnabled</code> boolean. When the value is <code>false</code> relying parties should not collect any metrics tied to the user. Relying parties should check this value every time the profile is requested.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/mozilla/ecosystem-platform/edit/master/docs/relying-parties/reference/metrics-for-relying-parties.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/ecosystem-platform/relying-parties/reference/integration-requirements"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Integration Requirements</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/ecosystem-platform/relying-parties/reference/query-parameters"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Query Parameters</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#subscriptions-services-data-sources" class="table-of-contents__link toc-highlight">Subscriptions Services Data Sources</a><ul><li><a href="#stripe" class="table-of-contents__link toc-highlight">Stripe</a></li><li><a href="#mobile-app-store-providers" class="table-of-contents__link toc-highlight">Mobile app store providers</a></li><li><a href="#fxa-logs" class="table-of-contents__link toc-highlight">FxA logs</a></li></ul></li><li><a href="#relying-party-hosted-email-form" class="table-of-contents__link toc-highlight">Relying-Party Hosted Email Form</a></li><li><a href="#relying-party-engage-events" class="table-of-contents__link toc-highlight">Relying-Party &quot;Engage&quot; Events</a></li><li><a href="#metrics-related-query-parameters" class="table-of-contents__link toc-highlight">Metrics-Related Query Parameters</a></li><li><a href="#user-opt-out" class="table-of-contents__link toc-highlight">User Opt-out</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Mozilla Corporation.</div></div></div></footer></div>
</body>
</html>