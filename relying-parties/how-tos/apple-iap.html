<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-relying-parties/how-tos/apple-iap">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Apple IAP | Firefox Ecosystem Platform</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://mozilla.github.io/ecosystem-platform/relying-parties/how-tos/apple-iap"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Apple IAP | Firefox Ecosystem Platform"><meta data-rh="true" name="description" content="Introduction"><meta data-rh="true" property="og:description" content="Introduction"><link data-rh="true" rel="icon" href="/ecosystem-platform/img/firefox-logo.png"><link data-rh="true" rel="canonical" href="https://mozilla.github.io/ecosystem-platform/relying-parties/how-tos/apple-iap"><link data-rh="true" rel="alternate" href="https://mozilla.github.io/ecosystem-platform/relying-parties/how-tos/apple-iap" hreflang="en"><link data-rh="true" rel="alternate" href="https://mozilla.github.io/ecosystem-platform/relying-parties/how-tos/apple-iap" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://RFM5H13DFK-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Firefox Ecosystem Platform" href="/ecosystem-platform/opensearch.xml"><link rel="stylesheet" href="/ecosystem-platform/assets/css/styles.b2e9ba6a.css">
<link rel="preload" href="/ecosystem-platform/assets/js/runtime~main.e3f2b7fb.js" as="script">
<link rel="preload" href="/ecosystem-platform/assets/js/main.ae38e5d7.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(e){}return e}()||function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/ecosystem-platform/"><div class="navbar__logo"><img src="/ecosystem-platform/img/firefox-logo.png" alt="Ecosystem Platform Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/ecosystem-platform/img/firefox-logo.png" alt="Ecosystem Platform Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Firefox Ecosystem Platform</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/mozilla/ecosystem-platform" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ecosystem-platform/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active">For Relying Parties</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/relying-parties/tutorials/integration-with-fxa">Tutorials</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/ecosystem-platform/relying-parties/how-tos/end-to-end-encryption">How-to Guides</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/relying-parties/how-tos/end-to-end-encryption">End-to-end Encryption</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/relying-parties/how-tos/google-iap">Google IAP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/ecosystem-platform/relying-parties/how-tos/apple-iap">Apple IAP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/relying-parties/how-tos/product-metrics">Product metrics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/relying-parties/how-tos/device-registration">Device Registration (Sync)</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/relying-parties/reference/integration-requirements">Reference</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">For FxA Engineers</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/tutorials/development-setup">Tutorials</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/how-tos/ci-guidelines">How-to Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/reference/team-processes/development-process">Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/explanation/architectural-decision-records">Explanation</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/additional-docs">Additional Docs</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">For Support Agents</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/ecosystem-platform/reference/admin-panel">Reference</a></div></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/ecosystem-platform/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">For Relying Parties</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">How-to Guides</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Apple IAP</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Apple IAP</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2><p>As of December 2022, the Subscription Platform supports <a href="https://developer.apple.com/app-store/subscriptions/" target="_blank" rel="noopener noreferrer">Apple IAP</a> integrations for products with Mozilla VPN as one example. An integration allows us to maintain an awareness of an Apple IAP subscriber&#x27;s subscription status for a given iOS app, including any state changes, which we forward on to the relevant relying party.</p><p>Importantly, Apple provides read-only access to Apple IAP subscriptions. Consequently, we do not (and cannot) modify Apple IAP subscriptions (e.g. making plan changes such as upgrades).</p><p>A more technical discussion (geared toward FxA engineers) can be found in <a href="/ecosystem-platform/tutorials/subscription-platform#apple-iap-integration">Apple IAP Integration</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a href="#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h2><p>This guide assumes you are already integrated with FxA/the Subscription Platform; please see <a href="/ecosystem-platform/relying-parties/tutorials/integration-with-subscription-platform">Integration with Subscription Platform</a> for more information.</p><p>Ideally, you will also want to grant 1-2 Subscription Platform engineers working on the integration developer access to your iOS app in <a href="https://appstoreconnect.apple.com/" target="_blank" rel="noopener noreferrer">App Store Connect</a> (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1760053" target="_blank" rel="noopener noreferrer">example bug</a>). This allows us to access your iOS app’s <a href="https://developer.apple.com/documentation/appstoreserverapi" target="_blank" rel="noopener noreferrer">App Store Server API</a> keys, to look up needed app-specific information and to configure an endpoint to receive App Store Server notifications.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="configuration">Configuration<a href="#configuration" class="hash-link" aria-label="Direct link to Configuration" title="Direct link to Configuration">​</a></h2><p>These steps can be done by a product manager or developer and in parallel with steps in <a href="#subplat-api-calls">SubPlat API Calls</a>. More information regarding specific Stripe metadata keys mentioned below can be found in the <a href="/ecosystem-platform/tutorials/subscription-platform#stripe-productplans">Subscription Platform integration tutorial</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-an-iap-configuration-document">Create an IAP configuration document<a href="#create-an-iap-configuration-document" class="hash-link" aria-label="Direct link to Create an IAP configuration document" title="Direct link to Create an IAP configuration document">​</a></h3><p>This document represents a list of App Store plans (identified uniquely by their App Store <a href="https://developer.apple.com/documentation/appstoreserverapi/productid/" target="_blank" rel="noopener noreferrer"><code>productId</code>s</a> for your product.</p><ol><li>Go into App Store Connect and find your iOS app’s human-readable <a href="https://developer.apple.com/documentation/appstoreserverapi/productid/" target="_blank" rel="noopener noreferrer"><code>productId</code></a>s and <a href="https://developer.apple.com/documentation/appstoreserverapi/bundleid/" target="_blank" rel="noopener noreferrer"><code>bundleId</code></a>.</li><li>Create a configuration document similar in form to <a href="https://api.accounts.firefox.com/v1/oauth/subscriptions/iap/plans/guardian-vpn" target="_blank" rel="noopener noreferrer">https://api.accounts.firefox.com/v1/oauth/subscriptions/iap/plans/guardian-vpn</a> (omitting Android plans) including a <code>bundleId</code> property. This can be in a Google document for now.<ul><li>Note: The only information SubPlat uses from the VPN document currently is the <code>productId</code> and <code>platform</code>. The VPN configuration document is structured in this way for historical reasons. We may change how this information is structured for future integrations.</li></ul></li><li>File a ticket in the <a href="https://mozilla-hub.atlassian.net/browse/FXA" target="_blank" rel="noopener noreferrer">FXA Jira project</a> to create a new document in SubPlat&#x27;s &quot;IAP config&quot; Firestore collection, and provide the document from Step 2 along with an <code>appName</code>.<ul><li><code>appName</code> is a human-readable name that SubPlat uses to uniquely identify your app in our system (e.g. <code>&quot;guardian-vpn&quot;</code> is the <code>appName</code> for the Mozilla VPN in the link above).
When the ticket is complete and deployed, you should be able to view your configuration at <a href="https://api.accounts.firefox.com/v1/oauth/subscriptions/iap/plans/$%7BappName%7D" target="_blank" rel="noopener noreferrer">https://api.accounts.firefox.com/v1/oauth/subscriptions/iap/plans/${appName}</a>.</li></ul></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="add-app-store-server-api-keys-in-subplat">Add App Store Server API keys in SubPlat<a href="#add-app-store-server-api-keys-in-subplat" class="hash-link" aria-label="Direct link to Add App Store Server API keys in SubPlat" title="Direct link to Add App Store Server API keys in SubPlat">​</a></h3><p>A SubPlat engineer with developer access to App Store Connect (see <a href="#prerequisites">Prerequisites</a>) can configure this for you when ready.</p><p>App Store Server API keys are needed for SubPlat to make calls to Apple’s API. See <a href="/ecosystem-platform/tutorials/subscription-platform#apple-iap-integration">Apple IAP Integration</a> for more information on how to obtain these keys.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="send-app-store-server-notifications-to-subplat">Send App Store Server notifications to SubPlat<a href="#send-app-store-server-notifications-to-subplat" class="hash-link" aria-label="Direct link to Send App Store Server notifications to SubPlat" title="Direct link to Send App Store Server notifications to SubPlat">​</a></h3><p>A SubPlat engineer with developer access to App Store Connect (see <a href="#prerequisites">Prerequisites</a>) can configure this for you when ready.</p><p>The Sandbox and, when ready, Production endpoints in App Store Connect must be updated with SubPlat&#x27;s notification endpoint in order for our system to receive App Store Server notifications.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="map-apple-iap-to-stripe-plans">Map Apple IAP to Stripe plans<a href="#map-apple-iap-to-stripe-plans" class="hash-link" aria-label="Direct link to Map Apple IAP to Stripe plans" title="Direct link to Map Apple IAP to Stripe plans">​</a></h3><p>In order to know what capabilities to grant a given Apple IAP user, we map App Store Connect <code>productId</code>s to <a href="https://support.stripe.com/questions/how-to-create-products-and-prices" target="_blank" rel="noopener noreferrer">Stripe <code>price</code> or <code>plan</code></a> IDs (<code>price</code>s supersede <code>plan</code>s).</p><ol><li>Go into App Store Connect and find your iOS app’s human-readable <code>productId</code>s.</li><li>In the Stripe dashboard for the desired environment (stage or production), create a new, valid product in Stripe and a new, valid plan underneath that product.<ul><li>We hope to simplify this process in SubPlat 3.0, expected in 2023; see this <a href="https://mozilla-hub.atlassian.net/browse/PSP-64?focusedCommentId=627245" target="_blank" rel="noopener noreferrer">Jira comment</a> for more details.</li></ul></li><li>Add each App Store <code>productId</code> as a comma-separated value to a new <code>appStoreProductIds</code> metadata property on the newly created plan.</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="prevent-apple-iap-subscribers-from-double-subscribing">Prevent Apple IAP subscribers from double subscribing<a href="#prevent-apple-iap-subscribers-from-double-subscribing" class="hash-link" aria-label="Direct link to Prevent Apple IAP subscribers from double subscribing" title="Direct link to Prevent Apple IAP subscribers from double subscribing">​</a></h3><p>As noted previously, we don’t support upgrades or any plan changes for Apple IAP subscribers. However, it is possible for an Apple IAP subscriber to try to sign up again for your product on the Subscription Platform website. Follow these steps to prevent them from double subscribing.</p><ol><li>In the Stripe dashboard for the given environment (stage or production), remove any <code>productSet</code> properties that may have been previously set on the newly created product/plan from <a href="#map-apple-iap-to-stripe-plans">Map Apple IAP to Stripe plans</a>.</li><li>Add a <code>productSet</code> metadata key with a value equal to the comma-separated list of all the unique <code>productSet</code>s for all your product’s plans in the environment to the new product referenced in Step 1. Without their own <code>productSet</code> specified, the new plan will inherit its product’s <code>productSet</code>.</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="subplat-api-calls">SubPlat API Calls<a href="#subplat-api-calls" class="hash-link" aria-label="Direct link to SubPlat API Calls" title="Direct link to SubPlat API Calls">​</a></h2><p>These steps can be done by a developer and in parallel with the steps in <a href="#configuration">Configuration</a>.</p><p>As mentioned in the <a href="#introduction">Introduction</a>, SubPlat has read-only access to App Store subscription information. We will store Apple IAP subscribers&#x27; data in our system and update the information when we receive notifications from the App Store server, broadcasting updates in real time to the relevant relying parties.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="getting-the-current-subscription-status-for-an-fxa-user">Getting the current subscription status for an FxA user<a href="#getting-the-current-subscription-status-for-an-fxa-user" class="hash-link" aria-label="Direct link to Getting the current subscription status for an FxA user" title="Direct link to Getting the current subscription status for an FxA user">​</a></h3><p>Assuming you are already integrated with FxA generally (see <a href="#prerequisites">Prerequisites</a>), are receiving subscription updates for other types of subscriptions (e.g. for PayPal or Stripe), and you have completed the <a href="#map-apple-iap-to-stripe-plans">mapping of App Store to Stripe plans</a>, no further work is required to continue receiving these updates for Apple IAP subscribers. You can also pull this information from FxA with the existing <a href="/ecosystem-platform/api#tag/Account/operation/getAccountProfile"><code>/account/profile</code></a> endpoint without any further changes. </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="registering-an-apple-iap-subscriber">Registering an Apple IAP subscriber<a href="#registering-an-apple-iap-subscriber" class="hash-link" aria-label="Direct link to Registering an Apple IAP subscriber" title="Direct link to Registering an Apple IAP subscriber">​</a></h3><p>SubPlat needs to be able to associate an Apple IAP subscription in Apple&#x27;s system to a specific FxA user. This is done by registering each Apple IAP subscriber with the <a href="/ecosystem-platform/api#tag/Subscriptions/operation/postOauthSubscriptionsIapAppstoretransactionAppname"><code>/subscriptions/iap/app-store-transaction/${appName}</code></a> endpoint.</p><p>By design, we allow only one FxA user per App Store <a href="https://developer.apple.com/documentation/appstoreserverapi/originaltransactionid/" target="_blank" rel="noopener noreferrer"><code>originalTransactionId</code></a>, which is how Apple uniquely identifies a subscription.</p><p>This endpoint can be used to register a new Apple IAP subscriber or to migrate an existing Apple IAP subscriber. For the latter, see <a href="#optional-migrating-existing-apple-iap-subscribers-to-the-subscription-platform">(Optional) Migrate existing Apple IAP subscribers to the Subscription Platform</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="optional-migrating-existing-apple-iap-subscribers-to-the-subscription-platform">(Optional) Migrating existing Apple IAP subscribers to the Subscription Platform<a href="#optional-migrating-existing-apple-iap-subscribers-to-the-subscription-platform" class="hash-link" aria-label="Direct link to (Optional) Migrating existing Apple IAP subscribers to the Subscription Platform" title="Direct link to (Optional) Migrating existing Apple IAP subscribers to the Subscription Platform">​</a></h3><p>This section only applies to products that currently have a direct integration with Apple who need to migrate existing subscribers to the Subscription Platform.</p><p>These steps can be done by a developer. While step 1 can be completed in parallel, otherwise perform this migration after completing the steps under <a href="#configuration">Configuration</a> and <a href="#subplat-api-calls">SubPlat API Calls</a>. See also the <a href="#testing-your-integration">Testing your integration</a> section.</p><ol><li>File a ticket in the <a href="https://mozilla-hub.atlassian.net/browse/FXA" target="_blank" rel="noopener noreferrer">FXA Jira project</a> to add a temporary scope for <code>&#x27;profile:subscriptions&#x27;</code> to the App Store registration endpoint.<ul><li>Example ticket to add <a href="https://mozilla-hub.atlassian.net/browse/FXA-5833" target="_blank" rel="noopener noreferrer">FXA-5833</a> and remove <a href="https://mozilla-hub.atlassian.net/browse/FXA-5848" target="_blank" rel="noopener noreferrer">FXA-5848</a>.</li></ul></li><li>Use the existing registration endpoint (<a href="/ecosystem-platform/api#tag/Subscriptions/operation/postOauthSubscriptionsIapAppstoretransactionAppname"><code>/subscriptions/iap/app-store-transaction/${appName}</code></a>) to register each existing user with SubPlat.<ul><li>Important: While SubPlat routes can handle thousands of requests per second, we recommend limiting requests to 10-20 per minute to start and potentially increase that if there are no issues. This is because, at the time of writing, the App Store Server APIs docs don’t list a rate limit threshold, and we make more than one request to Apple for each SubPlat request.</li></ul></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="testing-your-integration">Testing your integration<a href="#testing-your-integration" class="hash-link" aria-label="Direct link to Testing your integration" title="Direct link to Testing your integration">​</a></h2><div class="theme-admonition theme-admonition-warning alert alert--danger admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_S0QG"><p>Like many systems, Apple&#x27;s Sandbox environment does not necessarily exhibit behavior consistent with what is stated in their docs. When in doubt, directly test the scenario in question, potentially more than once, to understand what to expect.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="end-to-end-testing-of-subplat-apis">End-to-end testing of SubPlat APIs<a href="#end-to-end-testing-of-subplat-apis" class="hash-link" aria-label="Direct link to End-to-end testing of SubPlat APIs" title="Direct link to End-to-end testing of SubPlat APIs">​</a></h3><p>After development and the steps above are complete (and importantly, before involving QA), it is recommended for the lead RP integration engineer to pair with the lead SubPlat integration engineer to test the following:</p><ul><li><a href="#getting-the-current-subscription-status-for-an-fxa-user">Getting the current subscription status for an FxA user</a></li><li><a href="#registering-an-apple-iap-subscriber">Registering an Apple IAP subscriber</a></li><li><a href="#send-app-store-server-notifications-to-subplat">Receiving a Sandbox notification in our stage environment</a></li><li><a href="#optional-migrating-existing-apple-iap-subscribers-to-the-subscription-platform">(Optional) Migrating existing Apple IAP subscribers to the Subscription Platform</a></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="idiosyncrasies-of-the-app-store-server-api">Idiosyncrasies of the App Store Server API<a href="#idiosyncrasies-of-the-app-store-server-api" class="hash-link" aria-label="Direct link to Idiosyncrasies of the App Store Server API" title="Direct link to Idiosyncrasies of the App Store Server API">​</a></h3><ul><li>The unique subscription identifier used by Apple (<a href="https://developer.apple.com/documentation/appstoreserverapi/originaltransactionid/" target="_blank" rel="noopener noreferrer">original transaction ID</a>) is per App Store account. When testing with different FxA accounts, it is therefore necessary to either:<ul><li>(Recommended) Use a separate Sandbox App Store account for each FxA account.</li><li><a href="https://mozilla-hub.atlassian.net/browse/PSP-509?focusedCommentId=592265" target="_blank" rel="noopener noreferrer">Clear the Sandbox App Store account&#x27;s purchase history</a> in App Store Connect in between test cases.</li></ul></li><li>Unlike in Production where Apple retries notifications several times over a period of days, in the Sandbox environment, Apple <a href="https://developer.apple.com/documentation/appstoreservernotifications/responding_to_app_store_server_notifications" target="_blank" rel="noopener noreferrer">only sends each notification once with no retries</a>.</li><li>In the Sandbox environment, <a href="https://help.apple.com/app-store-connect/#/dev7e89e149d" target="_blank" rel="noopener noreferrer">subscriptions autorenew at an accelerated rate and auto-expire after 12 renewals</a> if no action is taken otherwise.</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/mozilla/ecosystem-platform/edit/master/docs/relying-parties/how-tos/apple-iap.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/ecosystem-platform/relying-parties/how-tos/google-iap"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Google IAP</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/ecosystem-platform/relying-parties/how-tos/product-metrics"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Product metrics</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#prerequisites" class="table-of-contents__link toc-highlight">Prerequisites</a></li><li><a href="#configuration" class="table-of-contents__link toc-highlight">Configuration</a><ul><li><a href="#create-an-iap-configuration-document" class="table-of-contents__link toc-highlight">Create an IAP configuration document</a></li><li><a href="#add-app-store-server-api-keys-in-subplat" class="table-of-contents__link toc-highlight">Add App Store Server API keys in SubPlat</a></li><li><a href="#send-app-store-server-notifications-to-subplat" class="table-of-contents__link toc-highlight">Send App Store Server notifications to SubPlat</a></li><li><a href="#map-apple-iap-to-stripe-plans" class="table-of-contents__link toc-highlight">Map Apple IAP to Stripe plans</a></li><li><a href="#prevent-apple-iap-subscribers-from-double-subscribing" class="table-of-contents__link toc-highlight">Prevent Apple IAP subscribers from double subscribing</a></li></ul></li><li><a href="#subplat-api-calls" class="table-of-contents__link toc-highlight">SubPlat API Calls</a><ul><li><a href="#getting-the-current-subscription-status-for-an-fxa-user" class="table-of-contents__link toc-highlight">Getting the current subscription status for an FxA user</a></li><li><a href="#registering-an-apple-iap-subscriber" class="table-of-contents__link toc-highlight">Registering an Apple IAP subscriber</a></li><li><a href="#optional-migrating-existing-apple-iap-subscribers-to-the-subscription-platform" class="table-of-contents__link toc-highlight">(Optional) Migrating existing Apple IAP subscribers to the Subscription Platform</a></li></ul></li><li><a href="#testing-your-integration" class="table-of-contents__link toc-highlight">Testing your integration</a><ul><li><a href="#end-to-end-testing-of-subplat-apis" class="table-of-contents__link toc-highlight">End-to-end testing of SubPlat APIs</a></li><li><a href="#idiosyncrasies-of-the-app-store-server-api" class="table-of-contents__link toc-highlight">Idiosyncrasies of the App Store Server API</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Mozilla Corporation.</div></div></div></footer></div>
<script src="/ecosystem-platform/assets/js/runtime~main.e3f2b7fb.js"></script>
<script src="/ecosystem-platform/assets/js/main.ae38e5d7.js"></script>
</body>
</html>